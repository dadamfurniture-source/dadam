<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vibe Cabinet Agent - v30.5 (ë†’ì´ ì—°ë™)</title>
  <style>
    :root {
      --primary-color: #4a7dff;
      --bg-color: #f4f6f8;
      --card-bg: #ffffff;
      --text-color: #333;
      --border-radius: 12px;
      --danger-color: #ff4d4f;
      --success-color: #00c853;
      --upper-color: #5b8def;
      --lower-color: #f59e0b;
      --tall-color: #10b981;
    }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; padding: 20px; background: var(--bg-color); color: var(--text-color); }
    .app-container { max-width: 1100px; margin: 0 auto; background: var(--card-bg); border-radius: var(--border-radius); box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 30px; min-height: 80vh; }
    h1 { text-align: center; font-size: 24px; margin-bottom: 10px; }
    .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }
    .stepper-indicator { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
    .step-dot { width: 30px; height: 30px; border-radius: 50%; background: #eee; color: #999; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
    .step-dot.active { background: var(--primary-color); color: white; }
    .section-label { font-size: 16px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .badge { background: #eef2ff; color: var(--primary-color); padding: 4px 10px; border-radius: 12px; font-size: 11px; }
    label { font-size: 11px; font-weight: 600; color: #666; margin-bottom: 4px; display: block; }
    input[type="number"], input[type="text"], select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100%; font-size: 13px; outline: none; }
    input:focus, select:focus { border-color: var(--primary-color); }
    .btn-next { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 999px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-next:disabled { background: #ccc; cursor: not-allowed; }
    .btn-back { background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 30px; }
    .category-card { background: #fafafa; border: 2px solid transparent; border-radius: var(--border-radius); height: 100px; position: relative; overflow: hidden; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .category-card:hover { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .category-card.active { border-color: var(--primary-color); background: #f4f8ff; }
    .category-name { font-size: 15px; font-weight: 600; color: #555; transition: transform 0.3s; }
    .category-card.active .category-name { transform: translateY(-15px); color: var(--primary-color); }
    .card-stepper { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: var(--primary-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; transform: translateY(100%); transition: transform 0.3s; }
    .category-card.active .card-stepper { transform: translateY(0); }
    .stepper-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; width: 30px; height: 100%; display: flex; align-items: center; justify-content: center; }
    .stepper-count { color: white; font-weight: bold; font-size: 16px; }
    #detailInputSection { display: none; background: #f9fafb; padding: 24px; border-radius: var(--border-radius); border: 1px solid #eee; margin-top: 20px; }
    .ai-guide-box { background: #fff; border-left: 4px solid var(--primary-color); padding: 12px 16px; border-radius: 4px; margin-bottom: 20px; font-size: 13px; display: flex; align-items: center; gap: 10px; }
    .item-input-card { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .item-body { display: flex; gap: 12px; }
    .input-section { flex: 1; display: flex; flex-direction: column; gap: 12px; }
    .input-row { display: flex; gap: 8px; }
    .input-group { flex: 1; display: flex; flex-direction: column; gap: 4px; }
    .extra-settings { background: #f8f9fa; border: 1px solid #eee; padding: 12px; border-radius: 6px; display: flex; flex-direction: column; gap: 10px; }
    .extra-title { font-size: 12px; font-weight: 700; color: var(--primary-color); }
    .photo-section { width: 90px; flex-shrink: 0; }
    .photo-box { background: #f0f0f0; border: 1px dashed #ccc; border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 10px; min-height: 80px; position: relative; overflow: hidden; }
    .photo-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
    .file-input-hidden { display: none; }
    .btn-delete { background: transparent; color: #999; border: none; font-size: 18px; cursor: pointer; }
    #step2-content { display: none; }
    .bookmark-tabs { display: flex; gap: 4px; border-bottom: 2px solid var(--primary-color); padding-top: 5px; }
    .bookmark-tab { padding: 10px 20px; background: #eef2f6; color: #888; border-radius: 10px 10px 0 0; border: 1px solid #ddd; border-bottom: none; font-size: 13px; font-weight: 600; cursor: pointer; position: relative; top: 2px; }
    .bookmark-tab.active { background: #fff; color: var(--primary-color); border: 2px solid var(--primary-color); border-bottom: 2px solid #fff; z-index: 10; }
    .design-workspace { background: #fff; border: 2px solid var(--primary-color); border-top: none; border-radius: 0 0 12px 12px; padding: 20px; min-height: 500px; }
    .ws-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .ws-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .ws-info-badge { font-size: 13px; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 6px; }
    .ws-layout { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    .spec-panel { background: #f8f9fa; padding: 16px; border-radius: 8px; border: 1px solid #eee; max-height: 700px; overflow-y: auto; }
    .spec-group-title { font-size: 12px; font-weight: 700; color: var(--primary-color); margin: 15px 0 8px; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px; }
    .spec-group-title:first-child { margin-top: 0; }
    .spec-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .spec-field { flex: 1; }
    .color-select-row { display: flex; gap: 4px; }
    .color-select-row select { width: 50%; font-size: 12px; }
    .acc-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 6px; }
    .acc-item { display: flex; gap: 4px; }
    .btn-add-acc { width: 100%; padding: 6px; background: #fff; border: 1px dashed #ccc; color: #666; border-radius: 4px; font-size: 11px; cursor: pointer; }
    .btn-del-acc { color: #ccc; border: 1px solid #eee; background: white; border-radius: 4px; width: 24px; cursor: pointer; }
    .module-panel { display: flex; flex-direction: column; gap: 10px; }
    .module-section { margin-bottom: 16px; }
    .module-section-header { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; padding: 10px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; font-weight: 700; }
    .module-section-header.upper { background: linear-gradient(135deg, #e0ecff 0%, #f0f5ff 100%); color: var(--upper-color); border-left: 4px solid var(--upper-color); }
    .module-section-header.lower { background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%); color: var(--lower-color); border-left: 4px solid var(--lower-color); }
    .section-title-row { display: flex; align-items: center; gap: 8px; flex: 1; }
    .section-info-row { display: flex; align-items: center; gap: 10px; width: 100%; margin-top: 6px; font-size: 11px; }
    .effective-space-group { display: flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.7); padding: 3px 8px; border-radius: 4px; }
    .effective-space-group label { font-size: 10px; color: #666; margin: 0; }
    .effective-space-input { width: 70px; padding: 3px 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 3px; text-align: center; }
    .section-remaining { font-size: 11px; font-weight: 600; background: rgba(255,255,255,0.7); padding: 3px 8px; border-radius: 4px; }
    .section-buttons { display: flex; gap: 4px; margin-left: auto; }
    .btn-section-undo, .btn-section-auto { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; }
    .btn-section-undo { background: #f0f0f0; border: 1px solid #ccc; color: #666; }
    .btn-section-undo:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-section-auto { background: white; border: 1px solid currentColor; }
    .module-list { display: flex; flex-direction: column; gap: 4px; min-height: 80px; padding: 8px; background: #fafafa; border-radius: 6px; border: 2px dashed #ddd; }
    .module-list.empty-list::before { content: '+ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¥ì„ ì¶”ê°€í•˜ì„¸ìš”'; color: #aaa; font-size: 12px; text-align: center; display: block; padding: 20px; }
    .module-card { background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 8px 10px; display: flex; align-items: flex-start; gap: 8px; position: relative; }
    .module-card:hover { border-color: #bbb; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .module-card.tall-type { border-left: 3px solid var(--tall-color); background: linear-gradient(90deg, #ecfdf5 0%, white 20%); }
    .module-card.fixed-module { border-left: 3px solid var(--primary-color); background: linear-gradient(90deg, #e8f4ff 0%, white 20%); }
    .module-card.fixed-module::after { content: 'ê³ ì •'; position: absolute; top: 4px; right: 28px; font-size: 9px; color: var(--primary-color); background: #e8f4ff; padding: 1px 4px; border-radius: 3px; }
    .module-card.base-module { border-left: 3px solid #9333ea; background: linear-gradient(90deg, #f3e8ff 0%, white 20%); }
    .module-card.base-module::after { content: 'ê¸°ì¤€'; position: absolute; top: 4px; right: 28px; font-size: 9px; color: #9333ea; background: #f3e8ff; padding: 1px 4px; border-radius: 3px; }
    .move-buttons { display: flex; flex-direction: column; gap: 2px; }
    .btn-move { width: 24px; height: 20px; border: 1px solid #ddd; background: #f8f8f8; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #666; }
    .btn-move:hover:not(:disabled) { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .btn-move:disabled { opacity: 0.3; cursor: not-allowed; }
    .module-icon { width: 32px; height: 32px; background: #f4f6f8; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; margin-top: 2px; }
    .module-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .module-header { display: flex; align-items: center; gap: 8px; }
    .module-title { font-size: 13px; font-weight: 600; }
    .module-type-badge { font-size: 9px; padding: 2px 6px; border-radius: 3px; background: var(--tall-color); color: white; }
    .module-dims { display: flex; gap: 6px; margin-top: 2px; flex-wrap: wrap; }
    .dim-group { display: flex; align-items: center; gap: 2px; background: #fafafa; padding: 1px 4px; border-radius: 4px; border: 1px solid #eee; }
    .dim-label { font-size: 10px; color: #888; font-weight: 600; margin: 0; }
    .dim-input { width: 40px; padding: 2px 4px; font-size: 11px; border: none; background: transparent; text-align: center; }
    .dim-input:focus { outline: none; color: var(--primary-color); background: #fff; }
    .module-options { display: flex; gap: 8px; margin-top: 4px; flex-wrap: wrap; }
    .module-chk { display: flex; align-items: center; gap: 3px; font-size: 11px; color: #666; cursor: pointer; }
    .module-chk input { margin: 0; transform: scale(0.9); }
    .btn-delete-module { color: #ccc; background: none; border: none; cursor: pointer; font-size: 18px; padding: 0 4px; margin-left: auto; }
    .btn-delete-module:hover { color: var(--danger-color); }
    .module-btn-group { display: flex; gap: 6px; margin-top: 8px; }
    .btn-add-split { flex: 1; padding: 8px; background: #fff; border: 1px dashed #ccc; color: #666; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .btn-add-split:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f4f8ff; }
    .btn-add-upper { border-color: var(--upper-color); color: var(--upper-color); }
    .btn-add-lower { border-color: var(--lower-color); color: var(--lower-color); }
    .btn-add-tall { border-color: var(--tall-color); color: var(--tall-color); }
    @media (max-width: 800px) { .ws-layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="app-container">
  <h1>Vibe Cabinet Agent</h1>
  <div class="subtitle">í†µí•© ê°€êµ¬ ì„¤ê³„ ë° ìë™ ìì¬ ì‚°ì¶œ ì†”ë£¨ì…˜ (v28)</div>
  <div class="stepper-indicator">
    <div id="step-dot-1" class="step-dot active">1</div>
    <div id="step-dot-2" class="step-dot">2</div>
    <div id="step-dot-3" class="step-dot">3</div>
  </div>
  <div id="step1-content">
    <div class="section-label">1. í•„ìš”í•œ ê°€êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš” <span class="badge">í´ë¦­í•˜ì—¬ ì„ íƒ</span></div>
    <div class="category-grid" id="categoryGrid"></div>
    <div id="detailInputSection">
      <div class="ai-guide-box"><span style="font-size:18px;">ğŸ¤–</span><span id="aiGuideText">ê°€êµ¬ë¥¼ ì¶”ê°€í•˜ë©´ ì…ë ¥ì°½ì´ ìƒì„±ë©ë‹ˆë‹¤.</span></div>
      <div class="section-label">2. ê°€êµ¬ë³„ ìƒì„¸ ì¹˜ìˆ˜ ë° í˜„ì¥ ì‚¬ì§„</div>
      <div id="dynamicInputList"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:30px;">
        <button class="btn-next" id="btnNext" disabled onclick="goToStep2()">ë‹¤ìŒ ë‹¨ê³„ (ì„¤ê³„ ì‹œì‘) â†’</button>
      </div>
    </div>
  </div>
  <div id="step2-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div class="section-label" style="margin:0;">ì„¤ê³„ ì›Œí¬ìŠ¤í˜ì´ìŠ¤</div>
      <button class="btn-back" onclick="backToStep1()">â† ì…ë ¥ ìˆ˜ì •í•˜ê¸°</button>
    </div>
    <div class="bookmark-tabs" id="bookmarkTabs"></div>
    <div class="design-workspace" id="designWorkspace"></div>
  </div>
</div>

<script>
// ============================================================
// ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜
// ============================================================
const CATEGORIES = [
  { id: 'sink', name: 'ì‹±í¬ëŒ€', defaultD: 600 },
  { id: 'island', name: 'ì•„ì¼ëœë“œ', defaultD: 800 },
  { id: 'wardrobe', name: 'ë¶™ë°•ì´ì¥', defaultD: 650 },
  { id: 'fridge', name: 'ëƒ‰ì¥ê³ ì¥', defaultD: 700 },
  { id: 'shoerack', name: 'ì‹ ë°œì¥', defaultD: 350 },
  { id: 'vanity', name: 'í™”ì¥ëŒ€', defaultD: 500 },
  { id: 'storage', name: 'ìˆ˜ë‚©ì¥', defaultD: 400 },
  { id: 'warehouse', name: 'ì°½ê³ ì¥', defaultD: 450 },
  { id: 'door', name: 'ë„ì–´êµì²´', defaultD: 18 },
  { id: 'custom', name: 'ë¹„ê·œê²©ì¥', defaultD: 0 }
];

// â˜… Rule 10: ê· ë“±ë¶„ë°° ìƒìˆ˜ (v28 ì—…ë°ì´íŠ¸)
const DOOR_TARGET_WIDTH = 450;  // ëª©í‘œ ë„ì–´ ë„ˆë¹„ (ì‹±í¬ëŒ€)
const DOOR_MAX_WIDTH = 600;     // ìµœëŒ€ ë„ì–´ ë„ˆë¹„
const DOOR_MIN_WIDTH = 350;     // â˜… ìµœì†Œ ë„ì–´ ë„ˆë¹„ (NEW)
const MIN_REMAINDER = 4;        // â˜… ìµœì†Œ ì”ì—¬ (0â†’4)
const MAX_REMAINDER = 10;       // ìµœëŒ€ ì”ì—¬

const DEFAULT_SPECS = {
  layoutShape: 'I',
  doorColorUpper: 'í™”ì´íŠ¸', doorFinishUpper: 'ë¬´ê´‘',
  doorColorLower: 'í™”ì´íŠ¸', doorFinishLower: 'ë¬´ê´‘',
  topColor: 'ìŠ¤ë…¸ìš°', topThickness: 12,
  upperH: 720, lowerH: 870, moldingH: 60, sinkLegHeight: 150,
  handle: 'ì°¬ë„¬ (ëª©ì°¬ë„¬)', sink: 'ì‚¬ê°ë³¼ 850', faucet: 'ê±°ìœ„ëª© ìˆ˜ì „', 
  hood: 'íˆë“  í›„ë“œ', cooktop: 'ì¸ë•ì…˜', dishwasher: 'None',
  accessories: [{ id: Date.now(), type: 'LTMesh' }],
  // ì‹¤ì¸¡ ê¸°ì¤€ = ë¶„ë°°ê¸° ê¸°ì¤€ = ì¥ ê¸°ì¤€
  measurementBase: 'Left',
  distributorStart: 0, distributorEnd: 0, ventStart: 0,
  finishLeftType: 'Filler', finishLeftWidth: 60,
  finishRightType: 'Filler', finishRightWidth: 60,
  finishCorner1Type: 'Filler', finishCorner1Width: 60,
  finishCorner2Type: 'Filler', finishCorner2Width: 60,
  topSizes: [''],
  effectiveUpperW: null, effectiveLowerW: null,
  // â˜… ë¶™ë°•ì´ì¥ ì „ìš© ì„¤ì •
  curtainBoxW: 0, curtainBoxH: 0,
  wardrobePedestal: 60,    // ì¢ŒëŒ€ ë†’ì´ (ê¸°ë³¸ 60mm)
  wardrobeMoldingH: 15,    // ìƒëª°ë”© ë†’ì´ (ê¸°ë³¸ 15mm)
  // â˜… ëƒ‰ì¥ê³ ì¥ ì „ìš© ì„¤ì • (ê·œì¹™ ê¸°ë°˜)
  fridgeBrand: 'LG',
  fridgeUpperH: 415,       // ìƒë¶€ì¥ ë†’ì´ (ê³ ì •)
  fridgeLowerH: 870,       // í•˜ë¶€ì¥ ë†’ì´ (ì¢ŒëŒ€ 60 í¬í•¨)
  fridgePedestal: 60,      // ì¢ŒëŒ€ ë†’ì´
  fridgeGap: 50,           // ëƒ‰ì¥ê³  ì¢Œìš° ì—¬ìœ  ê°„ê²©
  fridgeModuleD: 550,      // ëª¨ë“ˆ ê¸°ë³¸ ê¹Šì´
  fridgeInstallD: 700      // ì„¤ì¹˜ í•„ìš” ê¹Šì´
};

// â˜… ëƒ‰ì¥ê³ ì¥ ê·œì¹™ ìƒìˆ˜ (ì—…ë°ì´íŠ¸)
const FRIDGE_RULES = {
  MAX_UPPER_H: 400,    // ìƒë¶€ì¥ ìµœëŒ€ ë†’ì´
  PEDESTAL_H: 60,      // ì¢ŒëŒ€ ë†’ì´
  MODULE_D: 550,       // ëª¨ë“ˆ ê¸°ë³¸ ê¹Šì´
  INSTALL_D: 700,      // ì„¤ì¹˜ í•„ìš” ê¹Šì´
  TOP_GAP: 15,         // ëƒ‰ì¥ê³  ìƒë‹¨ ê°„ê²© (ê³ ì •)
  MOLDING_H: 50,       // ìƒëª°ë”© ê¸°ë³¸ ë†’ì´
  EL_W: 600,           // í‚¤í°ì¥/ELì¥ ê¸°ë³¸ í­
  HOMECAFE_W: 600,     // í™ˆì¹´í˜ì¥ ê¸°ë³¸ í­
  // ì—¬ìœ ê³µê°„ ê¸°ë³¸ê°’
  DEFAULT_GAPS: {
    LG_BUILTIN: { side: 4, between: 8 },
    LG_FREESTANDING: { side: 50, between: 0 },
    SS_BESPOKE: { side: 12, between: 7 },
    SS_INFINITE: { side: 5, between: 10 },
    SS_FREESTANDING: { side: 50, between: 0 }
  }
};

// â˜… ëƒ‰ì¥ê³  ëª¨ë¸ ë°ì´í„° (ì—¬ìœ ê³µê°„ ì •ë³´ í¬í•¨)
// â˜… ëƒ‰ì¥ê³  ëª¨ë¸ ë°ì´í„° (ê°œë³„ ë„ì–´ ì •ë³´ í¬í•¨)
const FRIDGE_DATA = {
  LG: {
    name: 'LG',
    categories: {
      'ë‹¨ë… (Fit&Max)': [
        { id: 'lg_300l', name: 'ë‹¨ë… 300L', w: 595, h: 1780, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'300L', w:595}] },
        { id: 'lg_400l', name: 'ë‹¨ë… 400L', w: 595, h: 1850, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'400L', w:595}] },
        { id: 'lg_500l', name: 'ë‹¨ë… 500L', w: 700, h: 1850, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'500L', w:700}] },
        { id: 'lg_600l', name: 'ë‹¨ë… 600L', w: 700, h: 1920, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'600L', w:700}] }
      ],
      'ì„¸íŠ¸ (Fit&Max)': [
        { id: 'lg_set_1d1d', name: '1ë„ì–´+1ë„ì–´', w: 1198, h: 1850, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'lg_set_1d1d1d', name: '1ë„ì–´Ã—3', w: 1809, h: 1850, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'lg_set_300_1d', name: '300+1ë„ì–´', w: 1198, h: 1850, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'300L', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'lg_set_400_1d', name: '400+1ë„ì–´', w: 1198, h: 1850, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'400L', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'lg_set_500_1d', name: '500+1ë„ì–´', w: 1408, h: 1850, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'500L', w:700}, {name:'1ë„ì–´', w:700}] },
        { id: 'lg_set_500_300', name: '500+300', w: 1303, h: 1850, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'500L', w:700}, {name:'300L', w:595}] },
        { id: 'lg_set_500_400', name: '500+400', w: 1303, h: 1850, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'500L', w:700}, {name:'400L', w:595}] },
        { id: 'lg_set_600_300', name: '600+300', w: 1303, h: 1920, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'600L', w:700}, {name:'300L', w:595}] },
        { id: 'lg_set_600_400', name: '600+400', w: 1303, h: 1920, d: 730, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'600L', w:700}, {name:'400L', w:595}] }
      ],
      'ë¹ŒíŠ¸ì¸': [
        { id: 'lg_builtin_fridge_1d', name: 'ëƒ‰ì¥ê³ +1ë„ì–´', w: 1568, h: 1860, d: 698, type: 'builtin', line: 'builtin', sideGap: 22, betweenGap: 11, units: [{name:'ëƒ‰ì¥ê³ ', w:897}, {name:'1ë„ì–´', w:649}] },
        { id: 'lg_builtin_kimchi_1d', name: 'ê¹€ì¹˜+1ë„ì–´', w: 1309, h: 1860, d: 698, type: 'builtin', line: 'builtin', sideGap: 22, betweenGap: 11, units: [{name:'ê¹€ì¹˜', w:649}, {name:'1ë„ì–´', w:649}] },
        { id: 'lg_builtin_fridge_kimchi', name: 'ëƒ‰ì¥+ê¹€ì¹˜', w: 1612, h: 1860, d: 698, type: 'builtin', line: 'builtin', sideGap: 22, betweenGap: 11, units: [{name:'ëƒ‰ì¥', w:897}, {name:'ê¹€ì¹˜', w:649}] },
        { id: 'lg_builtin_fridge_kimchi_1d', name: 'ëƒ‰ì¥+ê¹€ì¹˜+1ë„ì–´', w: 2272, h: 1860, d: 698, type: 'builtin', line: 'builtin', sideGap: 22, betweenGap: 11, units: [{name:'ëƒ‰ì¥', w:897}, {name:'ê¹€ì¹˜', w:649}, {name:'1ë„ì–´', w:649}] },
        { id: 'lg_builtin_1d3', name: '1ë„ì–´Ã—3', w: 2013, h: 1860, d: 698, type: 'builtin', line: 'builtin', sideGap: 22, betweenGap: 11, units: [{name:'1ë„ì–´', w:649}, {name:'1ë„ì–´', w:649}, {name:'1ë„ì–´', w:649}] },
        { id: 'lg_builtin_mood', name: 'ë¬´ë“œëƒ‰ì¥+ë¬´ë“œê¹€ì¹˜', w: 1612, h: 1860, d: 698, type: 'builtin', line: 'builtin', sideGap: 22, betweenGap: 11, units: [{name:'ë¬´ë“œëƒ‰ì¥', w:897}, {name:'ë¬´ë“œê¹€ì¹˜', w:649}] }
      ],
      'í”„ë¦¬ìŠ¤íƒ ë”©': [
        { id: 'lg_free_600_side', name: 'ëƒ‰ì¥ê³ 600 ì–‘ë¬¸í˜•', w: 913, h: 1790, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'ì–‘ë¬¸í˜•600', w:913}] },
        { id: 'lg_free_800_side', name: 'ëƒ‰ì¥ê³ 800 ì–‘ë¬¸í˜•', w: 913, h: 1820, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'ì–‘ë¬¸í˜•800', w:913}] },
        { id: 'lg_free_800_topbot', name: 'ëƒ‰ì¥ê³ 800 ìƒëƒ‰ì¥í•˜ëƒ‰ë™', w: 913, h: 1820, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'ìƒí•˜ëƒ‰ì¥', w:913}] }
      ],
      'ëª¨ë˜ì—£ì§€': [
        { id: 'lg_modern_1d1d', name: 'ëª¨ë˜ì—£ì§€+1ë„ì–´Ã—2', w: 1198, h: 1850, d: 680, type: 'builtin', line: 'fitmax', sideGap: 4, betweenGap: 8, units: [{name:'ëª¨ë˜ì—£ì§€', w:595}, {name:'1ë„ì–´', w:595}] }
      ]
    }
  },
  Samsung: {
    name: 'ì‚¼ì„±',
    categories: {
      'Bespoke ëƒ‰ì¥ê³ ': [
        { id: 'ss_bespoke_1d', name: '1ë„ì–´ í‚¤ì¹œí•', w: 595, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'1ë„ì–´', w:595}] },
        { id: 'ss_bespoke_2d', name: '2ë„ì–´ í‚¤ì¹œí•', w: 595, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'2ë„ì–´', w:595}] },
        { id: 'ss_bespoke_4d', name: '4ë„ì–´ í‚¤ì¹œí•', w: 912, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'4ë„ì–´', w:912}] }
      ],
      'Bespoke ê¹€ì¹˜í”ŒëŸ¬ìŠ¤': [
        { id: 'ss_kimchi_1d', name: '1ë„ì–´ í‚¤ì¹œí•', w: 595, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'ê¹€ì¹˜1ë„ì–´', w:595}] },
        { id: 'ss_kimchi_3d', name: '3ë„ì–´ í‚¤ì¹œí•', w: 695, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'ê¹€ì¹˜3ë„ì–´', w:695}] },
        { id: 'ss_kimchi_4d', name: '4ë„ì–´ í‚¤ì¹œí•', w: 912, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'ê¹€ì¹˜4ë„ì–´', w:912}] }
      ],
      'Bespoke í‚¤ì¹œí• ì„¸íŠ¸': [
        { id: 'ss_kf_2d1d', name: '2ë„ì–´+1ë„ì–´', w: 1197, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'2ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_kf_4d1d', name: '4ë„ì–´+1ë„ì–´', w: 1514, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'4ë„ì–´', w:912}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_kf_4d3d', name: '4ë„ì–´+3ë„ì–´', w: 1614, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'4ë„ì–´', w:912}, {name:'3ë„ì–´', w:695}] },
        { id: 'ss_kf_4d3d1d', name: '4ë„ì–´+3ë„ì–´+1ë„ì–´', w: 2216, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'4ë„ì–´', w:912}, {name:'3ë„ì–´', w:695}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_kf_1d3', name: '1ë„ì–´Ã—3', w: 1799, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_kf_1d4', name: '1ë„ì–´Ã—4', w: 2401, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_kf_max', name: 'Max 4ë„ì–´+4ë„ì–´', w: 1831, h: 1853, d: 688, type: 'builtin', line: 'bespoke', sideGap: 12, betweenGap: 7, units: [{name:'4ë„ì–´', w:912}, {name:'4ë„ì–´', w:912}] }
      ],
      'Bespoke í”„ë¦¬ìŠ¤íƒ ë”©': [
        { id: 'ss_bespoke_4d_free', name: '4ë„ì–´ í”„ë¦¬ìŠ¤íƒ ë”©', w: 912, h: 1853, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'4ë„ì–´FS', w:912}] },
        { id: 'ss_kimchi_4d_free', name: 'ê¹€ì¹˜ 4ë„ì–´ í”„ë¦¬ìŠ¤íƒ ë”©', w: 912, h: 1853, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'ê¹€ì¹˜4ë„ì–´FS', w:912}] }
      ],
      'Infinite Line ëƒ‰ì¥ê³ ': [
        { id: 'ss_inf_1d', name: '1ë„ì–´ í‚¤ì¹œí•', w: 595, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'1ë„ì–´', w:595}] },
        { id: 'ss_inf_4d', name: '4ë„ì–´ í‚¤ì¹œí•', w: 912, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'4ë„ì–´', w:912}] }
      ],
      'Infinite Line ê¹€ì¹˜í”ŒëŸ¬ìŠ¤': [
        { id: 'ss_inf_kimchi_1d', name: '1ë„ì–´ í‚¤ì¹œí•', w: 595, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'ê¹€ì¹˜1ë„ì–´', w:595}] },
        { id: 'ss_inf_kimchi_4d', name: '4ë„ì–´ í‚¤ì¹œí•', w: 912, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'ê¹€ì¹˜4ë„ì–´', w:912}] }
      ],
      'Infinite Line í‚¤ì¹œí• ì„¸íŠ¸': [
        { id: 'ss_inf_1d1d', name: '1ë„ì–´+1ë„ì–´', w: 1200, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_inf_1d3', name: '1ë„ì–´Ã—3', w: 1815, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_inf_1d4', name: '1ë„ì–´Ã—4', w: 2420, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}, {name:'1ë„ì–´', w:595}] },
        { id: 'ss_inf_4d4d', name: '4ë„ì–´+4ë„ì–´', w: 1834, h: 1855, d: 688, type: 'builtin', line: 'infinite', sideGap: 5, betweenGap: 10, units: [{name:'4ë„ì–´', w:912}, {name:'4ë„ì–´', w:912}] }
      ],
      'Infinite Line í”„ë¦¬ìŠ¤íƒ ë”©': [
        { id: 'ss_inf_4d_free', name: '4ë„ì–´ í”„ë¦¬ìŠ¤íƒ ë”©', w: 912, h: 1855, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'4ë„ì–´FS', w:912}] }
      ],
      'ê¹€ì¹˜í”ŒëŸ¬ìŠ¤ ìŠ¤íƒ ë“œ': [
        { id: 'ss_stand_3d', name: 'ìŠ¤íƒ ë“œí˜• 3ë„ì–´', w: 595, h: 1380, d: 688, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'ìŠ¤íƒ ë“œ3ë„ì–´', w:595}] },
        { id: 'ss_stand_4d', name: 'ìŠ¤íƒ ë“œí˜• 4ë„ì–´', w: 595, h: 1530, d: 688, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'ìŠ¤íƒ ë“œ4ë„ì–´', w:595}] }
      ],
      'ì–‘ë¬¸í˜•': [
        { id: 'ss_rs70', name: 'RS70', w: 912, h: 1780, d: 716, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'RS70', w:912}] },
        { id: 'ss_rs80f', name: 'RS80F', w: 912, h: 1780, d: 716, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'RS80F', w:912}] },
        { id: 'ss_rs84', name: 'RS84', w: 912, h: 1825, d: 738, type: 'freestanding', line: 'freestanding', sideGap: 50, betweenGap: 0, units: [{name:'RS84', w:912}] }
      ]
    }
  }
};

// â˜… ELì¥ ë„ì–´ íƒ€ì…
const EL_DOOR_TYPES = [
  { id: 'pocket', name: 'í¬ì¼“ë ˆì¼' },
  { id: 'liftup', name: 'ë¦¬í”„íŠ¸ì—…' },
  { id: 'swing', name: 'ì—¬ë‹«ì´' }
];

// â˜… ë§ˆê° íƒ€ì… (íœ ë¼ë¡œ ë³€ê²½, ëª°ë”© ê¸°ë³¸)
const FINISH_TYPES = [
  { id: 'molding', name: 'ëª°ë”©', defaultW: 60, editable: true },
  { id: 'filler', name: 'íœ ë¼', defaultW: 60, editable: true },
  { id: 'ep', name: 'EP', defaultW: 20, editable: false }
];

// â˜… í•˜ë¶€ì¥ ëª¨ë“ˆ íƒ€ì…
const LOWER_MODULE_TYPES = [
  { id: 'drawer', name: 'ì„œëì¥', defaultW: 600, color: '#6b7280', icon: 'ğŸ—„ï¸' },
  { id: 'el', name: 'ELì¥', defaultW: 600, color: '#10b981', icon: 'âš¡' },
  { id: 'robot', name: 'ë¡œë´‡ì²­ì†Œê¸°ì¥', defaultW: 600, color: '#f59e0b', icon: 'ğŸ¤–' },
  { id: 'rice', name: 'ë°¥ì†¥ì¥', defaultW: 450, color: '#ef4444', icon: 'ğŸš' }
];

let selectedItems = [];

// ============================================================
// í•µì‹¬ ê³„ì‚° í•¨ìˆ˜ë“¤
// ============================================================

/**
 * ë„ì–´ ë„ˆë¹„ ìµœì í™” (v28 ì—…ë°ì´íŠ¸)
 * ìµœìš°ì„ : 4mm â‰¤ ì”ì—¬ê³µê°„ â‰¤ 10mm
 * ì°¨ì„ : 0mm â‰¤ ì”ì—¬ê³µê°„ < 4mm (ì •í™•íˆ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ê²½ìš°)
 * ê·¸ ë‹¤ìŒ: 10ì˜ ë‹¨ìœ„ > ì§ìˆ˜
 * ì œì•½: 350mm â‰¤ ë„ì–´ ë„ˆë¹„ â‰¤ 600mm
 */
function findBestDoorWidth(totalSpace, doorCount) {
  const rawWidth = totalSpace / doorCount;
  
  // â˜… ë„ì–´ ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œì•½ í™•ì¸
  if (rawWidth > DOOR_MAX_WIDTH) return null;
  if (rawWidth < DOOR_MIN_WIDTH) return null;
  
  const primaryCandidates = [];   // 4~10mm ì¡°ê±´ ë§Œì¡±
  const secondaryCandidates = []; // 0~3mm (ì°¨ì„ )
  
  // 10ì˜ ë‹¨ìœ„ í›„ë³´ (ë‚´ë¦¼, ì˜¬ë¦¼)
  const tenFloor = Math.floor(rawWidth / 10) * 10;
  const tenCeil = Math.ceil(rawWidth / 10) * 10;
  
  // ì§ìˆ˜ í›„ë³´ (ë‚´ë¦¼, ì˜¬ë¦¼)
  const evenFloor = Math.floor(rawWidth / 2) * 2;
  const evenCeil = Math.ceil(rawWidth / 2) * 2;
  
  // í›„ë³´ë“¤ê³¼ ìš°ì„ ìˆœìœ„ (priority ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
  const allCandidates = [
    { width: tenFloor, priority: 1 },
    { width: tenCeil, priority: 1 },
    { width: evenFloor, priority: 2 },
    { width: evenCeil, priority: 2 },
  ];
  
  // í›„ë³´ ë¶„ë¥˜
  for (const cand of allCandidates) {
    if (cand.width < DOOR_MIN_WIDTH || cand.width > DOOR_MAX_WIDTH) continue;
    const used = cand.width * doorCount;
    const gap = totalSpace - used;
    if (gap < 0) continue;
    
    if (gap >= MIN_REMAINDER && gap <= MAX_REMAINDER) {
      // â˜… ìš°ì„ : 4~10mm ì¡°ê±´ ë§Œì¡±
      primaryCandidates.push({ ...cand, gap });
    } else if (gap >= 0 && gap < MIN_REMAINDER) {
      // â˜… ì°¨ì„ : 0~3mm (ì •í™•íˆ ë‚˜ëˆ„ì–´ ë–¨ì–´ì§€ëŠ” ê²½ìš° í¬í•¨)
      secondaryCandidates.push({ ...cand, gap });
    }
  }
  
  // ìš°ì„ ìˆœìœ„ ì •ë ¬ í•¨ìˆ˜
  const sortCandidates = (arr) => {
    arr.sort((a, b) => {
      if (a.priority !== b.priority) return a.priority - b.priority;
      return a.gap - b.gap;
    });
  };
  
  // ìš°ì„  í›„ë³´ ì„ íƒ
  if (primaryCandidates.length > 0) {
    sortCandidates(primaryCandidates);
    return primaryCandidates[0].width;
  }
  
  // ì°¨ì„  í›„ë³´ ì„ íƒ (0~3mm)
  if (secondaryCandidates.length > 0) {
    sortCandidates(secondaryCandidates);
    return secondaryCandidates[0].width;
  }
  
  return null;
}

/**
 * ëª¨ë“ˆ ê· ë“± ë¶„ë°° í•¨ìˆ˜ (v28 ì—…ë°ì´íŠ¸)
 * - ìµœìš°ì„ : 4mm â‰¤ ì”ì—¬ê³µê°„ â‰¤ 10mm
 * - ì°¨ì„ : 0mm â‰¤ ì”ì—¬ê³µê°„ < 4mm
 * - ì œì•½: 350mm â‰¤ ë„ì–´ ë„ˆë¹„ â‰¤ 600mm, ëª©í‘œ â‰ˆ 450mm
 * - ë„ì–´ê°œìˆ˜/2 â†’ ëª«*2D, ë‚˜ë¨¸ì§€*1D
 */
function distributeModules(totalSpace) {
  if (totalSpace < 100) return { modules: [], doorWidth: 0, doorCount: 0 };
  
  // â˜… ë„ì–´ ê°œìˆ˜ ë²”ìœ„ ì„¤ì • (ìµœì†Œ/ìµœëŒ€ ë„ì–´ ë„ˆë¹„ ë°˜ì˜)
  const minCount = Math.max(1, Math.ceil(totalSpace / DOOR_MAX_WIDTH));
  const maxDoorCount = Math.floor(totalSpace / DOOR_MIN_WIDTH);
  const baseCount = Math.round(totalSpace / DOOR_TARGET_WIDTH);
  const maxCount = Math.min(maxDoorCount, Math.max(baseCount + 3, minCount + 5));
  
  // ëª¨ë“  ìœ íš¨í•œ ì¡°í•© ìˆ˜ì§‘
  let allResults = [];
  
  for (let count = minCount; count <= maxCount; count++) {
    const width = findBestDoorWidth(totalSpace, count);
    if (width !== null) {
      const gap = totalSpace - (width * count);
      const targetDiff = Math.abs(width - DOOR_TARGET_WIDTH);
      const isPrimary = (gap >= MIN_REMAINDER && gap <= MAX_REMAINDER);
      
      allResults.push({ 
        doorCount: count, 
        doorWidth: width, 
        gap, 
        targetDiff,
        isPrimary  // 4~10mm ì¡°ê±´ ë§Œì¡± ì—¬ë¶€
      });
    }
  }
  
  // ì •ë ¬: isPrimary ìš°ì„  â†’ targetDiff ì‘ì€ ìˆœ â†’ gap ì‘ì€ ìˆœ
  allResults.sort((a, b) => {
    // 1. 4~10mm ì¡°ê±´ ë§Œì¡±í•˜ëŠ” ê²ƒ ìš°ì„ 
    if (a.isPrimary !== b.isPrimary) return b.isPrimary - a.isPrimary;
    // 2. ëª©í‘œ ë„ì–´ ë„ˆë¹„(450mm)ì— ê°€ê¹Œìš´ ê²ƒ ìš°ì„ 
    if (a.targetDiff !== b.targetDiff) return a.targetDiff - b.targetDiff;
    // 3. ì”ì—¬ ì‘ì€ ê²ƒ ìš°ì„ 
    return a.gap - b.gap;
  });
  
  let bestResult = allResults.length > 0 ? allResults[0] : null;
  
  // ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ê°•ì œ ê³„ì‚°
  if (!bestResult) {
    // ëª©í‘œ ë„ì–´ ë„ˆë¹„ì— ê°€ì¥ ê°€ê¹Œìš´ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
    const idealCount = Math.round(totalSpace / DOOR_TARGET_WIDTH);
    const count = Math.max(minCount, Math.min(maxDoorCount, idealCount));
    let width = Math.floor(totalSpace / count / 2) * 2;
    width = Math.max(DOOR_MIN_WIDTH, Math.min(DOOR_MAX_WIDTH, width));
    bestResult = { doorCount: count, doorWidth: width, gap: totalSpace - (width * count) };
  }
  
  const { doorCount, doorWidth } = bestResult;
  const quotient = Math.floor(doorCount / 2);
  const remainder = doorCount % 2;
  
  const modules = [];
  // 2D ëª¨ë“ˆ (ëª« ê°œ)
  for (let i = 0; i < quotient; i++) {
    modules.push({ w: doorWidth * 2, is2D: true });
  }
  // 1D ëª¨ë“ˆ (ë‚˜ë¨¸ì§€ ê°œ)
  if (remainder > 0) {
    modules.push({ w: doorWidth, is2D: false });
  }
  
  return { modules, doorWidth, doorCount };
}

/**
 * ìœ íš¨ ê³µê°„ ê³„ì‚°
 */
function calcEffectiveSpace(item) {
  const W = parseFloat(item.w) || 0;
  const fL = item.specs.finishLeftType !== 'None' ? (parseFloat(item.specs.finishLeftWidth) || 0) : 0;
  const fR = item.specs.finishRightType !== 'None' ? (parseFloat(item.specs.finishRightWidth) || 0) : 0;
  const fC1 = item.specs.layoutShape !== 'I' && item.specs.finishCorner1Type !== 'None' ? (parseFloat(item.specs.finishCorner1Width) || 0) : 0;
  const fC2 = item.specs.layoutShape === 'U' && item.specs.finishCorner2Type !== 'None' ? (parseFloat(item.specs.finishCorner2Width) || 0) : 0;
  return W - fL - fR - fC1 - fC2;
}

function getEffectiveSpace(item, section) {
  const manualValue = section === 'upper' ? item.specs.effectiveUpperW : item.specs.effectiveLowerW;
  if (manualValue !== null && manualValue !== '') return parseFloat(manualValue) || 0;
  return calcEffectiveSpace(item);
}

/**
 * ê³ ì • ëª¨ë“ˆ ìœ„ì¹˜ ì¡°ì • (ê²½ê³„ ë‚´ë¡œ)
 */
function adjustFixedPositions(fixedList, startBound, endBound) {
  fixedList.sort((a, b) => a.x - b.x);
  
  // ì™¼ìª½ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê²¹ì¹¨ ë°©ì§€
  let cursor = startBound;
  fixedList.forEach(mod => {
    if (mod.x < cursor) {
      mod.x = cursor;
      mod.endX = mod.x + mod.w;
    }
    cursor = mod.endX;
  });
  
  // ì˜¤ë¥¸ìª½ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ê²½ê³„ ì¡°ì •
  let rightCursor = endBound;
  for (let i = fixedList.length - 1; i >= 0; i--) {
    const mod = fixedList[i];
    if (mod.endX > rightCursor) {
      mod.endX = rightCursor;
      mod.x = mod.endX - mod.w;
    }
    rightCursor = mod.x;
  }
  
  return fixedList;
}

/**
 * ë¹ˆ ê³µê°„(Gap) ê³„ì‚°
 */
function calculateGaps(fixedList, startBound, endBound) {
  const gaps = [];
  let cursor = startBound;
  
  for (const fixed of fixedList) {
    if (fixed.x > cursor + 1) {
      gaps.push({ start: cursor, end: fixed.x, width: fixed.x - cursor });
    }
    cursor = fixed.endX;
  }
  if (cursor < endBound - 1) {
    gaps.push({ start: cursor, end: endBound, width: endBound - cursor });
  }
  
  return gaps;
}

/**
 * Gapì„ ëª¨ë“ˆë¡œ ì±„ìš°ê¸° (v28 ì—…ë°ì´íŠ¸: í›„ë“œ ì œì™¸ ëª¨ë“  ë„ì–´ ë™ì¼ í¬ê¸°)
 * @param {Object} gap - { start, end, width }
 * @param {string} section - 'upper' | 'lower'
 * @param {number} defaultH - ê¸°ë³¸ ë†’ì´
 * @param {number} defaultD - ê¸°ë³¸ ê¹Šì´
 * @param {number} fixedDoorWidth - ê³ ì • ë„ì–´ ë„ˆë¹„ (ì „ë‹¬ì‹œ í•´ë‹¹ ë„ˆë¹„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
 */
function fillGapWithModules(gap, section, defaultH, defaultD, fixedDoorWidth = null) {
  const newModules = [];
  const namePrefix = section === 'upper' ? 'ìƒë¶€ì¥' : 'í•˜ë¶€ì¥';
  
  if (gap.width < 100) return newModules;
  
  let doorWidth, doorCount;
  
  if (fixedDoorWidth) {
    // â˜… ê³ ì • ë„ì–´ ë„ˆë¹„ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ëª¨ë“  ë„ì–´ ë™ì¼ í¬ê¸°)
    doorWidth = fixedDoorWidth;
    doorCount = Math.round(gap.width / fixedDoorWidth);
    if (doorCount < 1) doorCount = 1;
    
    // ì œì•½ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ë„ì–´ ê°œìˆ˜ ì¡°ì •ì´ í•„ìš”í•œ ê²½ìš°ë§Œ
    if (doorWidth < DOOR_MIN_WIDTH) {
      doorCount = Math.max(1, Math.floor(gap.width / DOOR_MIN_WIDTH));
    } else if (doorWidth > DOOR_MAX_WIDTH) {
      doorCount = Math.ceil(gap.width / DOOR_MAX_WIDTH);
    }
    // â˜… doorWidthëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ (ë™ì¼ í¬ê¸° ìœ ì§€)
  } else {
    // ê³ ì • ë„ì–´ ë„ˆë¹„ê°€ ì—†ëŠ” ê²½ìš°: ê¸°ì¡´ ë¶„ë°°ê·œì¹™ ì ìš©
    const result = distributeModules(gap.width);
    doorWidth = result.doorWidth;
    doorCount = result.doorCount;
  }
  
  // ëª¨ë“ˆ ìƒì„± (ë„ì–´ê°œìˆ˜/2 â†’ ëª«*2D + ë‚˜ë¨¸ì§€*1D)
  const quotient = Math.floor(doorCount / 2);
  const mod1D = doorCount % 2;
  
  let dx = gap.start;
  
  // 2D ëª¨ë“ˆ (ëª« ê°œ) - ëª¨ë‘ ë™ì¼í•œ ë„ì–´ ë„ˆë¹„ Ã— 2
  for (let i = 0; i < quotient; i++) {
    const w = doorWidth * 2;
    newModules.push(createModule(section, namePrefix, w, defaultH, defaultD, true, dx));
    dx += w;
  }
  
  // 1D ëª¨ë“ˆ (ë‚˜ë¨¸ì§€ ê°œ) - ë™ì¼í•œ ë„ì–´ ë„ˆë¹„
  if (mod1D > 0) {
    const w = doorWidth;
    newModules.push(createModule(section, namePrefix, w, defaultH, defaultD, false, dx));
    dx += w;
  }
  
  // â˜… ì”ì—¬ ê³µê°„ì€ ì‹œê³µ ì—¬ìœ ë¡œ ì²˜ë¦¬ (ëª¨ë“ˆ ë„ˆë¹„ì— ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
  
  return newModules;
}

/**
 * ëª¨ë“ˆ ê°ì²´ ìƒì„± í—¬í¼
 */
function createModule(pos, namePrefix, w, h, d, is2D, x) {
  return {
    id: Date.now() + Math.random(),
    type: 'storage',
    name: `${namePrefix}(${is2D ? '2D' : '1D'})`,
    pos, w, h, d,
    isDrawer: false, isEL: false, isFixed: false,
    _x: x
  };
}

/**
 * ì”ì—¬ ê³µê°„ ìƒ‰ìƒ (v28: 0~10mmê°€ ë…¹ìƒ‰)
 */
function getRemainColor(remaining) {
  if (remaining < 0 || remaining > MAX_REMAINDER + 5) return "#ff4d4f";  // ìŒìˆ˜ ë˜ëŠ” 15mm ì´ˆê³¼
  if (remaining >= 0 && remaining <= MAX_REMAINDER) return "#00c853";    // 0~10mm ë…¹ìƒ‰
  return "#4a7dff";  // 11~15mm íŒŒë€ìƒ‰
}

// ============================================================
// ì„¹ì…˜ ìë™ ê³„ì‚° í•¨ìˆ˜
// ============================================================

/**
 * ìë™ê³„ì‚° ë¡œì§ ìš”ì•½ (v28 ì—…ë°ì´íŠ¸):
 * 
 * 1. ìœ íš¨ê³µê°„ = ì „ì²´ë„ˆë¹„ - ë§ˆê°ë“¤
 * 2. ê³ ì • ëª¨ë“ˆ ìˆ˜ì§‘ ë° ìœ„ì¹˜ ê²°ì •
 *    - í•˜ë¶€: ê°œìˆ˜ëŒ€(ë¶„ë°°ê¸°ì‹œì‘-100), ê°€ìŠ¤ëŒ€(í™˜í’êµ¬ì¤‘ì•™), LTë§ì¥(ê°€ìŠ¤ëŒ€ì˜†+ë¨¼ìª½)
 *    - ìƒë¶€: í›„ë“œ(í™˜í’êµ¬ì¤‘ì•™), ê¸°ì¤€ìƒë¶€ì¥(ê°œìˆ˜ëŒ€ ì¤‘ì•™ ì •ë ¬, 2D)
 * 3. ê°œìˆ˜ëŒ€ ë…¼ë¦¬ì¡°ê±´ ê²€ì¦: ì‹œì‘<ë¶„ë°°ê¸°ì‹œì‘ AND ë>ë¶„ë°°ê¸°ë
 * 4. Gap ê³„ì‚° ë° ê· ë“±ë¶„ë°°
 *    - ìµœìš°ì„ : 4mm â‰¤ ì”ì—¬ â‰¤ 10mm
 *    - ì°¨ì„ : 0mm â‰¤ ì”ì—¬ < 4mm
 *    - ë„ì–´: 350~600mm, ëª©í‘œ â‰ˆ 450mm
 *    - ë„ì–´ê°œìˆ˜/2 â†’ ëª«*2D + ë‚˜ë¨¸ì§€*1D
 */

function runAutoCalcSection(itemUniqueId, section) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;

  if (section === 'upper') {
    item.prevUpperModules = JSON.parse(JSON.stringify(item.modules.filter(m => m.pos === 'upper')));
    runAutoCalcUpper(item);
    alert('ìƒë¶€ì¥ ìë™ ê³„ì‚° ì™„ë£Œ!');
  } else {
    item.prevLowerModules = JSON.parse(JSON.stringify(item.modules.filter(m => m.pos === 'lower')));
    runAutoCalcLower(item);
    alert('í•˜ë¶€ì¥ ìë™ ê³„ì‚° ì™„ë£Œ!');
  }
  
  renderWorkspaceContent(item);
}

function runAutoCalcUpper(item) {
  const W = parseFloat(item.w) || 0;
  const effectiveW = getEffectiveSpace(item, 'upper');
  
  if (effectiveW <= 0) {
    alert("ìƒë¶€ì¥ ìœ íš¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    return;
  }

  const specUpperH = parseFloat(item.specs.upperH) || 720;
  const upperBodyH = specUpperH - 20;
  const isRefLeft = item.specs.measurementBase === 'Left';
  const fL = item.specs.finishLeftType !== 'None' ? (parseFloat(item.specs.finishLeftWidth) || 0) : 0;
  const startBound = fL;
  const endBound = startBound + effectiveW;

  // â˜… Step 1: ê°œìˆ˜ëŒ€ ì¤‘ì•™ì  ê³„ì‚°
  let absDistStart;
  if (isRefLeft) {
    absDistStart = parseFloat(item.specs.distributorStart) || 0;
  } else {
    absDistStart = W - (parseFloat(item.specs.distributorStart) || 0);
  }
  const sinkStart = absDistStart - 100;
  const sinkW = 1000;
  const sinkCenter = sinkStart + (sinkW / 2);  // ê°œìˆ˜ëŒ€ ì¤‘ì•™

  // â˜… Step 2: í›„ë“œ ì´ˆê¸° ìœ„ì¹˜ ê³„ì‚° (í™˜í’êµ¬ ì¤‘ì•™ ì •ë ¬)
  const absVent = isRefLeft ? (parseFloat(item.specs.ventStart) || 0) : W - (parseFloat(item.specs.ventStart) || 0);
  const hoodW = 800;
  let hoodXInit = Math.max(startBound, Math.min(absVent - hoodW / 2, endBound - hoodW));
  
  // â˜… Step 3-4: ìœ íš¨ê³µê°„(í›„ë“œ ì œì™¸)ì—ì„œ ì„ì‹œ ë„ì–´ ë„ˆë¹„ ê³„ì‚°
  const totalSpaceExcludeHood = effectiveW - hoodW;
  const tempResult = distributeModules(totalSpaceExcludeHood);
  const tempDoorWidth = tempResult.doorWidth || DOOR_TARGET_WIDTH;
  
  // ê¸°ì¤€ ìƒë¶€ì¥ ì„ì‹œ ë„ˆë¹„ (2D)
  const tempBaseUpperW = tempDoorWidth * 2;
  
  // ê¸°ì¤€ ìƒë¶€ì¥ ì´ˆê¸° ìœ„ì¹˜ (ê°œìˆ˜ëŒ€ ì¤‘ì•™ ì •ë ¬)
  let baseUpperXInit = sinkCenter - (tempBaseUpperW / 2);
  if (baseUpperXInit < startBound) baseUpperXInit = startBound;
  if (baseUpperXInit + tempBaseUpperW > endBound) baseUpperXInit = endBound - tempBaseUpperW;

  // â˜… Step 5-6-7: í›„ë“œ Â±50mm, ê¸°ì¤€ìƒë¶€ì¥ Â±100mm ì´ë™í•˜ë©´ì„œ ìµœì  ìœ„ì¹˜ ì°¾ê¸°
  const hoodTolerance = 50;
  const baseTolerance = 100;
  
  let bestHoodOffset = 0;
  let bestBaseOffset = 0;
  let bestDoorWidth = tempDoorWidth;
  let bestTotalRemainder = Infinity;
  let bestHoodX = hoodXInit;
  let bestBaseUpperX = baseUpperXInit;
  
  for (let hoodOffset = -hoodTolerance; hoodOffset <= hoodTolerance; hoodOffset++) {
    const testHoodX = hoodXInit + hoodOffset;
    
    // í›„ë“œ ê²½ê³„ ì²´í¬
    if (testHoodX < startBound || testHoodX + hoodW > endBound) continue;
    
    for (let baseOffset = -baseTolerance; baseOffset <= baseTolerance; baseOffset++) {
      const testBaseX = baseUpperXInit + baseOffset;
      
      // ê¸°ì¤€ìƒë¶€ì¥ ê²½ê³„ ì²´í¬
      if (testBaseX < startBound || testBaseX + tempBaseUpperW > endBound) continue;
      
      // í›„ë“œì™€ ê¸°ì¤€ìƒë¶€ì¥ ê²¹ì¹¨ ì²´í¬
      if (testBaseX < testHoodX + hoodW && testBaseX + tempBaseUpperW > testHoodX) continue;
      
      // ê³ ì • ëª¨ë“ˆ ìœ„ì¹˜ ì •ë ¬
      const fixedModules = [
        { x: testHoodX, endX: testHoodX + hoodW, type: 'hood' },
        { x: testBaseX, endX: testBaseX + tempBaseUpperW, type: 'base' }
      ].sort((a, b) => a.x - b.x);
      
      // â˜… Step 5: ì‹œì‘ ê³µê°„ - ë…ë¦½ì ìœ¼ë¡œ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
      let startSpace = 0;
      let startDoorCount = 0;
      if (fixedModules[0].x > startBound + 50) {
        startSpace = fixedModules[0].x - startBound;
        startDoorCount = Math.round(startSpace / tempDoorWidth);
        if (startDoorCount < 1 && startSpace >= 200) startDoorCount = 1;
      }
      
      // ì¤‘ê°„ ê³µê°„ - ë…ë¦½ì ìœ¼ë¡œ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
      let middleSpace = 0;
      let middleDoorCount = 0;
      if (fixedModules[1].x > fixedModules[0].endX + 50) {
        middleSpace = fixedModules[1].x - fixedModules[0].endX;
        middleDoorCount = Math.round(middleSpace / tempDoorWidth);
        if (middleDoorCount < 1 && middleSpace >= 200) middleDoorCount = 1;
      }
      
      // â˜… Step 6: ë ê³µê°„ - ë…ë¦½ì ìœ¼ë¡œ ë„ì–´ ê°œìˆ˜ ê³„ì‚°
      let endSpace = 0;
      let endDoorCount = 0;
      if (endBound > fixedModules[1].endX + 50) {
        endSpace = endBound - fixedModules[1].endX;
        endDoorCount = Math.round(endSpace / tempDoorWidth);
        if (endDoorCount < 1 && endSpace >= 200) endDoorCount = 1;
      }
      
      // ì´ ë„ì–´ ê°œìˆ˜ (ê¸°ì¤€ìƒë¶€ì¥ = 2D = ë„ì–´ 2ê°œ)
      const baseDoorCount = 2;
      const totalDoorCount = startDoorCount + middleDoorCount + baseDoorCount + endDoorCount;
      
      if (totalDoorCount < 2) continue;
      
      // â˜… Step 7: ê· ë“± ë„ì–´ ë„ˆë¹„ ê³„ì‚° (í›„ë“œ ì œì™¸ ì „ì²´ ê³µê°„ / ì´ ë„ì–´ ê°œìˆ˜)
      const testDoorWidth = Math.floor(totalSpaceExcludeHood / totalDoorCount);
      
      // ë„ì–´ ì œì•½ ì¡°ê±´ í™•ì¸
      if (testDoorWidth < DOOR_MIN_WIDTH || testDoorWidth > DOOR_MAX_WIDTH) continue;
      
      // ìƒˆ ê¸°ì¤€ìƒë¶€ì¥ ë„ˆë¹„
      const newBaseUpperW = testDoorWidth * 2;
      
      // ìƒˆ ê¸°ì¤€ìƒë¶€ì¥ ìœ„ì¹˜ (ê°œìˆ˜ëŒ€ ì¤‘ì•™ ê¸°ì¤€ + offset)
      const newBaseUpperX = sinkCenter - (newBaseUpperW / 2) + baseOffset;
      
      // ìƒˆ ê²½ê³„ ì²´í¬
      if (newBaseUpperX < startBound || newBaseUpperX + newBaseUpperW > endBound) continue;
      
      // í›„ë“œì™€ ê²¹ì¹¨ ì¬ì²´í¬
      if (newBaseUpperX < testHoodX + hoodW && newBaseUpperX + newBaseUpperW > testHoodX) continue;
      
      // ì´ ì‚¬ìš© ê³µê°„ ë° ì”ì—¬ ê³„ì‚°
      const totalUsed = testDoorWidth * totalDoorCount;
      const totalRemainder = totalSpaceExcludeHood - totalUsed;
      
      // â˜… ì¡°ê±´: ì—¬ìœ ê³µê°„ â‰¤ 10mm
      if (totalRemainder >= 0 && totalRemainder <= MAX_REMAINDER) {
        if (totalRemainder < bestTotalRemainder) {
          bestTotalRemainder = totalRemainder;
          bestHoodOffset = hoodOffset;
          bestBaseOffset = baseOffset;
          bestDoorWidth = testDoorWidth;
          bestHoodX = testHoodX;
          bestBaseUpperX = newBaseUpperX;
        }
      }
    }
  }
  
  // ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ê²½ìš°ê°€ ì—†ìœ¼ë©´, ì”ì—¬ê°€ ê°€ì¥ ì‘ì€ ê²ƒ ì„ íƒ
  if (bestTotalRemainder > MAX_REMAINDER) {
    for (let hoodOffset = -hoodTolerance; hoodOffset <= hoodTolerance; hoodOffset++) {
      const testHoodX = hoodXInit + hoodOffset;
      if (testHoodX < startBound || testHoodX + hoodW > endBound) continue;
      
      for (let baseOffset = -baseTolerance; baseOffset <= baseTolerance; baseOffset++) {
        const testBaseX = baseUpperXInit + baseOffset;
        if (testBaseX < startBound || testBaseX + tempBaseUpperW > endBound) continue;
        if (testBaseX < testHoodX + hoodW && testBaseX + tempBaseUpperW > testHoodX) continue;
        
        const fixedModules = [
          { x: testHoodX, endX: testHoodX + hoodW },
          { x: testBaseX, endX: testBaseX + tempBaseUpperW }
        ].sort((a, b) => a.x - b.x);
        
        let startDoorCount = 0, middleDoorCount = 0, endDoorCount = 0;
        
        if (fixedModules[0].x > startBound + 50) {
          startDoorCount = Math.max(1, Math.round((fixedModules[0].x - startBound) / tempDoorWidth));
        }
        if (fixedModules[1].x > fixedModules[0].endX + 50) {
          middleDoorCount = Math.max(1, Math.round((fixedModules[1].x - fixedModules[0].endX) / tempDoorWidth));
        }
        if (endBound > fixedModules[1].endX + 50) {
          endDoorCount = Math.max(1, Math.round((endBound - fixedModules[1].endX) / tempDoorWidth));
        }
        
        const totalDoorCount = startDoorCount + middleDoorCount + 2 + endDoorCount;
        if (totalDoorCount < 2) continue;
        
        const testDoorWidth = Math.floor(totalSpaceExcludeHood / totalDoorCount);
        if (testDoorWidth < DOOR_MIN_WIDTH || testDoorWidth > DOOR_MAX_WIDTH) continue;
        
        const newBaseUpperW = testDoorWidth * 2;
        const newBaseUpperX = sinkCenter - (newBaseUpperW / 2) + baseOffset;
        
        if (newBaseUpperX < startBound || newBaseUpperX + newBaseUpperW > endBound) continue;
        if (newBaseUpperX < testHoodX + hoodW && newBaseUpperX + newBaseUpperW > testHoodX) continue;
        
        const totalRemainder = Math.abs(totalSpaceExcludeHood - (testDoorWidth * totalDoorCount));
        
        if (totalRemainder < bestTotalRemainder) {
          bestTotalRemainder = totalRemainder;
          bestHoodOffset = hoodOffset;
          bestBaseOffset = baseOffset;
          bestDoorWidth = testDoorWidth;
          bestHoodX = testHoodX;
          bestBaseUpperX = newBaseUpperX;
        }
      }
    }
  }

  // â˜… ìµœì¢… ëª¨ë“ˆ ë°°ì¹˜
  const finalBaseUpperW = bestDoorWidth * 2;
  const finalHoodX = bestHoodX;
  const finalBaseUpperX = bestBaseUpperX;

  let fixedOccupied = [];
  
  // í›„ë“œ ì¶”ê°€
  fixedOccupied.push({ 
    type: 'hood', name: 'í›„ë“œì¥', w: hoodW, h: upperBodyH - 40, d: 295, 
    x: finalHoodX, endX: finalHoodX + hoodW, pos: 'upper', isFixed: true
  });

  // ê¸°ì¤€ ìƒë¶€ì¥ ì¶”ê°€
  fixedOccupied.push({
    type: 'storage', name: 'ê¸°ì¤€ìƒë¶€ì¥(2D)', w: finalBaseUpperW, h: upperBodyH, d: 295,
    x: finalBaseUpperX, endX: finalBaseUpperX + finalBaseUpperW, pos: 'upper', isFixed: true, isBase: true
  });
  
  // ìœ„ì¹˜ ì¡°ì • ë° Gap ê³„ì‚°
  fixedOccupied = adjustFixedPositions(fixedOccupied, startBound, endBound);
  const gaps = calculateGaps(fixedOccupied, startBound, endBound);

  // â˜… ëª¨ë“ˆ ìƒì„± (ëª¨ë“  gapì— ë™ì¼í•œ ë„ì–´ ë„ˆë¹„ ì ìš©)
  item.modules = item.modules.filter(m => m.pos !== 'upper');
  let newModules = [];
  
  gaps.forEach(gap => {
    newModules = newModules.concat(fillGapWithModules(gap, 'upper', upperBodyH, 295, bestDoorWidth));
  });
  
  // ê³ ì • ëª¨ë“ˆ ì¶”ê°€
  fixedOccupied.forEach(fixed => {
    newModules.push({
      id: fixed.id || Date.now() + Math.random(),
      type: fixed.type, name: fixed.name, pos: 'upper',
      w: fixed.w, h: fixed.h, d: fixed.d,
      isDrawer: fixed.isDrawer || false, isEL: fixed.isEL || false,
      isFixed: true, isBase: fixed.isBase || false, _x: fixed.x
    });
  });

  // ì •ë ¬ ë° ì €ì¥
  newModules.sort((a, b) => a._x - b._x);
  newModules.forEach(m => delete m._x);
  if (!isRefLeft) newModules.reverse();
  
  item.modules = item.modules.concat(newModules);
  
  console.log(`ìƒë¶€ì¥: ë„ì–´=${bestDoorWidth}mm, ê¸°ì¤€ìƒë¶€ì¥=${finalBaseUpperW}mm, í›„ë“œoffset=${bestHoodOffset}mm, ê¸°ì¤€offset=${bestBaseOffset}mm, ì”ì—¬=${bestTotalRemainder}mm`);
}

function runAutoCalcLower(item) {
  const W = parseFloat(item.w) || 0;
  const effectiveW = getEffectiveSpace(item, 'lower');
  
  if (effectiveW <= 0) {
    alert("í•˜ë¶€ì¥ ìœ íš¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    return;
  }

  const fL = item.specs.finishLeftType !== 'None' ? (parseFloat(item.specs.finishLeftWidth) || 0) : 0;
  const startBound = fL;
  const endBound = startBound + effectiveW;
  const isRefLeft = item.specs.measurementBase === 'Left';
  
  // ì„¤ë¹„ ìœ„ì¹˜ ê³„ì‚°
  let absDistStart, absDistEnd, absVent;
  if (isRefLeft) {
    absDistStart = parseFloat(item.specs.distributorStart) || 0;
    absDistEnd = parseFloat(item.specs.distributorEnd) || 0;
    absVent = parseFloat(item.specs.ventStart) || 0;
  } else {
    const dS = parseFloat(item.specs.distributorStart) || 0;
    const dE = parseFloat(item.specs.distributorEnd) || 0;
    absDistStart = Math.min(W - dS, W - dE);
    absDistEnd = Math.max(W - dS, W - dE);
    absVent = W - (parseFloat(item.specs.ventStart) || 0);
  }

  const specLowerH = parseFloat(item.specs.lowerH) || 870;
  const specLegH = parseFloat(item.specs.sinkLegHeight) || 150;
  const defaultLowerH = specLowerH - specLegH;

  // í˜„ì¬ ê³ ì • ëª¨ë“ˆ (ê°œìˆ˜ëŒ€, ê°€ìŠ¤ëŒ€, ELì¥, LTë§ì¥, TLì¥, ìˆ˜ì •ëœ ëª¨ë“ˆ)
  const currentModules = item.modules.filter(m => m.pos === 'lower');
  
  // í•„ìˆ˜ ëª¨ë“ˆ ìœ„ì¹˜ ê³„ì‚°
  const sinkW = 1000, cookW = 600;
  
  // â˜… ê°œìˆ˜ëŒ€ ê¸°ë³¸ ìœ„ì¹˜: ë¶„ë°°ê¸°ì‹œì‘ - 100
  let sinkX = absDistStart - 100;
  
  // â˜… ê°œìˆ˜ëŒ€ ë…¼ë¦¬ ì¡°ê±´ ê²€ì¦ (ì—…ë°ì´íŠ¸)
  // ì¡°ê±´1 ì¶©ì¡±: ê°œìˆ˜ëŒ€ì‹œì‘ < ë¶„ë°°ê¸°ì‹œì‘
  // ì¡°ê±´2 ì¶©ì¡±: ê°œìˆ˜ëŒ€ë > ë¶„ë°°ê¸°ë
  
  // ì¡°ê±´1 ìœ„ë°˜ ì‹œ: ê°œìˆ˜ëŒ€ ì‹œì‘ì  = ë¶„ë°°ê¸° ì‹œì‘ì  - 100mm
  if (sinkX >= absDistStart) {
    sinkX = absDistStart - 100;
  }
  // ì¡°ê±´2 ìœ„ë°˜ ì‹œ: ê°œìˆ˜ëŒ€ ì‹œì‘ì  = ë¶„ë°°ê¸° ëì  - ê°œìˆ˜ëŒ€ ë„ˆë¹„ + 100mm
  if (sinkX + sinkW <= absDistEnd) {
    sinkX = absDistEnd - sinkW + 100;
  }
  
  // â˜… ê°œìˆ˜ëŒ€ ì´ë™ ê°€ëŠ¥ ë²”ìœ„ ê³„ì‚°
  // ì¡°ê±´1 ì¶©ì¡±: sinkX < absDistStart
  // ì¡°ê±´2 ì¶©ì¡±: sinkX + sinkW > absDistEnd â†’ sinkX > absDistEnd - sinkW
  const sinkMinX = absDistEnd - sinkW + 1;  // ì¡°ê±´2 ë§Œì¡± ìµœì†Œê°’
  const sinkMaxX = absDistStart - 1;         // ì¡°ê±´1 ë§Œì¡± ìµœëŒ€ê°’
  
  // â˜… ê°€ìŠ¤ëŒ€ ìœ„ì¹˜: í™˜í’êµ¬ ì¤‘ì•™ ì •ë ¬
  const cookX = absVent - cookW / 2;
  
  // â˜… LTë§ì¥ ìœ„ì¹˜ ê³„ì‚°
  let ltX = null, ltW = 200;
  if (item.specs.accessories.some(a => a.type === 'LTMesh')) {
    if (isRefLeft) {
      ltX = cookX + cookW;
    } else {
      ltX = cookX - ltW;
    }
  }

  // ì‚¬ìš©ì ê³ ì • ëª¨ë“ˆ í™•ì¸ (ELì¥, TLì¥, ìˆ˜ì •ëœ ëª¨ë“ˆ)
  const hasUserFixedModules = currentModules.some(m => 
    m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTë§ì¥'
  );

  // â˜… ëª¨ë“ˆ ìˆ˜ì • í›„ ì¬ê³„ì‚° ì‹œ: ê°œìˆ˜ëŒ€ ìœ„ì¹˜ ìµœì í™”
  if (hasUserFixedModules) {
    // ì‚¬ìš©ì ê³ ì • ëª¨ë“ˆ ìœ„ì¹˜ ìˆ˜ì§‘
    let userFixedModules = [];
    let tempX = startBound;
    currentModules.forEach(m => {
      if (m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTë§ì¥') {
        userFixedModules.push({ ...m, x: tempX, endX: tempX + parseFloat(m.w) });
      }
      tempX += parseFloat(m.w) || 0;
    });
    
    // ê°œìˆ˜ëŒ€ ì´ë™ ê°€ëŠ¥ ë²”ìœ„ ë‚´ì—ì„œ ìµœì  ìœ„ì¹˜ ì°¾ê¸°
    let bestSinkX = sinkX;
    let bestTotalRemainder = Infinity;
    
    // 1mm ë‹¨ìœ„ë¡œ íƒìƒ‰ (ë²”ìœ„ ë‚´ì—ì„œ)
    const searchMin = Math.max(startBound, sinkMinX);
    const searchMax = Math.min(endBound - sinkW, sinkMaxX);
    
    for (let testSinkX = searchMin; testSinkX <= searchMax; testSinkX++) {
      // ì„ì‹œ ê³ ì • ëª¨ë“ˆ ë°°ì—´ êµ¬ì„±
      let tempFixed = [
        { x: testSinkX, endX: testSinkX + sinkW },
        { x: cookX, endX: cookX + cookW }
      ];
      if (ltX !== null) {
        tempFixed.push({ x: ltX, endX: ltX + ltW });
      }
      userFixedModules.forEach(m => {
        tempFixed.push({ x: m.x, endX: m.endX });
      });
      tempFixed.sort((a, b) => a.x - b.x);
      
      // gapë“¤ì˜ ì”ì—¬ê³µê°„ í•© ê³„ì‚°
      let totalRemainder = 0;
      let cursor = startBound;
      
      for (const fixed of tempFixed) {
        if (fixed.x > cursor + 1) {
          const gapWidth = fixed.x - cursor;
          // ë…ë¦½ ë¶„ë°° ê²°ê³¼ì˜ ì”ì—¬ ê³„ì‚°
          const result = distributeModules(gapWidth);
          if (result.doorCount > 0) {
            const used = result.doorWidth * result.doorCount;
            totalRemainder += Math.abs(gapWidth - used);
          }
        }
        cursor = Math.max(cursor, fixed.endX);
      }
      if (cursor < endBound - 1) {
        const gapWidth = endBound - cursor;
        const result = distributeModules(gapWidth);
        if (result.doorCount > 0) {
          const used = result.doorWidth * result.doorCount;
          totalRemainder += Math.abs(gapWidth - used);
        }
      }
      
      // ìµœì  ìœ„ì¹˜ ì„ íƒ
      if (totalRemainder < bestTotalRemainder) {
        bestTotalRemainder = totalRemainder;
        bestSinkX = testSinkX;
      }
    }
    
    sinkX = bestSinkX;
  }

  let fixedOccupied = [
    { type: 'sink', name: 'ê°œìˆ˜ëŒ€', w: sinkW, h: defaultLowerH, d: 600, x: sinkX, endX: sinkX + sinkW, pos: 'lower', isFixed: true },
    { type: 'cook', name: 'ê°€ìŠ¤ëŒ€', w: cookW, h: defaultLowerH, d: 550, x: cookX, endX: cookX + cookW, pos: 'lower', isFixed: true }
  ];
  
  // â˜… LTë§ì¥ ì¶”ê°€
  if (ltX !== null) {
    fixedOccupied.push({ 
      type: 'storage', name: 'LTë§ì¥', w: ltW, h: defaultLowerH, d: 550, 
      x: ltX, endX: ltX + ltW, isDrawer: true, pos: 'lower', isFixed: true 
    });
  }

  // ì‚¬ìš©ì ê³ ì • ëª¨ë“ˆ ì¶”ê°€ (ELì¥, TLì¥, ìˆ˜ì •ëœ ëª¨ë“ˆ)
  let tempX2 = startBound;
  currentModules.forEach(m => {
    if (m.isFixed && !['sink', 'cook'].includes(m.type) && m.name !== 'LTë§ì¥') {
      fixedOccupied.push({ ...m, x: tempX2, endX: tempX2 + parseFloat(m.w) });
    }
    tempX2 += parseFloat(m.w) || 0;
  });

  // ìœ„ì¹˜ ì¡°ì • ë° Gap ê³„ì‚°
  fixedOccupied = adjustFixedPositions(fixedOccupied, startBound, endBound);
  
  if (fixedOccupied[0] && fixedOccupied[0].x < startBound) {
    alert("ê³µê°„ì´ ë¶€ì¡±í•˜ì—¬ í•„ìˆ˜ ì¥ì„ ë°°ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  const gaps = calculateGaps(fixedOccupied, startBound, endBound);

  // í•˜ë¶€ì¥ ì´ˆê¸°í™” í›„ ìƒˆ ëª¨ë“ˆ ìƒì„±
  item.modules = item.modules.filter(m => m.pos !== 'lower');
  let newModules = [];
  
  // hasUserFixedModulesëŠ” ì´ë¯¸ ìœ„ì—ì„œ ê³„ì‚°ë¨
  if (hasUserFixedModules) {
    // â˜… í†µí•© ë¶„ë°°: ëª¨ë“ˆ ìˆ˜ì • í›„ ì¬ê³„ì‚° ì‹œ
    // ì „ì²´ ê°€ìš© ê³µê°„ì—ì„œ í‘œì¤€ ë„ì–´ ë„ˆë¹„ ê³„ì‚°
    const totalAvailable = gaps.reduce((sum, g) => sum + g.width, 0);
    const standardResult = distributeModules(totalAvailable);
    const standardDoorWidth = standardResult.doorWidth || DOOR_TARGET_WIDTH;
    
    gaps.forEach(gap => {
      newModules = newModules.concat(fillGapWithModules(gap, 'lower', defaultLowerH, 550, standardDoorWidth));
    });
  } else {
    // â˜… ë…ë¦½ ë¶„ë°°: ì´ˆê¸° ìë™ê³„ì‚° ì‹œ
    // ê°œìˆ˜ëŒ€ ì‹œì‘ ê³µê°„ê³¼ ë ê³µê°„ ê°ê° ë…ë¦½ì ìœ¼ë¡œ ë¶„ë°°
    gaps.forEach(gap => {
      newModules = newModules.concat(fillGapWithModules(gap, 'lower', defaultLowerH, 550, null));
    });
  }
  
  // ê³ ì • ëª¨ë“ˆ ì¶”ê°€
  fixedOccupied.forEach(fixed => {
    newModules.push({
      id: fixed.id || Date.now() + Math.random(),
      type: fixed.type, name: fixed.name, pos: 'lower',
      w: fixed.w, h: fixed.h, d: fixed.d,
      isDrawer: fixed.isDrawer || false, isEL: fixed.isEL || false,
      isFixed: true, _x: fixed.x
    });
  });

  // ì •ë ¬ ë° ì €ì¥
  newModules.sort((a, b) => a._x - b._x);
  newModules.forEach(m => delete m._x);
  if (!isRefLeft) newModules.reverse();
  
  item.modules = item.modules.concat(newModules);
}

function undoAutoCalc(itemUniqueId, section) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  if (section === 'upper' && item.prevUpperModules) {
    item.modules = item.modules.filter(m => m.pos !== 'upper').concat(item.prevUpperModules);
    item.prevUpperModules = null;
  } else if (section === 'lower' && item.prevLowerModules) {
    item.modules = item.modules.filter(m => m.pos !== 'lower').concat(item.prevLowerModules);
    item.prevLowerModules = null;
  }
  renderWorkspaceContent(item);
}

// ============================================================
// UI ê´€ë ¨ í•¨ìˆ˜ë“¤
// ============================================================

function initCategoryGrid() {
  const gridEl = document.getElementById('categoryGrid');
  CATEGORIES.forEach(cat => {
    const btn = document.createElement('div');
    btn.className = 'category-card';
    btn.id = `btn-${cat.id}`;
    btn.innerHTML = `
      <div class="category-name">${cat.name}</div>
      <div class="card-stepper" onclick="event.stopPropagation()">
        <button class="stepper-btn" onclick="decrementCategory('${cat.id}')">ï¼</button>
        <span class="stepper-count" id="count-${cat.id}">0</span>
        <button class="stepper-btn" onclick="incrementCategory('${cat.id}')">ï¼‹</button>
      </div>
    `;
    btn.addEventListener('click', () => incrementCategory(cat.id));
    gridEl.appendChild(btn);
  });
}

function incrementCategory(catId) {
  const cat = CATEGORIES.find(c => c.id === catId);
  const specLegH = 150;
  const specLowerH = 870;
  const specUpperH = 720;
  const lowerBodyH = specLowerH - specLegH;
  const upperBodyH = specUpperH - 20;
  
  const newItem = {
    uniqueId: Date.now() + Math.random(),
    categoryId: cat.id,
    name: cat.name,
    defaultD: cat.defaultD,
    w: '', h: '', d: '', image: null,
    specs: JSON.parse(JSON.stringify(DEFAULT_SPECS)),
    modules: [],
    prevUpperModules: null,
    prevLowerModules: null
  };
  
  // â˜… ë¶™ë°•ì´ì¥: ê¸°ë³¸ ë§ˆê°ì„ ëª°ë”©ìœ¼ë¡œ ì„¤ì •
  if (cat.id === 'wardrobe') {
    newItem.specs.finishLeftType = 'Molding';
    newItem.specs.finishRightType = 'Molding';
  }
  
  // â˜… ëƒ‰ì¥ê³ ì¥: ê·œì¹™ ê¸°ë°˜ ì´ˆê¸°í™” (ì—…ë°ì´íŠ¸)
  if (cat.id === 'fridge') {
    newItem.specs.fridgeBrand = 'LG';
    newItem.specs.fridgeMoldingH = FRIDGE_RULES.MOLDING_H;   // ìƒëª°ë”© ë†’ì´
    newItem.specs.fridgePedestal = FRIDGE_RULES.PEDESTAL_H;  // ì¢ŒëŒ€ ë†’ì´
    newItem.specs.fridgeModuleD = FRIDGE_RULES.MODULE_D;     // ëª¨ë“ˆ ê¹Šì´ ê¸°ë³¸ 550
    newItem.specs.finishLeftType = 'molding';   // ëª°ë”© ê¸°ë³¸
    newItem.specs.finishRightType = 'molding';  // ëª°ë”© ê¸°ë³¸
    newItem.specs.finishLeftWidth = 60;
    newItem.specs.finishRightWidth = 60;
    // ìë™ê³„ì‚° ê´€ë ¨
    newItem.specs.autoCalculated = false;
  }
  
  if (cat.id === 'sink') {
    newItem.modules = [
      { id: 1, type: 'sink', name: 'ê°œìˆ˜ëŒ€', pos: 'lower', w: 1000, h: lowerBodyH, d: 600, isDrawer: false, isEL: false, isFixed: true },
      { id: 2, type: 'cook', name: 'ê°€ìŠ¤ëŒ€', pos: 'lower', w: 600, h: lowerBodyH, d: 550, isDrawer: false, isEL: false, isFixed: true },
      { id: 3, type: 'storage', name: 'LTë§ì¥', pos: 'lower', w: 200, h: lowerBodyH, d: 550, isDrawer: true, isEL: false, isFixed: true },
      { id: 4, type: 'hood', name: 'í›„ë“œì¥', pos: 'upper', w: 800, h: upperBodyH - 40, d: 295, isDrawer: false, isEL: false, isFixed: true }
    ];
  }
  
  selectedItems.push(newItem);
  updateUI();
}

function decrementCategory(catId) {
  const targets = selectedItems.filter(item => item.categoryId === catId);
  if (targets.length > 0) removeInstance(targets[targets.length - 1].uniqueId);
}

function removeInstance(uniqueId) {
  selectedItems = selectedItems.filter(item => item.uniqueId !== uniqueId);
  updateUI();
}

function updateUI() {
  const container = document.getElementById('dynamicInputList');
  const detailSection = document.getElementById('detailInputSection');
  
  detailSection.style.display = selectedItems.length > 0 ? 'block' : 'none';

  CATEGORIES.forEach(cat => {
    const count = selectedItems.filter(item => item.categoryId === cat.id).length;
    document.getElementById(`count-${cat.id}`).innerText = count;
    const btn = document.getElementById(`btn-${cat.id}`);
    btn.classList.toggle('active', count > 0);
  });

  const typeCounter = {};
  container.innerHTML = '';
  
  selectedItems.forEach(item => {
    typeCounter[item.categoryId] = (typeCounter[item.categoryId] || 0) + 1;
    item.labelName = `${item.name} #${typeCounter[item.categoryId]}`;
    
    if (item.specs.layoutShape === 'I' && !item.specs.topSizes[0] && item.w && item.d) {
      item.specs.topSizes[0] = `${item.w} x ${item.d}`;
    }

    const sinkInputs = item.categoryId === 'sink' ? `
      <div class="extra-settings">
        <div class="extra-title">Layout & ì„¤ë¹„ ì„¤ì •</div>
        <div class="input-row">
          <div class="input-group"><label>êµ¬ì¡° í˜•íƒœ</label>
            <select onchange="changeLayoutShape(${item.uniqueId}, this.value)">
              <option value="I" ${item.specs.layoutShape==='I'?'selected':''}>ã…¡ìí˜•</option>
              <option value="L" ${item.specs.layoutShape==='L'?'selected':''}>ã„±ìí˜•</option>
              <option value="U" ${item.specs.layoutShape==='U'?'selected':''}>ã„·ìí˜•</option>
            </select>
          </div>
          <div class="input-group"><label>ì‹¤ì¸¡ ê¸°ì¤€</label>
            <select onchange="updateSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${item.specs.measurementBase==='Left'?'selected':''}>ì¢Œì¸¡</option>
              <option value="Right" ${item.specs.measurementBase==='Right'?'selected':''}>ìš°ì¸¡</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>ë¶„ë°°ê¸° ì‹œì‘(mm)</label><input type="number" value="${item.specs.distributorStart}" oninput="updateSpec(${item.uniqueId}, 'distributorStart', this.value)"></div>
          <div class="input-group"><label>ë¶„ë°°ê¸° ë(mm)</label><input type="number" value="${item.specs.distributorEnd}" oninput="updateSpec(${item.uniqueId}, 'distributorEnd', this.value)"></div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>í™˜í’êµ¬ ìœ„ì¹˜(mm)</label><input type="number" value="${item.specs.ventStart}" oninput="updateSpec(${item.uniqueId}, 'ventStart', this.value)"></div>
        </div>
      </div>
    ` : '';

    // â˜… ë¶™ë°•ì´ì¥ ì „ìš© ì…ë ¥ í¼
    const wardrobeInputs = item.categoryId === 'wardrobe' ? `
      <div class="extra-settings">
        <div class="extra-title">ë¶™ë°•ì´ì¥ ì„¤ì •</div>
        <div class="input-row">
          <div class="input-group"><label>ì‹¤ì¸¡ ê¸°ì¤€</label>
            <select onchange="updateSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${item.specs.measurementBase==='Left'?'selected':''}>ì¢Œì¸¡</option>
              <option value="Right" ${item.specs.measurementBase==='Right'?'selected':''}>ìš°ì¸¡</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>ì»¤íŠ¼ë°•ìŠ¤ ê°€ë¡œ(mm)</label><input type="number" value="${item.specs.curtainBoxW || ''}" placeholder="0" oninput="updateSpec(${item.uniqueId}, 'curtainBoxW', this.value)"></div>
          <div class="input-group"><label>ì»¤íŠ¼ë°•ìŠ¤ ë†’ì´(mm)</label><input type="number" value="${item.specs.curtainBoxH || ''}" placeholder="0" oninput="updateSpec(${item.uniqueId}, 'curtainBoxH', this.value)"></div>
        </div>
      </div>
    ` : '';

    // â˜… ëƒ‰ì¥ê³ ì¥ ì „ìš© ì…ë ¥ í¼ (ê·œì¹™ ê¸°ë°˜)
    const fridgeInputs = item.categoryId === 'fridge' ? `
      <div class="extra-settings">
        <div class="extra-title">ğŸ§Š ëƒ‰ì¥ê³ ì¥ ê¸°ë³¸ ì„¤ì •</div>
        <div class="input-row">
          <div class="input-group"><label>ë¸Œëœë“œ</label>
            <select onchange="updateSpec(${item.uniqueId}, 'fridgeBrand', this.value)">
              <option value="LG" ${item.specs.fridgeBrand==='LG'?'selected':''}>LG</option>
              <option value="Samsung" ${item.specs.fridgeBrand==='Samsung'?'selected':''}>ì‚¼ì„±</option>
            </select>
          </div>
          <div class="input-group"><label>ìƒëª°ë”© ë†’ì´(mm)</label>
            <input type="number" value="${item.specs.fridgeMoldingH || 50}" oninput="updateSpec(${item.uniqueId}, 'fridgeMoldingH', this.value)">
          </div>
        </div>
        <div style="font-size:10px;color:#666;margin-top:4px;">
          â€» ìƒë¶€ì¥ ë„ì–´H = ì‹¤ì¸¡H - ëƒ‰ì¥ê³ H - 15 - ìƒëª°ë”©H (ìµœëŒ€ 400mm)
        </div>
      </div>
    ` : '';

    const imageHtml = item.image ? `<img src="${item.image}" alt="preview">` : `<div style="font-size:20px;">ğŸ“·</div><div>ì‚¬ì§„</div>`;

    const card = document.createElement('div');
    card.className = 'item-input-card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
        <div style="font-weight:bold;color:var(--primary-color);">${item.labelName}</div>
        <button class="btn-delete" onclick="removeInstance(${item.uniqueId})">Ã—</button>
      </div>
      <div class="item-body">
        <div class="input-section">
          <div class="input-row">
            <div class="input-group"><label>ê°€ë¡œ(W)</label><input type="number" placeholder="mm" value="${item.w}" oninput="updateItemValue(${item.uniqueId}, 'w', this.value)"></div>
            <div class="input-group"><label>ë†’ì´(H)</label><input type="number" placeholder="mm" value="${item.h}" oninput="updateItemValue(${item.uniqueId}, 'h', this.value)"></div>
            <div class="input-group"><label>ê¹Šì´(D)</label><input type="number" placeholder="mm" value="${item.d || item.defaultD || ''}" oninput="updateItemValue(${item.uniqueId}, 'd', this.value)"></div>
          </div>
          ${sinkInputs}
          ${wardrobeInputs}
          ${fridgeInputs}
        </div>
        <div class="photo-section">
          <label>í˜„ì¥ ì‚¬ì§„</label>
          <div class="photo-box" onclick="document.getElementById('file-${item.uniqueId}').click()">${imageHtml}</div>
          <input type="file" id="file-${item.uniqueId}" class="file-input-hidden" accept="image/*" onchange="handleItemPhoto(${item.uniqueId}, event)">
        </div>
      </div>
    `;
    container.appendChild(card);
    if (!item.d && item.defaultD > 0) item.d = item.defaultD;
  });

  document.getElementById('btnNext').disabled = selectedItems.length === 0 || !selectedItems.every(item => item.w && item.h && item.d);
  document.getElementById('aiGuideText').innerHTML = selectedItems.length > 0 ? `ì´ <strong>${selectedItems.length}ê°œ</strong>ì˜ ê°€êµ¬ ì„¤ì • ì¤‘...` : "ê°€êµ¬ë¥¼ ì¶”ê°€í•˜ë©´ ì…ë ¥ì°½ì´ ìƒì„±ë©ë‹ˆë‹¤.";
}

function updateItemValue(uniqueId, field, value) {
  const target = selectedItems.find(item => item.uniqueId === uniqueId);
  if (target) {
    target[field] = value;
    if (target.specs.layoutShape === 'I' && (field === 'w' || field === 'd')) {
      target.specs.topSizes[0] = `${target.w} x ${target.d}`;
    }
    // â˜… ë¶™ë°•ì´ì¥: ê°€ë¡œ(W) ë³€ê²½ ì‹œ ìœ íš¨ê³µê°„ ìë™ ì¬ê³„ì‚°
    if (target.categoryId === 'wardrobe' && field === 'w') {
      const W = parseFloat(value) || 0;
      const fL = target.specs.finishLeftType !== 'None' ? (parseFloat(target.specs.finishLeftWidth) || 0) : 0;
      const fR = target.specs.finishRightType !== 'None' ? (parseFloat(target.specs.finishRightWidth) || 0) : 0;
      target.specs.wardrobeEffectiveW = W - fL - fR;
    }
    document.getElementById('btnNext').disabled = !selectedItems.every(item => item.w && item.h && item.d);
  }
}

function handleItemPhoto(uniqueId, event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const target = selectedItems.find(item => item.uniqueId === uniqueId);
      if (target) { target.image = e.target.result; updateUI(); }
    };
    reader.readAsDataURL(file);
  }
}

function goToStep2() {
  document.getElementById('step1-content').style.display = 'none';
  document.getElementById('step2-content').style.display = 'block';
  document.getElementById('step-dot-1').classList.remove('active');
  document.getElementById('step-dot-2').classList.add('active');
  renderBookmarks();
}

function backToStep1() {
  document.getElementById('step1-content').style.display = 'block';
  document.getElementById('step2-content').style.display = 'none';
  document.getElementById('step-dot-1').classList.add('active');
  document.getElementById('step-dot-2').classList.remove('active');
  updateUI();
}

function renderBookmarks() {
  const tabsContainer = document.getElementById('bookmarkTabs');
  tabsContainer.innerHTML = '';
  selectedItems.forEach((item, index) => {
    const tab = document.createElement('div');
    tab.className = 'bookmark-tab' + (index === 0 ? ' active' : '');
    tab.innerText = item.labelName;
    tab.onclick = () => {
      document.querySelectorAll('.bookmark-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentItemId = item.uniqueId;
      renderWorkspaceContent(item);
    };
    tabsContainer.appendChild(tab);
  });
  if (selectedItems.length > 0) {
    currentItemId = selectedItems[0].uniqueId;
    renderWorkspaceContent(selectedItems[0]);
  }
}

function renderWorkspaceContent(item) {
  const ws = document.getElementById('designWorkspace');
  
  // â˜… ë¶™ë°•ì´ì¥ì¸ ê²½ìš° ë³„ë„ ë Œë”ë§
  if (item.categoryId === 'wardrobe') {
    renderWardrobeWorkspace(item);
    return;
  }
  
  // â˜… ëƒ‰ì¥ê³ ì¥ì¸ ê²½ìš° ë³„ë„ ë Œë”ë§
  if (item.categoryId === 'fridge') {
    renderFridgeWorkspace(item);
    return;
  }
  
  const upperModules = item.modules.filter(m => m.pos === 'upper');
  const lowerModules = item.modules.filter(m => m.pos === 'lower');
  
  const autoEffectiveW = calcEffectiveSpace(item);
  const upperEffectiveW = getEffectiveSpace(item, 'upper');
  const lowerEffectiveW = getEffectiveSpace(item, 'lower');
  
  const upperUsedW = upperModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
  const lowerUsedW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
  const upperRemaining = upperEffectiveW - upperUsedW;
  const lowerRemaining = lowerEffectiveW - lowerUsedW;

  const renderModuleCard = (mod, idx, section, totalCount) => {
    const icons = { sink: 'ğŸš°', cook: 'ğŸ”¥', hood: 'ğŸŒ€', tall: 'â†•ï¸', storage: mod.pos === 'upper' ? 'â¬†ï¸' : 'â¬‡ï¸' };
    const icon = icons[mod.type] || 'ğŸ“¦';
    const isTall = mod.type === 'tall';
    const isBase = mod.isBase;  // â˜… ê¸°ì¤€ ëª¨ë“ˆ í™•ì¸
    
    const options = mod.pos === 'lower' && (mod.type === 'storage' || mod.type === 'tall') ? `
      <div class="module-options">
        <label class="module-chk"><input type="checkbox" ${mod.isDrawer ? 'checked' : ''} onchange="toggleOption(${item.uniqueId}, ${mod.id}, 'isDrawer', this.checked)"> ì„œëì¥</label>
        <label class="module-chk"><input type="checkbox" ${mod.isEL ? 'checked' : ''} onchange="toggleOption(${item.uniqueId}, ${mod.id}, 'isEL', this.checked)"> ELì¥</label>
        ${isTall ? `<div style="margin-top:4px;display:flex;gap:8px;">
          <label class="module-chk">ë„ì–´ìˆ˜: <input type="number" style="width:40px;padding:2px;font-size:11px;border:1px solid #ddd;border-radius:3px;" value="${mod.doorCount || 1}" onchange="updateModuleDetail(${item.uniqueId}, ${mod.id}, 'doorCount', this.value)"></label>
          <label class="module-chk">ELìˆ˜: <input type="number" style="width:40px;padding:2px;font-size:11px;border:1px solid #ddd;border-radius:3px;" value="${mod.elCount || 0}" onchange="updateModuleDetail(${item.uniqueId}, ${mod.id}, 'elCount', this.value)"></label>
        </div>` : ''}
      </div>
    ` : '';

    // â˜… í´ë˜ìŠ¤ ê²°ì •: í‚¤í°ì¥ > ê¸°ì¤€ëª¨ë“ˆ > ê³ ì •ëª¨ë“ˆ
    let cardClass = 'module-card';
    if (isTall) cardClass += ' tall-type';
    else if (isBase) cardClass += ' base-module';
    else if (mod.isFixed) cardClass += ' fixed-module';

    return `
      <div class="${cardClass}" data-module-id="${mod.id}">
        <div class="move-buttons">
          <button class="btn-move" onclick="moveModule(${item.uniqueId}, ${mod.id}, 'up')" ${idx === 0 ? 'disabled' : ''}>â–²</button>
          <button class="btn-move" onclick="moveModule(${item.uniqueId}, ${mod.id}, 'down')" ${idx === totalCount - 1 ? 'disabled' : ''}>â–¼</button>
        </div>
        <div class="module-icon">${icon}</div>
        <div class="module-info">
          <div class="module-header">
            <span class="module-title">${mod.name}</span>
            ${isTall ? '<span class="module-type-badge">í‚¤í°ì¥</span>' : ''}
          </div>
          <div class="module-dims">
            <div class="dim-group"><label class="dim-label">W</label><input type="number" class="dim-input" value="${mod.w}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'w', this.value)"></div>
            <div class="dim-group"><label class="dim-label">H</label><input type="number" class="dim-input" value="${mod.h}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'h', this.value)"></div>
            <div class="dim-group"><label class="dim-label">D</label><input type="number" class="dim-input" value="${mod.d}" onchange="updateModuleDim(${item.uniqueId}, ${mod.id}, 'd', this.value)"></div>
          </div>
          ${options}
        </div>
        <button class="btn-delete-module" onclick="removeModule(${item.uniqueId}, ${mod.id})">Ã—</button>
      </div>
    `;
  };

  const upperModulesHtml = upperModules.map((m, i) => renderModuleCard(m, i, 'upper', upperModules.length)).join('');
  const lowerModulesHtml = lowerModules.map((m, i) => renderModuleCard(m, i, 'lower', lowerModules.length)).join('');
  
  const upperEffDisplay = item.specs.effectiveUpperW !== null ? item.specs.effectiveUpperW : Math.round(autoEffectiveW);
  const lowerEffDisplay = item.specs.effectiveLowerW !== null ? item.specs.effectiveLowerW : Math.round(autoEffectiveW);

  // ë§ˆê° ì„¤ì •
  let cornerHtml = '';
  if (item.specs.layoutShape === 'L') {
    cornerHtml = `<div class="spec-row"><div class="spec-field"><label>ì½”ë„ˆ ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner1Type', this.value)"><option value="Filler" ${item.specs.finishCorner1Type==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishCorner1Type==='Molding'?'selected':''}>ëª°ë”©</option></select></div><div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishCorner1Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner1Width', this.value)"></div></div>`;
  } else if (item.specs.layoutShape === 'U') {
    cornerHtml = `<div class="spec-row"><div class="spec-field"><label>ì½”ë„ˆ1 ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner1Type', this.value)"><option value="Filler" ${item.specs.finishCorner1Type==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishCorner1Type==='Molding'?'selected':''}>ëª°ë”©</option></select></div><div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishCorner1Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner1Width', this.value)"></div></div>
    <div class="spec-row"><div class="spec-field"><label>ì½”ë„ˆ2 ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishCorner2Type', this.value)"><option value="Filler" ${item.specs.finishCorner2Type==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishCorner2Type==='Molding'?'selected':''}>ëª°ë”©</option></select></div><div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishCorner2Width}" onblur="updateSpecValue(${item.uniqueId}, 'finishCorner2Width', this.value)"></div></div>`;
  }

  const shapes = { 'I': 'ã…¡ìí˜• (1ê°œ)', 'L': 'ã„±ìí˜• (2ê°œ)', 'U': 'ã„·ìí˜• (3ê°œ)' };
  const topCount = item.specs.layoutShape === 'U' ? 3 : (item.specs.layoutShape === 'L' ? 2 : 1);
  let topSizeInputs = '';
  for (let i = 0; i < topCount; i++) {
    topSizeInputs += `<input type="text" placeholder="W x D" value="${item.specs.topSizes[i] || ''}" oninput="updateTopSize(${item.uniqueId}, ${i}, this.value)" style="margin-bottom:4px;">`;
  }

  const accHtml = item.specs.accessories.map(acc => `
    <div class="acc-item">
      <select style="flex:1;" onchange="updateAccessory(${item.uniqueId}, ${acc.id}, this.value)">
        <option value="LTMesh" ${acc.type === 'LTMesh' ? 'selected' : ''}>LTë§ì¥</option>
        <option value="CircleMesh" ${acc.type === 'CircleMesh' ? 'selected' : ''}>ì›ë§ì¥</option>
        <option value="Cutlery" ${acc.type === 'Cutlery' ? 'selected' : ''}>ìˆ˜ì €ë¶„ë¦¬í•¨</option>
        <option value="Knife" ${acc.type === 'Knife' ? 'selected' : ''}>ì¹¼ê½‚ì´</option>
        <option value="DishRack" ${acc.type === 'DishRack' ? 'selected' : ''}>ì‹ê¸°ê±´ì¡°ëŒ€</option>
        <option value="Etc" ${acc.type === 'Etc' ? 'selected' : ''}>ê¸°íƒ€</option>
      </select>
      <button class="btn-del-acc" onclick="removeAccessory(${item.uniqueId}, ${acc.id})">Ã—</button>
    </div>
  `).join('');

  ws.innerHTML = `
    <div class="ws-header">
      <div class="ws-title">${item.labelName} ìƒì„¸ ì„¤ê³„ <span class="ws-info-badge">W ${item.w} x H ${item.h} x D ${item.d}</span></div>
      <button style="background:var(--primary-color);color:white;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" onclick="alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')">ì„¤ê³„ ì €ì¥</button>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">1. Dimensions (ì¹˜ìˆ˜)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒë¶€ì¥ ë†’ì´</label><input type="number" value="${item.specs.upperH}" onblur="updateSpecValue(${item.uniqueId}, 'upperH', this.value)"></div>
          <div class="spec-field"><label>í•˜ë¶€ì¥ ë†’ì´</label><input type="number" value="${item.specs.lowerH}" onblur="updateSpecValue(${item.uniqueId}, 'lowerH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ë‹¤ë¦¬ë°œ ë†’ì´</label>
            <select id="legHeight-${item.uniqueId}" onchange="updateSpec(${item.uniqueId}, 'sinkLegHeight', this.value)">
              <option value="120" ${item.specs.sinkLegHeight==120?'selected':''}>120mm</option>
              <option value="150" ${item.specs.sinkLegHeight==150?'selected':''}>150mm</option>
            </select>
          </div>
        </div>

        <div class="spec-group-title">2. Hardware</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì†ì¡ì´</label><select><option>ì°¬ë„¬ (ëª©ì°¬ë„¬)</option><option>Cì°¬ë„¬</option><option>ìŠ¤ë§ˆíŠ¸ë°”</option><option>í‘¸ì‰¬ ë„ì–´</option></select></div>
          <div class="spec-field"><label>ì”½í¬ë³¼</label><select><option>ì‚¬ê°ë³¼ 850</option><option>ì‚¬ê°ë³¼ 800</option><option>ë¼ìš´ë“œë³¼</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìˆ˜ì „</label><select><option>ê±°ìœ„ëª© ìˆ˜ì „</option><option>ã„±ì ìˆ˜ì „</option><option>ì¼ë°˜ ìˆ˜ì „</option></select></div>
          <div class="spec-field"><label>í›„ë“œ</label><select><option>íˆë“  í›„ë“œ</option><option>ì¹¨ë‹ˆ í›„ë“œ</option><option>ìŠ¬ë¼ì´ë”© í›„ë“œ</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¿¡íƒ‘</label><select><option>ì¸ë•ì…˜</option><option>ê°€ìŠ¤ì¿¡íƒ‘</option><option>í•˜ì´ë¼ì´íŠ¸</option></select></div>
          <div class="spec-field"><label>ì‹ê¸°ì„¸ì²™ê¸°</label>
            <select onchange="onDishwasherChange(${item.uniqueId}, this.value)">
              <option value="None" ${item.specs.dishwasher==='None'?'selected':''}>ì—†ìŒ</option>
              <option value="BuiltIn" ${item.specs.dishwasher==='BuiltIn'?'selected':''}>ë¹ŒíŠ¸ì¸</option>
              <option value="FreeStanding" ${item.specs.dishwasher==='FreeStanding'?'selected':''}>í”„ë¦¬ìŠ¤íƒ ë”©</option>
            </select>
          </div>
        </div>
        <div class="spec-row">
          <div class="spec-field">
            <label>ì•¡ì„¸ì„œë¦¬</label>
            <div class="acc-list">${accHtml}</div>
            <button class="btn-add-acc" onclick="addAccessory(${item.uniqueId})">+ ì•¡ì„¸ì„œë¦¬ ì¶”ê°€</button>
          </div>
        </div>

        <div class="spec-group-title">3. Colors (ë„ì–´)</div>
        <div class="spec-row"><div class="spec-field"><label>ìƒë¶€ì¥ ë„ì–´</label><div class="color-select-row"><select><option>ë¬´ê´‘</option><option>ìœ ê´‘</option></select><select><option>í™”ì´íŠ¸</option><option>ê·¸ë ˆì´</option><option>ë² ì´ì§€</option><option>ë„¤ì´ë¹„</option><option>ë¸”ë™</option></select></div></div></div>
        <div class="spec-row"><div class="spec-field"><label>í•˜ë¶€ì¥ ë„ì–´</label><div class="color-select-row"><select><option>ë¬´ê´‘</option><option>ìœ ê´‘</option></select><select><option>í™”ì´íŠ¸</option><option>ê·¸ë ˆì´</option><option>ë² ì´ì§€</option><option>ë„¤ì´ë¹„</option><option>ë¸”ë™</option></select></div></div></div>

        <div class="spec-group-title">4. Countertop (ìƒíŒ)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒíŒ ìƒ‰ìƒ</label><input type="text" value="${item.specs.topColor}"></div>
          <div class="spec-field"><label>ìƒíŒ ë‘ê»˜(T)</label><input type="number" value="${item.specs.topThickness}"></div>
        </div>
        <div class="spec-row"><div class="spec-field"><label>ìƒíŒ í¬ê¸° (${shapes[item.specs.layoutShape]})</label>${topSizeInputs}</div></div>

        <div class="spec-group-title">5. Finish Settings (ë§ˆê°)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒëª°ë”© ë†’ì´</label><input type="number" value="${item.specs.moldingH}" onblur="updateSpecValue(${item.uniqueId}, 'moldingH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¢Œì¸¡ ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishLeftType', this.value)"><option value="Filler" ${item.specs.finishLeftType==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishLeftType==='Molding'?'selected':''}>ëª°ë”©</option><option value="None" ${item.specs.finishLeftType==='None'?'selected':''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishLeftWidth}" onblur="updateSpecValue(${item.uniqueId}, 'finishLeftWidth', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìš°ì¸¡ ë§ˆê°</label><select onchange="updateSpecNoRender(${item.uniqueId}, 'finishRightType', this.value)"><option value="Filler" ${item.specs.finishRightType==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishRightType==='Molding'?'selected':''}>ëª°ë”©</option><option value="None" ${item.specs.finishRightType==='None'?'selected':''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishRightWidth}" onblur="updateSpecValue(${item.uniqueId}, 'finishRightWidth', this.value)"></div>
        </div>
        ${cornerHtml ? `<div class="spec-group-title">Corner Settings (ì½”ë„ˆ)</div>${cornerHtml}` : ''}
      </div>

      <div class="module-panel">
        <div class="module-section">
          <div class="module-section-header upper">
            <div class="section-title-row"><span>â¬†ï¸ ìƒë¶€ì¥ ëª¨ë“ˆ</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>ìœ íš¨ê³µê°„:</label>
                <input type="number" class="effective-space-input" value="${upperEffDisplay}" onblur="onEffectiveSpaceBlur(${item.uniqueId}, 'upper', this)"><span>mm</span>
              </div>
              <span class="section-remaining" style="color:${getRemainColor(upperRemaining)}">ì”ì—¬: ${Math.round(upperRemaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-undo" onclick="undoAutoCalc(${item.uniqueId}, 'upper')" ${item.prevUpperModules ? '' : 'disabled'}>â†© ë˜ëŒë¦¬ê¸°</button>
                <button class="btn-section-auto" onclick="runAutoCalcSection(${item.uniqueId}, 'upper')">âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="module-list ${upperModules.length === 0 ? 'empty-list' : ''}">${upperModulesHtml}</div>
        </div>

        <div class="module-section">
          <div class="module-section-header lower">
            <div class="section-title-row"><span>â¬‡ï¸ í•˜ë¶€ì¥ ëª¨ë“ˆ</span><span style="font-size:10px;color:#888;">(í‚¤í°ì¥ í¬í•¨)</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>ìœ íš¨ê³µê°„:</label>
                <input type="number" class="effective-space-input" value="${lowerEffDisplay}" onblur="onEffectiveSpaceBlur(${item.uniqueId}, 'lower', this)"><span>mm</span>
              </div>
              <span class="section-remaining" style="color:${getRemainColor(lowerRemaining)}">ì”ì—¬: ${Math.round(lowerRemaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-undo" onclick="undoAutoCalc(${item.uniqueId}, 'lower')" ${item.prevLowerModules ? '' : 'disabled'}>â†© ë˜ëŒë¦¬ê¸°</button>
                <button class="btn-section-auto" onclick="runAutoCalcSection(${item.uniqueId}, 'lower')">âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="module-list ${lowerModules.length === 0 ? 'empty-list' : ''}">${lowerModulesHtml}</div>
        </div>
        
        <div class="module-btn-group">
          <button class="btn-add-split btn-add-upper" onclick="addStorageModule(${item.uniqueId}, 'upper')">+ ìƒë¶€ì¥</button>
          <button class="btn-add-split btn-add-lower" onclick="addStorageModule(${item.uniqueId}, 'lower')">+ í•˜ë¶€ì¥</button>
          <button class="btn-add-split btn-add-tall" onclick="addTallModule(${item.uniqueId})">+ í‚¤í°ì¥(TL)</button>
        </div>
      </div>
    </div>
  `;
}

// ============================================================
// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ë“¤
// ============================================================

// â˜… ë¶™ë°•ì´ì¥ ì „ìš© ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë Œë”ë§
function renderWardrobeWorkspace(item) {
  const ws = document.getElementById('designWorkspace');
  const W = parseFloat(item.w) || 0;
  const H = parseFloat(item.h) || 0;
  const D = parseFloat(item.d) || 0;
  const curtainW = parseFloat(item.specs.curtainBoxW) || 0;
  const curtainH = parseFloat(item.specs.curtainBoxH) || 0;
  const isRefLeft = item.specs.measurementBase === 'Left';
  
  // ëª¨ë“ˆ ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ê¸°ë³¸ ëª¨ë“ˆ ìƒì„±)
  if (!item.modules || item.modules.length === 0) {
    item.modules = [];
  }
  
  const wardrobeModules = item.modules.filter(m => m.pos === 'wardrobe');
  const usedW = wardrobeModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
  // â˜… ìœ íš¨ê³µê°„: ì§ì ‘ ì…ë ¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ê³„ì‚°
  const autoEffectiveW = W - (item.specs.finishLeftType !== 'None' ? parseFloat(item.specs.finishLeftWidth) || 0 : 0) 
                       - (item.specs.finishRightType !== 'None' ? parseFloat(item.specs.finishRightWidth) || 0 : 0);
  const effectiveW = item.specs.wardrobeEffectiveW || autoEffectiveW;
  const remaining = effectiveW - usedW;
  
  // Front View SVG ìƒì„± (í™•ëŒ€ ë° í•˜ë‹¨ ì—¬ë°± ì¶”ê°€)
  const svgWidth = 650;
  const svgHeight = 450;
  const scale = Math.min((svgWidth - 100) / W, (svgHeight - 100) / H);
  const drawW = W * scale;
  const drawH = H * scale;
  const offsetX = (svgWidth - drawW) / 2;
  const offsetY = 40;  // ìƒë‹¨ ì—¬ë°± ê³ ì •
  
  // ëª¨ë“ˆ SVG ê·¸ë¦¬ê¸°
  let moduleSvg = '';
  let currentX = isRefLeft ? 0 : W;
  
  // ì¢Œì¸¡ ë§ˆê°
  const fL = item.specs.finishLeftType !== 'None' ? (parseFloat(item.specs.finishLeftWidth) || 0) : 0;
  const fR = item.specs.finishRightType !== 'None' ? (parseFloat(item.specs.finishRightWidth) || 0) : 0;
  
  if (fL > 0) {
    moduleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${fL * scale}" height="${drawH}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + fL * scale / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#666">${fL}</text>`;
  }
  
  // ì»¤íŠ¼ë°•ìŠ¤ í‘œì‹œ
  let curtainSvg = '';
  if (curtainW > 0 && curtainH > 0) {
    const cbX = isRefLeft ? offsetX + fL * scale : offsetX + drawW - fR * scale - curtainW * scale;
    curtainSvg = `<rect x="${cbX}" y="${offsetY}" width="${curtainW * scale}" height="${curtainH * scale}" fill="#ffe4b5" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4"/>
      <text x="${cbX + curtainW * scale / 2}" y="${offsetY + curtainH * scale / 2 + 4}" text-anchor="middle" font-size="10" fill="#b45309">ì»¤íŠ¼ë°•ìŠ¤</text>`;
  }
  
  // ëª¨ë“ˆ ê·¸ë¦¬ê¸° (ìƒë¶€ì¥/í•˜ë¶€ì¥ êµ¬ë¶„) + ì˜·ë´‰/ì„ ë°˜/ì„œë
  let moduleStartX = offsetX + fL * scale;
  const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
  const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
  const totalModuleH = H - pedestalH - moldingH;
  const PANEL_THICKNESS = 15; // ì²œíŒ/ì§€íŒ/ì„ ë°˜ ë‘ê»˜
  const ROD_OFFSET = 75; // ì˜·ë´‰ ìœ„ì¹˜: ìƒë‹¨ì—ì„œ -75mm
  const LONG_FIRST_SHELF = 315; // ê¸´ì˜· ì²« ì„ ë°˜: ìƒë‹¨ì—ì„œ -315mm
  const DRAWER_HEIGHT = 180; // ì„œë ë†’ì´
  const SMARTBAR_WIDTH = 30; // ìŠ¤ë§ˆíŠ¸ë°” ë„ˆë¹„
  const handleType = item.specs.handleType || 'bar';
  
  // ì„ ë°˜ ìœ„ì¹˜ ê³„ì‚° í•¨ìˆ˜ (ì¼ë°˜): (ëª¨ë“ˆë†’ì´ - ì²œíŒ(15) - ì§€íŒ(15) - ì„ ë°˜ê°¯ìˆ˜*15) / (ì„ ë°˜ê°¯ìˆ˜+1)
  const calcShelfPositions = (moduleH, shelfCount, startY, scale) => {
    if (shelfCount <= 0) return [];
    const usableH = moduleH - PANEL_THICKNESS * 2 - shelfCount * PANEL_THICKNESS;
    const spacing = usableH / (shelfCount + 1);
    const positions = [];
    for (let i = 1; i <= shelfCount; i++) {
      const shelfY = startY + PANEL_THICKNESS * scale + (i * spacing + (i-1) * PANEL_THICKNESS) * scale;
      positions.push(shelfY);
    }
    return positions;
  };
  
  // ê¸´ì˜·ìš© ì„ ë°˜ ìœ„ì¹˜ ê³„ì‚° (ì²« ì„ ë°˜ì€ ìƒë‹¨ì—ì„œ -315mm)
  const calcLongShelfPositions = (moduleH, shelfCount, startY, scale) => {
    if (shelfCount <= 0) return [];
    const positions = [];
    // ì²« ì„ ë°˜: ìƒë‹¨ì—ì„œ -315mm
    const firstShelfY = startY + LONG_FIRST_SHELF * scale;
    positions.push(firstShelfY);
    
    if (shelfCount > 1) {
      // ë‚˜ë¨¸ì§€ ì„ ë°˜: ì²« ì„ ë°˜ ì•„ë˜ ê· ë“± ë¶„ë°°
      const remainingH = moduleH - LONG_FIRST_SHELF - PANEL_THICKNESS;
      const spacing = remainingH / shelfCount;
      for (let i = 2; i <= shelfCount; i++) {
        const shelfY = firstShelfY + (i - 1) * spacing * scale;
        positions.push(shelfY);
      }
    }
    return positions;
  };
  
  // ì„œë ê·¸ë¦¬ê¸° í•¨ìˆ˜
  const drawDrawers = (x, y, w, drawerCount, isExternal, scale) => {
    if (drawerCount <= 0) return '';
    let svg = '';
    const drawerH = DRAWER_HEIGHT * scale;
    const padding = isExternal ? 0 : 5;
    
    for (let i = 0; i < drawerCount; i++) {
      const drawerY = y - (i + 1) * drawerH;
      const dx = x + padding;
      const dw = w - padding * 2;
      
      // ì„œë ë°•ìŠ¤
      svg += `<rect x="${dx}" y="${drawerY}" width="${dw}" height="${drawerH - 2}" fill="#f5f5f5" stroke="#888" stroke-width="1.5"/>`;
      // ì„œë ì†ì¡ì´
      const handleY = drawerY + drawerH / 2 - 3;
      const handleW = 30;
      svg += `<rect x="${dx + dw/2 - handleW/2}" y="${handleY}" width="${handleW}" height="6" rx="2" fill="#666"/>`;
    }
    return svg;
  };
  
  // ìŠ¤ë§ˆíŠ¸ë°” ê·¸ë¦¬ê¸° í•¨ìˆ˜
  const drawSmartbar = (x, y, h, scale) => {
    const sbW = SMARTBAR_WIDTH * scale;
    const sbH = h * scale;
    return `<rect x="${x}" y="${y}" width="${sbW}" height="${sbH}" fill="#333" stroke="#222" stroke-width="1"/>
      <rect x="${x + 2}" y="${y + sbH * 0.3}" width="${sbW - 4}" height="${sbH * 0.4}" fill="#555" rx="2"/>`;
  };
  
  wardrobeModules.forEach((mod, idx) => {
    const mW = parseFloat(mod.w) * scale;
    const moduleType = mod.moduleType || 'short';
    const isDivided = moduleType === 'short' || moduleType === 'shelf';
    const isShelfType = moduleType === 'shelf';
    const shelfCountUpper = mod.shelfCountUpper || 0;
    const shelfCountLower = mod.shelfCountLower || 0;
    const shelfCount = mod.shelfCount || 0;
    const drawerCount = mod.drawerCount || 0;
    const isExternalDrawer = mod.isExternalDrawer || false;
    
    if (isDivided) {
      // ìƒë¶€ì¥/í•˜ë¶€ì¥ ë¶„ë¦¬í˜•
      const upperH = parseFloat(mod.upperH) || Math.round(totalModuleH / 2);
      const lowerH = parseFloat(mod.lowerH) || Math.round(totalModuleH / 2);
      const upperHScaled = upperH * scale;
      const lowerHScaled = lowerH * scale;
      
      // í•˜ë¶€ì¥ (ì•„ë˜)
      const lowerY = offsetY + drawH - lowerHScaled;
      moduleSvg += `<rect x="${moduleStartX}" y="${lowerY}" width="${mW}" height="${lowerHScaled}" fill="${isShelfType ? '#fffbeb' : '#eff6ff'}" stroke="${isShelfType ? '#f59e0b' : '#3b82f6'}" stroke-width="2"/>`;
      
      // í•˜ë¶€ì¥ ì˜·ë´‰ (ì„ ë°˜í˜• ì œì™¸) - ìƒë‹¨ì—ì„œ -75mm
      if (!isShelfType) {
        const rodY = lowerY + ROD_OFFSET * scale;
        moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
          <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
          <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
      }
      
      // í•˜ë¶€ì¥ ì„ ë°˜
      const lowerShelfPositions = calcShelfPositions(lowerH, shelfCountLower, lowerY, scale);
      lowerShelfPositions.forEach(sy => {
        moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
      });
      
      // í•˜ë¶€ì¥ ì„œë (í•˜ë‹¨ì—ì„œ ìœ„ë¡œ ìŠ¤íƒ)
      const lowerBottom = lowerY + lowerHScaled;
      moduleSvg += drawDrawers(moduleStartX, lowerBottom, mW, drawerCount, isExternalDrawer, scale);
      
      // í•˜ë¶€ì¥ í…ìŠ¤íŠ¸
      moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${lowerY + lowerHScaled / 2 + 15}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${lowerH}</text>`;
      
      // ìƒë¶€ì¥ (ìœ„)
      const upperY = lowerY - upperHScaled;
      moduleSvg += `<rect x="${moduleStartX}" y="${upperY}" width="${mW}" height="${upperHScaled}" fill="${isShelfType ? '#fef3c7' : '#ecfdf5'}" stroke="${isShelfType ? '#f59e0b' : '#10b981'}" stroke-width="2"/>`;
      
      // ìƒë¶€ì¥ ì˜·ë´‰ (ì„ ë°˜í˜• ì œì™¸) - ìƒë‹¨ì—ì„œ -75mm
      if (!isShelfType) {
        const rodY = upperY + ROD_OFFSET * scale;
        moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
          <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
          <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
      }
      
      // ìƒë¶€ì¥ ì„ ë°˜
      const upperShelfPositions = calcShelfPositions(upperH, shelfCountUpper, upperY, scale);
      upperShelfPositions.forEach(sy => {
        moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
      });
      
      // ìƒë¶€ì¥ í…ìŠ¤íŠ¸
      moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${upperY + upperHScaled / 2 + 15}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${upperH}</text>`;
      
      // í•˜ë‹¨ ë„ˆë¹„ ì¹˜ìˆ˜
      moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#4a7dff">${mod.w}</text>`;
    } else {
      // ê¸´ì˜· ë‹¨ì¼í˜•
      const mH = parseFloat(mod.h) || totalModuleH;
      const mHScaled = mH * scale;
      const mY = offsetY + drawH - mHScaled;
      
      moduleSvg += `<rect x="${moduleStartX}" y="${mY}" width="${mW}" height="${mHScaled}" fill="#f0f7ff" stroke="#4a7dff" stroke-width="2"/>`;
      
      // ê¸´ì˜· ì˜·ë´‰ - ìƒë‹¨ì—ì„œ -75mm
      const rodY = mY + ROD_OFFSET * scale;
      moduleSvg += `<line x1="${moduleStartX + 10}" y1="${rodY}" x2="${moduleStartX + mW - 10}" y2="${rodY}" stroke="#666" stroke-width="3" stroke-linecap="round"/>
        <circle cx="${moduleStartX + 15}" cy="${rodY}" r="4" fill="#888"/>
        <circle cx="${moduleStartX + mW - 15}" cy="${rodY}" r="4" fill="#888"/>`;
      
      // ê¸´ì˜· ì„ ë°˜ (ì²« ì„ ë°˜: ìƒë‹¨ -315mm)
      const longShelfPositions = calcLongShelfPositions(mH, shelfCount, mY, scale);
      longShelfPositions.forEach(sy => {
        moduleSvg += `<line x1="${moduleStartX + 3}" y1="${sy}" x2="${moduleStartX + mW - 3}" y2="${sy}" stroke="#999" stroke-width="2"/>`;
      });
      
      // ê¸´ì˜· ì„œë (í•˜ë‹¨ì—ì„œ ìœ„ë¡œ ìŠ¤íƒ)
      const longBottom = mY + mHScaled;
      moduleSvg += drawDrawers(moduleStartX, longBottom, mW, drawerCount, isExternalDrawer, scale);
      
      // í…ìŠ¤íŠ¸
      moduleSvg += `<text x="${moduleStartX + mW / 2}" y="${mY + mHScaled / 2 + 5}" text-anchor="middle" font-size="9" fill="#666">${mod.w}Ã—${mH}</text>
        <text x="${moduleStartX + mW / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#4a7dff">${mod.w}</text>`;
    }
    moduleStartX += mW;
  });
  
  // ìš°ì¸¡ ë§ˆê°
  if (fR > 0) {
    moduleSvg += `<rect x="${offsetX + drawW - fR * scale}" y="${offsetY}" width="${fR * scale}" height="${drawH}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - fR * scale / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="10" fill="#666">${fR}</text>`;
  }
  
  const frontViewSvg = `
    <svg width="${svgWidth}" height="${svgHeight}" style="background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;">
      <!-- ì™¸ê³½ì„  -->
      <rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${drawH}" fill="none" stroke="#333" stroke-width="2"/>
      
      <!-- ì¹˜ìˆ˜ì„  - ìƒë‹¨ -->
      <line x1="${offsetX}" y1="${offsetY - 15}" x2="${offsetX + drawW}" y2="${offsetY - 15}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX}" y1="${offsetY - 20}" x2="${offsetX}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX + drawW}" y1="${offsetY - 20}" x2="${offsetX + drawW}" y2="${offsetY - 10}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX + drawW / 2}" y="${offsetY - 22}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${W}mm</text>
      
      <!-- ì¹˜ìˆ˜ì„  - ì¢Œì¸¡ -->
      <line x1="${offsetX - 15}" y1="${offsetY}" x2="${offsetX - 15}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY}" x2="${offsetX - 10}" y2="${offsetY}" stroke="#666" stroke-width="1"/>
      <line x1="${offsetX - 20}" y1="${offsetY + drawH}" x2="${offsetX - 10}" y2="${offsetY + drawH}" stroke="#666" stroke-width="1"/>
      <text x="${offsetX - 25}" y="${offsetY + drawH / 2}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold" transform="rotate(-90 ${offsetX - 25} ${offsetY + drawH / 2})">${H}mm</text>
      
      <!-- ì»¤íŠ¼ë°•ìŠ¤ -->
      ${curtainSvg}
      
      <!-- ëª¨ë“ˆë“¤ -->
      ${moduleSvg}
      
      <!-- ì‹¤ì¸¡ ê¸°ì¤€ í‘œì‹œ -->
      <text x="${isRefLeft ? offsetX + 10 : offsetX + drawW - 10}" y="${offsetY + drawH - 10}" text-anchor="${isRefLeft ? 'start' : 'end'}" font-size="10" fill="#4a7dff" font-weight="bold">â–¼ ì‹¤ì¸¡ê¸°ì¤€</text>
    </svg>
  `;
  
  // ëª¨ë“ˆ ì¹´ë“œ ë Œë”ë§
  const renderWardrobeModuleCard = (mod, idx, totalCount) => {
    const drawerCount = mod.drawerCount || 0;
    const shelfCountUpper = mod.shelfCountUpper || 0;
    const shelfCountLower = mod.shelfCountLower || 0;
    const shelfCount = mod.shelfCount || 0;
    const moduleType = mod.moduleType || 'short';
    const isDivided = moduleType === 'short' || moduleType === 'shelf';
    const isExternalDrawer = mod.isExternalDrawer || false;
    
    // ë†’ì´ ê³„ì‚°
    const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
    const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
    const totalH = parseFloat(item.h) || 0;
    const effectiveH = totalH - pedestalH - moldingH;
    const halfH = Math.round(effectiveH / 2);
    
    // ì¹´ìš´í„° ë°•ìŠ¤ ìŠ¤íƒ€ì¼
    const counterBoxStyle = 'display:flex;flex-direction:column;align-items:center;padding:6px 8px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;min-width:55px;';
    const counterBtnStyle = 'width:22px;height:22px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;font-size:13px;line-height:1;';
    
    // ì„œë íƒ€ì… í† ê¸€ (ì™¸ë¶€í˜•/ë‚´ë¶€í˜•)
    const drawerToggle = `
      <div style="display:flex;flex-direction:column;align-items:center;padding:4px 6px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;min-width:50px;">
        <div style="font-size:8px;color:#666;margin-bottom:3px;">ì„œëí˜•</div>
        <div style="display:flex;gap:2px;">
          <button onclick="toggleWardrobeDrawerType(${item.uniqueId}, ${mod.id}, false)" style="padding:2px 4px;font-size:8px;border:1px solid ${!isExternalDrawer ? '#3b82f6' : '#ddd'};background:${!isExternalDrawer ? '#eff6ff' : '#fff'};border-radius:3px;cursor:pointer;color:${!isExternalDrawer ? '#3b82f6' : '#666'};">ë‚´ë¶€</button>
          <button onclick="toggleWardrobeDrawerType(${item.uniqueId}, ${mod.id}, true)" style="padding:2px 4px;font-size:8px;border:1px solid ${isExternalDrawer ? '#3b82f6' : '#ddd'};background:${isExternalDrawer ? '#eff6ff' : '#fff'};border-radius:3px;cursor:pointer;color:${isExternalDrawer ? '#3b82f6' : '#666'};">ì™¸ë¶€</button>
        </div>
      </div>
    `;
    
    return `
      <div class="module-card" data-module-id="${mod.id}" style="display:flex;gap:10px;padding:12px;align-items:flex-start;">
        <!-- ì¢Œì¸¡: ì´ë™ ë²„íŠ¼ + íƒ€ì… ì„ íƒ -->
        <div style="display:flex;flex-direction:column;gap:4px;min-width:60px;">
          <div class="move-buttons" style="margin-bottom:4px;">
            <button class="btn-move" onclick="moveWardrobeModule(${item.uniqueId}, ${mod.id}, 'up')" ${idx === 0 ? 'disabled' : ''}>â–²</button>
            <button class="btn-move" onclick="moveWardrobeModule(${item.uniqueId}, ${mod.id}, 'down')" ${idx === totalCount - 1 ? 'disabled' : ''}>â–¼</button>
          </div>
          <button onclick="setWardrobeModuleType(${item.uniqueId}, ${mod.id}, 'short')" style="font-size:9px;padding:4px 3px;border:1px solid ${moduleType === 'short' ? '#10b981' : '#ddd'};background:${moduleType === 'short' ? '#ecfdf5' : '#fff'};border-radius:4px;cursor:pointer;color:${moduleType === 'short' ? '#10b981' : '#666'};">ì§§ì€ì˜·</button>
          <button onclick="setWardrobeModuleType(${item.uniqueId}, ${mod.id}, 'long')" style="font-size:9px;padding:4px 3px;border:1px solid ${moduleType === 'long' ? '#3b82f6' : '#ddd'};background:${moduleType === 'long' ? '#eff6ff' : '#fff'};border-radius:4px;cursor:pointer;color:${moduleType === 'long' ? '#3b82f6' : '#666'};">ê¸´ì˜·</button>
          <button onclick="setWardrobeModuleType(${item.uniqueId}, ${mod.id}, 'shelf')" style="font-size:9px;padding:4px 3px;border:1px solid ${moduleType === 'shelf' ? '#f59e0b' : '#ddd'};background:${moduleType === 'shelf' ? '#fffbeb' : '#fff'};border-radius:4px;cursor:pointer;color:${moduleType === 'shelf' ? '#f59e0b' : '#666'};">ì„ ë°˜í˜•</button>
        </div>
        
        <!-- ì¤‘ì•™+ìš°ì¸¡: ëª¨ë“ˆ ì •ë³´ -->
        <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
          <!-- í—¤ë” -->
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
            <span style="font-size:15px;">ğŸšª</span>
            <span style="font-weight:600;color:#333;font-size:14px;">${mod.name}</span>
            <span style="font-size:10px;padding:2px 6px;background:${moduleType === 'short' ? '#ecfdf5' : moduleType === 'long' ? '#eff6ff' : '#fffbeb'};color:${moduleType === 'short' ? '#10b981' : moduleType === 'long' ? '#3b82f6' : '#f59e0b'};border-radius:4px;">${moduleType === 'short' ? 'ì§§ì€ì˜·' : moduleType === 'long' ? 'ê¸´ì˜·' : 'ì„ ë°˜'}</span>
            <label style="font-size:11px;color:#666;display:flex;align-items:center;gap:3px;margin-left:auto;"><input type="checkbox" ${mod.hasMirror ? 'checked' : ''} onchange="toggleWardrobeOption(${item.uniqueId}, ${mod.id}, 'hasMirror', this.checked)" style="transform:scale(0.9);"> ê±°ìš¸</label>
            <button class="btn-delete-module" onclick="removeWardrobeModule(${item.uniqueId}, ${mod.id})" style="margin-left:4px;">Ã—</button>
          </div>
          
          ${isDivided ? `
          <!-- ìƒë¶€ì¥/í•˜ë¶€ì¥ ë¶„ë¦¬í˜• -->
          <div style="display:flex;flex-direction:column;gap:6px;">
            <!-- ìƒë¶€ì¥ í–‰ -->
            <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#ecfdf5;border:1px solid #10b981;border-radius:6px;">
              <span style="font-size:11px;color:#10b981;font-weight:700;min-width:45px;">ìƒë¶€ì¥</span>
              <span style="font-size:11px;color:#666;">W</span>
              <input type="number" value="${mod.w}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'w', this.value)" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
              <span style="font-size:11px;color:#666;">H</span>
              <input type="number" value="${mod.upperH || halfH}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'upperH', this.value)" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
              <span style="font-size:11px;color:#666;">D</span>
              <input type="number" value="${mod.d}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'd', this.value)" style="width:55px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
              <!-- ìƒë¶€ì¥ ì„ ë°˜ -->
              <div style="${counterBoxStyle}">
                <div style="font-size:9px;color:#666;margin-bottom:3px;">ì„ ë°˜</div>
                <div style="display:flex;align-items:center;gap:3px;">
                  <button onclick="adjustWardrobeShelf(${item.uniqueId}, ${mod.id}, 'upper', -1)" style="${counterBtnStyle}">âˆ’</button>
                  <span style="min-width:18px;text-align:center;font-weight:bold;font-size:13px;">${shelfCountUpper}</span>
                  <button onclick="adjustWardrobeShelf(${item.uniqueId}, ${mod.id}, 'upper', 1)" style="${counterBtnStyle}">+</button>
                </div>
              </div>
            </div>
            <!-- í•˜ë¶€ì¥ í–‰ -->
            <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#eff6ff;border:1px solid #3b82f6;border-radius:6px;">
              <span style="font-size:11px;color:#3b82f6;font-weight:700;min-width:45px;">í•˜ë¶€ì¥</span>
              <span style="font-size:11px;color:#666;">W</span>
              <input type="number" value="${mod.w}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'w', this.value)" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
              <span style="font-size:11px;color:#666;">H</span>
              <input type="number" value="${mod.lowerH || halfH}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'lowerH', this.value)" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
              <span style="font-size:11px;color:#666;">D</span>
              <input type="number" value="${mod.d}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'd', this.value)" style="width:55px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
              <!-- í•˜ë¶€ì¥ ì„ ë°˜ -->
              <div style="${counterBoxStyle}">
                <div style="font-size:9px;color:#666;margin-bottom:3px;">ì„ ë°˜</div>
                <div style="display:flex;align-items:center;gap:3px;">
                  <button onclick="adjustWardrobeShelf(${item.uniqueId}, ${mod.id}, 'lower', -1)" style="${counterBtnStyle}">âˆ’</button>
                  <span style="min-width:18px;text-align:center;font-weight:bold;font-size:13px;">${shelfCountLower}</span>
                  <button onclick="adjustWardrobeShelf(${item.uniqueId}, ${mod.id}, 'lower', 1)" style="${counterBtnStyle}">+</button>
                </div>
              </div>
              <!-- í•˜ë¶€ì¥ ì„œë -->
              <div style="${counterBoxStyle}">
                <div style="font-size:9px;color:#666;margin-bottom:3px;">ì„œë</div>
                <div style="display:flex;align-items:center;gap:3px;">
                  <button onclick="adjustWardrobeDrawer(${item.uniqueId}, ${mod.id}, -1)" style="${counterBtnStyle}">âˆ’</button>
                  <span style="min-width:18px;text-align:center;font-weight:bold;font-size:13px;">${drawerCount}</span>
                  <button onclick="adjustWardrobeDrawer(${item.uniqueId}, ${mod.id}, 1)" style="${counterBtnStyle}">+</button>
                </div>
              </div>
              ${drawerToggle}
            </div>
          </div>
          ` : `
          <!-- ê¸´ì˜· ë‹¨ì¼í˜• -->
          <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#f0f7ff;border:1px solid #4a7dff;border-radius:6px;">
            <span style="font-size:11px;color:#4a7dff;font-weight:700;min-width:45px;">ê¸´ì˜·ì¥</span>
            <span style="font-size:11px;color:#666;">W</span>
            <input type="number" value="${mod.w}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'w', this.value)" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
            <span style="font-size:11px;color:#666;">H</span>
            <input type="number" value="${mod.h || effectiveH}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'h', this.value)" style="width:60px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
            <span style="font-size:11px;color:#666;">D</span>
            <input type="number" value="${mod.d}" onchange="updateWardrobeModuleDim(${item.uniqueId}, ${mod.id}, 'd', this.value)" style="width:55px;padding:4px 6px;border:1px solid #ccc;border-radius:4px;font-size:12px;font-weight:500;">
            <!-- ì„ ë°˜ -->
            <div style="${counterBoxStyle}">
              <div style="font-size:9px;color:#666;margin-bottom:3px;">ì„ ë°˜</div>
              <div style="display:flex;align-items:center;gap:3px;">
                <button onclick="adjustWardrobeShelfSingle(${item.uniqueId}, ${mod.id}, -1)" style="${counterBtnStyle}">âˆ’</button>
                <span style="min-width:18px;text-align:center;font-weight:bold;font-size:13px;">${shelfCount}</span>
                <button onclick="adjustWardrobeShelfSingle(${item.uniqueId}, ${mod.id}, 1)" style="${counterBtnStyle}">+</button>
              </div>
            </div>
            <!-- ì„œë -->
            <div style="${counterBoxStyle}">
              <div style="font-size:9px;color:#666;margin-bottom:3px;">ì„œë</div>
              <div style="display:flex;align-items:center;gap:3px;">
                <button onclick="adjustWardrobeDrawer(${item.uniqueId}, ${mod.id}, -1)" style="${counterBtnStyle}">âˆ’</button>
                <span style="min-width:18px;text-align:center;font-weight:bold;font-size:13px;">${drawerCount}</span>
                <button onclick="adjustWardrobeDrawer(${item.uniqueId}, ${mod.id}, 1)" style="${counterBtnStyle}">+</button>
              </div>
            </div>
            ${drawerToggle}
          </div>
          `}
        </div>
      </div>
    `;
  };
  
  const modulesHtml = wardrobeModules.map((m, i) => renderWardrobeModuleCard(m, i, wardrobeModules.length)).join('');
  
  ws.innerHTML = `
    <div class="ws-header">
      <div class="ws-title">${item.labelName} ìƒì„¸ ì„¤ê³„ <span class="ws-info-badge">W ${W} x H ${H} x D ${D}</span></div>
      <button style="background:var(--primary-color);color:white;border:none;padding:8px 16px;border-radius:6px;font-size:13px;font-weight:bold;cursor:pointer;" onclick="alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.')">ì„¤ê³„ ì €ì¥</button>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">1. Dimensions (ì¹˜ìˆ˜)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì „ì²´ ë†’ì´</label><input type="number" value="${H}" disabled></div>
          <div class="spec-field"><label>ì „ì²´ ê¹Šì´</label><input type="number" value="${D}" disabled></div>
          <div class="spec-field"><label>ì¢ŒëŒ€ ë†’ì´</label><input type="number" value="${item.specs.wardrobePedestal || 60}" onblur="updateWardrobeSpec(${item.uniqueId}, 'wardrobePedestal', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì»¤íŠ¼ë°•ìŠ¤ ê°€ë¡œ</label><input type="number" value="${curtainW}" onblur="updateWardrobeSpec(${item.uniqueId}, 'curtainBoxW', this.value)"></div>
          <div class="spec-field"><label>ì»¤íŠ¼ë°•ìŠ¤ ë†’ì´</label><input type="number" value="${curtainH}" onblur="updateWardrobeSpec(${item.uniqueId}, 'curtainBoxH', this.value)"></div>
        </div>

        <div class="spec-group-title">2. Hardware</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì†ì¡ì´</label>
            <select onchange="updateWardrobeSpec(${item.uniqueId}, 'handleType', this.value)">
              <option value="bar" ${(item.specs.handleType || 'bar') === 'bar' ? 'selected' : ''}>ì¼ì ì†ì¡ì´</option>
              <option value="cchannel" ${item.specs.handleType === 'cchannel' ? 'selected' : ''}>Cì°¬ë„¬</option>
              <option value="push" ${item.specs.handleType === 'push' ? 'selected' : ''}>í‘¸ì‰¬ ë„ì–´</option>
              <option value="smartbar" ${item.specs.handleType === 'smartbar' ? 'selected' : ''}>ìŠ¤ë§ˆíŠ¸ë°”</option>
            </select>
          </div>
          <div class="spec-field"><label>ë ˆì¼</label><select><option>ì†Œí”„íŠ¸í´ë¡œì§•</option><option>ì¼ë°˜ ë ˆì¼</option><option>í’€ìµìŠ¤í…ì…˜</option></select></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì‹¤ì¸¡ ê¸°ì¤€</label>
            <select onchange="updateWardrobeSpec(${item.uniqueId}, 'measurementBase', this.value)">
              <option value="Left" ${isRefLeft?'selected':''}>ì¢Œì¸¡</option>
              <option value="Right" ${!isRefLeft?'selected':''}>ìš°ì¸¡</option>
            </select>
          </div>
        </div>

        <div class="spec-group-title">3. Colors (ë„ì–´)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ë„ì–´ ìƒ‰ìƒ</label>
            <div class="color-select-row">
              <select><option>ë¬´ê´‘</option><option>ìœ ê´‘</option></select>
              <select><option>í™”ì´íŠ¸</option><option>ê·¸ë ˆì´</option><option>ë² ì´ì§€</option><option>ì›”ë„›</option><option>ì˜¤í¬</option></select>
            </div>
          </div>
        </div>

        <div class="spec-group-title">4. Finish Settings (ë§ˆê°)</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒëª°ë”© ë†’ì´(mm)</label><input type="number" value="${item.specs.wardrobeMoldingH || 15}" onblur="updateWardrobeSpec(${item.uniqueId}, 'wardrobeMoldingH', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¢Œì¸¡ ë§ˆê°</label><select onchange="updateWardrobeFinishType(${item.uniqueId}, 'Left', this.value)"><option value="Filler" ${item.specs.finishLeftType==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishLeftType==='Molding'?'selected':''}>ëª°ë”©</option><option value="EP" ${item.specs.finishLeftType==='EP'?'selected':''}>EP</option><option value="None" ${item.specs.finishLeftType==='None'?'selected':''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishLeftWidth}" ${item.specs.finishLeftType==='EP'?'disabled':''} onblur="updateWardrobeSpec(${item.uniqueId}, 'finishLeftWidth', this.value)"></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìš°ì¸¡ ë§ˆê°</label><select onchange="updateWardrobeFinishType(${item.uniqueId}, 'Right', this.value)"><option value="Filler" ${item.specs.finishRightType==='Filler'?'selected':''}>íœ ë¼</option><option value="Molding" ${item.specs.finishRightType==='Molding'?'selected':''}>ëª°ë”©</option><option value="EP" ${item.specs.finishRightType==='EP'?'selected':''}>EP</option><option value="None" ${item.specs.finishRightType==='None'?'selected':''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´(mm)</label><input type="number" value="${item.specs.finishRightWidth}" ${item.specs.finishRightType==='EP'?'disabled':''} onblur="updateWardrobeSpec(${item.uniqueId}, 'finishRightWidth', this.value)"></div>
        </div>
      </div>

      <div class="module-panel">
        <!-- â˜… Front View ë„ë©´ -->
        <div class="front-view-section" style="margin-bottom:20px;">
          <div style="font-size:14px;font-weight:bold;color:#333;margin-bottom:10px;display:flex;align-items:center;gap:8px;">
            <span>ğŸ“ Front View</span>
            <span style="font-size:11px;color:#888;font-weight:normal;">(ì „ë©´ë¶€ ë„ë©´)</span>
          </div>
          ${frontViewSvg}
        </div>
        
        <div class="module-section">
          <div class="module-section-header" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="section-title-row"><span>ğŸšª ë¶™ë°•ì´ì¥ ëª¨ë“ˆ</span></div>
            <div class="section-info-row">
              <div class="effective-space-group">
                <label>ìœ íš¨ê³µê°„:</label>
                <input type="number" value="${Math.round(item.specs.wardrobeEffectiveW || effectiveW)}" 
                  onblur="updateWardrobeEffectiveW(${item.uniqueId}, this.value)"
                  style="width:70px;padding:2px 6px;border:1px solid rgba(255,255,255,0.3);border-radius:4px;background:rgba(255,255,255,0.15);color:white;font-weight:bold;font-size:13px;text-align:right;">
                <span style="color:white;">mm</span>
              </div>
              <span class="section-remaining" style="color:${remaining >= 0 && remaining <= 10 ? '#90EE90' : (remaining < 0 ? '#ff6b6b' : 'white')}">ì”ì—¬: ${Math.round(remaining)}mm</span>
              <div class="section-buttons">
                <button class="btn-section-auto" onclick="runWardrobeAutoCalc(${item.uniqueId})">âš¡ ìë™ê³„ì‚°</button>
              </div>
            </div>
          </div>
          <div class="module-list ${wardrobeModules.length === 0 ? 'empty-list' : ''}">${modulesHtml}</div>
        </div>
        
        <div class="module-btn-group">
          <button class="btn-add-split" style="border-color:#10b981;color:#10b981;" onclick="addWardrobeModule(${item.uniqueId})">+ ë¶™ë°•ì´ì¥ ëª¨ë“ˆ</button>
        </div>
      </div>
    </div>
  `;
}

// ë¶™ë°•ì´ì¥ ëª¨ë“ˆ ê´€ë ¨ í•¨ìˆ˜ë“¤
function addWardrobeModule(itemUniqueId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  // â˜… ë†’ì´ ê³„ì‚°: (ì „ì²´ë†’ì´ - ì¢ŒëŒ€ - ìƒëª°ë”©) / 2
  const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
  const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
  const totalH = parseFloat(item.h) || 0;
  const effectiveH = totalH - pedestalH - moldingH;
  const halfH = Math.round(effectiveH / 2);
  
  item.modules.push({
    id: Date.now(),
    type: 'wardrobe',
    name: 'ì§§ì€ì˜·(2ë‹¨)',
    pos: 'wardrobe',
    w: 900,
    h: effectiveH,  // ê¸´ì˜·ìš© ì „ì²´ ë†’ì´
    upperH: halfH,  // ìƒë¶€ì¥ ë†’ì´
    lowerH: halfH,  // í•˜ë¶€ì¥ ë†’ì´
    d: parseFloat(item.d) || 650,
    moduleType: 'short',
    isDivided: true,
    drawerCount: 0,
    shelfCount: 0,
    shelfCountUpper: 0,
    shelfCountLower: 0,
    hasMirror: false
  });
  renderWorkspaceContent(item);
}

function removeWardrobeModule(itemUniqueId, modId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  item.modules = item.modules.filter(m => m.id !== modId);
  renderWorkspaceContent(item);
}

function moveWardrobeModule(itemUniqueId, modId, direction) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const modules = item.modules.filter(m => m.pos === 'wardrobe');
  const idx = modules.findIndex(m => m.id === modId);
  if (idx === -1) return;
  
  const newIdx = direction === 'up' ? idx - 1 : idx + 1;
  if (newIdx < 0 || newIdx >= modules.length) return;
  
  [modules[idx], modules[newIdx]] = [modules[newIdx], modules[idx]];
  item.modules = item.modules.filter(m => m.pos !== 'wardrobe').concat(modules);
  renderWorkspaceContent(item);
}

function updateWardrobeModuleDim(itemUniqueId, modId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod[field] = parseFloat(value) || 0;
    renderWorkspaceContent(item);
  }
}

function toggleWardrobeOption(itemUniqueId, modId, field, checked) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod[field] = checked;
    renderWorkspaceContent(item);
  }
}

// â˜… ì„œë ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜
function adjustWardrobeDrawer(itemUniqueId, modId, delta) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.drawerCount = Math.max(0, Math.min(5, (mod.drawerCount || 0) + delta));
    renderWorkspaceContent(item);
  }
}

// â˜… ëª¨ë“ˆ íƒ€ì… ì„¤ì • í•¨ìˆ˜ (ì§§ì€ì˜·2ë‹¨, ê¸´ì˜·1ë‹¨, ì„ ë°˜í˜•)
function setWardrobeModuleType(itemUniqueId, modId, type) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.moduleType = type;
    // íƒ€ì…ì— ë”°ë¥¸ ì´ë¦„ ë³€ê²½
    const typeNames = { short: 'ì§§ì€ì˜·(2ë‹¨)', long: 'ê¸´ì˜·(1ë‹¨)', shelf: 'ì„ ë°˜í˜•' };
    mod.name = typeNames[type] || mod.name;
    
    // â˜… ë†’ì´ ê³„ì‚°
    const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
    const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
    const totalH = parseFloat(item.h) || 0;
    const effectiveH = totalH - pedestalH - moldingH;
    const halfH = Math.round(effectiveH / 2);
    
    // â˜… íƒ€ì…ë³„ ê¸°ë³¸ê°’ ì„¤ì •
    if (type === 'short') {
      // ì§§ì€ì˜·(2ë‹¨): ìƒë¶€ì¥/í•˜ë¶€ì¥ 2ë“±ë¶„
      mod.isDivided = true;
      mod.h = effectiveH;
      mod.upperH = halfH;
      mod.lowerH = halfH;
      mod.drawerCount = mod.drawerCount || 0;
      mod.shelfCountUpper = mod.shelfCountUpper || 0;
      mod.shelfCountLower = mod.shelfCountLower || 0;
      mod.shelfCount = 0;
    } else if (type === 'long') {
      // ê¸´ì˜·(1ë‹¨): ì„œë ê¸°ë³¸ê°’ 1, ì„ ë°˜ ê¸°ë³¸ê°’ 1
      mod.isDivided = false;
      mod.h = effectiveH;
      mod.upperH = 0;
      mod.lowerH = 0;
      mod.drawerCount = 1;
      mod.shelfCount = 1;
      mod.shelfCountUpper = 0;
      mod.shelfCountLower = 0;
    } else if (type === 'shelf') {
      // ì„ ë°˜í˜•: ìƒë¶€ì¥/í•˜ë¶€ì¥ 2ë“±ë¶„, ì„ ë°˜ ê¸°ë³¸ê°’ ìƒë¶€2 + í•˜ë¶€2 = 4
      mod.isDivided = true;
      mod.h = effectiveH;
      mod.upperH = halfH;
      mod.lowerH = halfH;
      mod.drawerCount = mod.drawerCount || 0;
      mod.shelfCountUpper = 2;
      mod.shelfCountLower = 2;
      mod.shelfCount = 0;
    }
    
    renderWorkspaceContent(item);
  }
}

// â˜… ì„ ë°˜ ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜
function adjustWardrobeShelf(itemUniqueId, modId, section, delta) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    if (section === 'upper') {
      mod.shelfCountUpper = Math.max(0, Math.min(6, (mod.shelfCountUpper || 0) + delta));
    } else {
      mod.shelfCountLower = Math.max(0, Math.min(6, (mod.shelfCountLower || 0) + delta));
    }
    renderWorkspaceContent(item);
  }
}

// â˜… ê¸´ì˜·ìš© ë‹¨ì¼ ì„ ë°˜ ê°œìˆ˜ ì¡°ì ˆ í•¨ìˆ˜
function adjustWardrobeShelfSingle(itemUniqueId, modId, delta) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.shelfCount = Math.max(0, Math.min(6, (mod.shelfCount || 0) + delta));
    renderWorkspaceContent(item);
  }
}

// â˜… ì„œë ì™¸ë¶€í˜•/ë‚´ë¶€í˜• í† ê¸€ í•¨ìˆ˜
function toggleWardrobeDrawerType(itemUniqueId, modId, isExternal) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.isExternalDrawer = isExternal;
    renderWorkspaceContent(item);
  }
}

// â˜… ë§ˆê° íƒ€ì… ë³€ê²½ í•¨ìˆ˜ (EP ì„ íƒ ì‹œ ê¸¸ì´ 20ìœ¼ë¡œ ê³ ì •)
function updateWardrobeFinishType(itemUniqueId, side, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  if (side === 'Left') {
    item.specs.finishLeftType = value;
    // EP ì„ íƒ ì‹œ ê¸¸ì´ 20ìœ¼ë¡œ ê³ ì •
    if (value === 'EP') {
      item.specs.finishLeftWidth = 20;
    }
  } else {
    item.specs.finishRightType = value;
    // EP ì„ íƒ ì‹œ ê¸¸ì´ 20ìœ¼ë¡œ ê³ ì •
    if (value === 'EP') {
      item.specs.finishRightWidth = 20;
    }
  }
  
  // â˜… ìœ íš¨ê³µê°„ ìë™ ì¬ê³„ì‚°
  recalcWardrobeEffectiveW(item);
  
  renderWorkspaceContent(item);
}

// â˜… ìœ íš¨ê³µê°„ ìë™ ì¬ê³„ì‚° í•¨ìˆ˜
function recalcWardrobeEffectiveW(item) {
  const W = parseFloat(item.w) || 0;
  const fL = item.specs.finishLeftType !== 'None' ? (parseFloat(item.specs.finishLeftWidth) || 0) : 0;
  const fR = item.specs.finishRightType !== 'None' ? (parseFloat(item.specs.finishRightWidth) || 0) : 0;
  item.specs.wardrobeEffectiveW = W - fL - fR;
}

function updateWardrobeSpec(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  item.specs[field] = isNaN(parseFloat(value)) ? value : parseFloat(value);
  
  // â˜… ë§ˆê° ê¸¸ì´ ë³€ê²½ ì‹œ ìœ íš¨ê³µê°„ ì¬ê³„ì‚°
  if (field === 'finishLeftWidth' || field === 'finishRightWidth') {
    recalcWardrobeEffectiveW(item);
  }
  
  renderWorkspaceContent(item);
}

// â˜… ìœ íš¨ê³µê°„ ì§ì ‘ ìˆ˜ì • í•¨ìˆ˜
function updateWardrobeEffectiveW(itemUniqueId, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const newValue = parseFloat(value);
  if (!isNaN(newValue) && newValue > 0) {
    item.specs.wardrobeEffectiveW = newValue;
  } else {
    // ë¹ˆ ê°’ì´ë©´ ìë™ ê³„ì‚° ëª¨ë“œë¡œ ë³µê·€
    delete item.specs.wardrobeEffectiveW;
  }
  renderWorkspaceContent(item);
}

function runWardrobeAutoCalc(itemUniqueId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const W = parseFloat(item.w) || 0;
  const H = parseFloat(item.h) || 0;
  const D = parseFloat(item.d) || 650;
  
  // â˜… ë†’ì´ ê³„ì‚°: (ì „ì²´ë†’ì´ - ì¢ŒëŒ€ - ìƒëª°ë”©)
  const pedestalH = parseFloat(item.specs.wardrobePedestal) || 60;
  const moldingH = parseFloat(item.specs.wardrobeMoldingH) || 15;
  const effectiveH = H - pedestalH - moldingH;
  const halfH = Math.round(effectiveH / 2);  // ìƒë¶€ì¥/í•˜ë¶€ì¥ ê°ê°
  
  const fL = item.specs.finishLeftType !== 'None' ? (parseFloat(item.specs.finishLeftWidth) || 0) : 0;
  const fR = item.specs.finishRightType !== 'None' ? (parseFloat(item.specs.finishRightWidth) || 0) : 0;
  // â˜… ìœ íš¨ê³µê°„: ì§ì ‘ ì…ë ¥ê°’ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ê³„ì‚°
  const effectiveW = item.specs.wardrobeEffectiveW || (W - fL - fR);
  
  if (effectiveW <= 0) {
    alert("ìœ íš¨ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
    return;
  }
  
  const handleType = item.specs.handleType || 'bar';
  const SMARTBAR_WIDTH = 30;  // ìŠ¤ë§ˆíŠ¸ë°” ë„ˆë¹„
  const TARGET_DOOR_WIDTH = 480;  // ëª©í‘œ ë„ì–´ ë„ˆë¹„
  const TOLERANCE = 10;  // ì‹œê³µ ì—¬ìœ ê³µê°„
  
  item.modules = item.modules.filter(m => m.pos !== 'wardrobe');
  
  // â˜… ëª¨ë“ˆ íƒ€ì… ê¸°ë³¸ê°’ í•¨ìˆ˜: 2D,2D,2D,1D â†’ ì§§ì€ì˜·, ì§§ì€ì˜·, ê¸´ì˜·, ì„ ë°˜í˜•
  const getModuleTypeDefaults = (modules2DCount, modules1DCount, idx, is2D) => {
    if (modules2DCount === 3 && modules1DCount === 1) {
      // 2D, 2D, 2D, 1D êµ¬ì„±
      if (is2D) {
        if (idx === 0) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
        if (idx === 1) return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
        if (idx === 2) return { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
      } else {
        return { type: 'shelf', name: 'ì„ ë°˜í˜•', isDivided: true };
      }
    }
    // ê¸°ë³¸ê°’
    return { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
  };
  
  if (handleType === 'smartbar') {
    // â˜… ìŠ¤ë§ˆíŠ¸ë°” ëª¨ë“œ: ë„ì–´ ê· ë“±ë¶„ë°° (ìµœìš°ì„ )
    
    // 1. ì´ ë„ì–´ ìˆ˜ ê²°ì • (ëª©í‘œ 480mm ê¸°ì¤€)
    const totalDoors = Math.round(effectiveW / TARGET_DOOR_WIDTH);
    
    if (totalDoors <= 0) {
      alert("ê³µê°„ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤.");
      return;
    }
    
    // 2. ëª¨ë“ˆ ì¡°í•© ê²°ì • (2D ìš°ì„ )
    const modules2D = Math.floor(totalDoors / 2);
    const modules1D = totalDoors % 2;
    const totalModules = modules2D + modules1D;
    
    // 3. ìŠ¤ë§ˆíŠ¸ë°” ì´ ë„ˆë¹„
    const smartbarTotal = totalModules * SMARTBAR_WIDTH;
    
    // 4. ë„ì–´ ê³µê°„ ê· ë“±ë¶„ë°° (â˜… ëª¨ë“  ë„ì–´ ë™ì¼ ë„ˆë¹„)
    const doorSpace = effectiveW - smartbarTotal;
    const doorWidth = Math.floor(doorSpace / totalDoors);  // ê· ë“± ë„ì–´ ë„ˆë¹„
    const usedDoorSpace = doorWidth * totalDoors;
    const remainder = doorSpace - usedDoorSpace;  // ì—¬ìœ ê³µê°„ (ì‹œê³µ ì—¬ìœ )
    
    // 5. ëª¨ë“ˆ ìƒì„± (ëª¨ë“  ë„ì–´ ë™ì¼ ë„ˆë¹„)
    let doorIdx = 0;
    
    // 2D ëª¨ë“ˆë“¤
    for (let i = 0; i < modules2D; i++) {
      const modWidth = doorWidth * 2 + SMARTBAR_WIDTH;
      const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, i, true);
      
      item.modules.push({
        id: Date.now() + i,
        type: 'wardrobe',
        name: typeDefaults.name,
        pos: 'wardrobe',
        w: modWidth,
        doorCount: 2,
        doorWidth: doorWidth,
        hasSmartbar: true,
        h: effectiveH,
        upperH: halfH,
        lowerH: halfH,
        d: D,
        moduleType: typeDefaults.type,
        isDivided: typeDefaults.isDivided,
        drawerCount: typeDefaults.type === 'long' ? 1 : 0,
        shelfCount: typeDefaults.type === 'long' ? 1 : 0,
        shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
        shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
        hasMirror: false,
        isExternalDrawer: false
      });
    }
    
    // 1D ëª¨ë“ˆ (ìˆìœ¼ë©´)
    if (modules1D > 0) {
      const modWidth = doorWidth + SMARTBAR_WIDTH;
      const typeDefaults = getModuleTypeDefaults(modules2D, modules1D, 0, false);
      
      item.modules.push({
        id: Date.now() + modules2D,
        type: 'wardrobe',
        name: typeDefaults.name,
        pos: 'wardrobe',
        w: modWidth,
        doorCount: 1,
        doorWidth: doorWidth,
        hasSmartbar: true,
        h: effectiveH,
        upperH: halfH,
        lowerH: halfH,
        d: D,
        moduleType: typeDefaults.type,
        isDivided: typeDefaults.isDivided,
        drawerCount: 0,
        shelfCount: 0,
        shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
        shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
        hasMirror: false,
        isExternalDrawer: false
      });
    }
    
    // ê²€ì¦ ë¡œê·¸
    const totalWidth = item.modules.filter(m => m.pos === 'wardrobe').reduce((sum, m) => sum + m.w, 0);
    console.log(`ìŠ¤ë§ˆíŠ¸ë°” ê³„ì‚°: ë„ì–´ë„ˆë¹„=${doorWidth}mm, ëª¨ë“ˆí•©=${totalWidth}mm, ì—¬ìœ ê³µê°„=${remainder}mm`);
    
    if (remainder > TOLERANCE) {
      console.warn(`ì‹œê³µ ì—¬ìœ ê³µê°„ ì´ˆê³¼: ${remainder}mm (í—ˆìš©: ${TOLERANCE}mm)`);
    }
    
  } else {
    // â˜… ì¼ë°˜ ëª¨ë“œ: ê¸°ì¡´ ë¶„ë°°ê·œì¹™ ì ìš©
    const result = distributeModules(effectiveW);
    
    // ëª¨ë“ˆ êµ¬ì„± ë¶„ì„: 2D/1D íŒ¨í„´ í™•ì¸
    const moduleCount = result.modules.length;
    let modules2D = 0;
    let modules1D = 0;
    
    if (moduleCount === 4) {
      // 4ê°œ ëª¨ë“ˆì¸ ê²½ìš°, ë„ˆë¹„ë¡œ 2D/1D íŒë³„
      const avgWidth = result.modules.reduce((sum, m) => sum + m.w, 0) / moduleCount;
      result.modules.forEach(m => {
        if (m.w >= avgWidth * 0.8) modules2D++;
        else modules1D++;
      });
    }
    
    result.modules.forEach((m, idx) => {
      // 2D,2D,2D,1D êµ¬ì„±ì¸ ê²½ìš° íƒ€ì… ê¸°ë³¸ê°’ ì ìš©
      let typeDefaults = { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
      
      if (modules2D === 3 && modules1D === 1 && moduleCount === 4) {
        // ë§ˆì§€ë§‰ ëª¨ë“ˆì´ 1D (ì„ ë°˜í˜•)
        if (idx === 0) typeDefaults = { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
        else if (idx === 1) typeDefaults = { type: 'short', name: 'ì§§ì€ì˜·(2ë‹¨)', isDivided: true };
        else if (idx === 2) typeDefaults = { type: 'long', name: 'ê¸´ì˜·(1ë‹¨)', isDivided: false };
        else if (idx === 3) typeDefaults = { type: 'shelf', name: 'ì„ ë°˜í˜•', isDivided: true };
      }
      
      item.modules.push({
        id: Date.now() + idx,
        type: 'wardrobe',
        name: typeDefaults.name,
        pos: 'wardrobe',
        w: m.w,
        h: effectiveH,
        upperH: halfH,
        lowerH: halfH,
        d: D,
        moduleType: typeDefaults.type,
        isDivided: typeDefaults.isDivided,
        drawerCount: typeDefaults.type === 'long' ? 1 : 0,
        shelfCount: typeDefaults.type === 'long' ? 1 : 0,
        shelfCountUpper: typeDefaults.type === 'shelf' ? 2 : 0,
        shelfCountLower: typeDefaults.type === 'shelf' ? 2 : 0,
        hasMirror: false,
        isExternalDrawer: false
      });
    });
  }
  
  renderWorkspaceContent(item);
}

function onEffectiveSpaceBlur(itemUniqueId, section, inputEl) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const value = inputEl.value.trim();
  if (section === 'upper') item.specs.effectiveUpperW = value === '' ? null : parseFloat(value);
  else item.specs.effectiveLowerW = value === '' ? null : parseFloat(value);
  
  renderWorkspaceContent(item);
}

function onDishwasherChange(itemUniqueId, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  item.specs.dishwasher = value;
  if (value === 'BuiltIn' || value === 'FreeStanding') {
    item.specs.sinkLegHeight = 120;
  }
  renderWorkspaceContent(item);
}

function changeLayoutShape(itemUniqueId, shape) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) { item.specs.layoutShape = shape; renderWorkspaceContent(item); }
}

function updateTopSize(itemUniqueId, index, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) item.specs.topSizes[index] = value;
}

function updateSpec(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) { item.specs[field] = value; renderWorkspaceContent(item); }
}

function updateSpecNoRender(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) item.specs[field] = value;
}

function updateSpecValue(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) { item.specs[field] = parseFloat(value) || value; renderWorkspaceContent(item); }
}

function updateModuleDim(itemUniqueId, moduleId, dim, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const mod = item.modules.find(m => m.id === moduleId);
  if (!mod) return;
  
  mod[dim] = parseFloat(value) || 0;
  mod.isFixed = true;
  
  updateRemainingDisplay(item);
}

function updateRemainingDisplay(item) {
  const upperModules = item.modules.filter(m => m.pos === 'upper');
  const lowerModules = item.modules.filter(m => m.pos === 'lower');
  
  const upperEffectiveW = getEffectiveSpace(item, 'upper');
  const lowerEffectiveW = getEffectiveSpace(item, 'lower');
  
  const upperUsedW = upperModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
  const lowerUsedW = lowerModules.reduce((sum, m) => sum + (parseFloat(m.w) || 0), 0);
  
  const upperRemaining = upperEffectiveW - upperUsedW;
  const lowerRemaining = lowerEffectiveW - lowerUsedW;
  
  const upperSpan = document.querySelector('.module-section-header.upper .section-remaining');
  const lowerSpan = document.querySelector('.module-section-header.lower .section-remaining');
  
  if (upperSpan) {
    upperSpan.textContent = `ì”ì—¬: ${Math.round(upperRemaining)}mm`;
    upperSpan.style.color = getRemainColor(upperRemaining);
  }
  if (lowerSpan) {
    lowerSpan.textContent = `ì”ì—¬: ${Math.round(lowerRemaining)}mm`;
    lowerSpan.style.color = getRemainColor(lowerRemaining);
  }
  
  item.modules.forEach(mod => {
    if (mod.isFixed) {
      const card = document.querySelector(`[data-module-id="${mod.id}"]`);
      if (card && !card.classList.contains('fixed-module')) {
        card.classList.add('fixed-module');
      }
    }
  });
}

function updateModuleDetail(itemUniqueId, moduleId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    const mod = item.modules.find(m => m.id === moduleId);
    if (mod) mod[field] = parseFloat(value) || 0;
  }
}

function toggleOption(itemUniqueId, moduleId, field, isChecked) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    const mod = item.modules.find(m => m.id === moduleId);
    if (mod) mod[field] = isChecked;
    renderWorkspaceContent(item);
  }
}

function moveModule(itemUniqueId, moduleId, direction) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const module = item.modules.find(m => m.id === moduleId);
  if (!module) return;
  
  const sectionModules = item.modules.filter(m => m.pos === module.pos);
  const currentIndex = sectionModules.findIndex(m => m.id === moduleId);
  
  if ((direction === 'up' && currentIndex === 0) || (direction === 'down' && currentIndex === sectionModules.length - 1)) return;
  
  const globalCurrentIndex = item.modules.findIndex(m => m.id === moduleId);
  const targetModuleId = direction === 'up' ? sectionModules[currentIndex - 1].id : sectionModules[currentIndex + 1].id;
  const globalTargetIndex = item.modules.findIndex(m => m.id === targetModuleId);
  
  [item.modules[globalCurrentIndex], item.modules[globalTargetIndex]] = [item.modules[globalTargetIndex], item.modules[globalCurrentIndex]];
  renderWorkspaceContent(item);
}

function removeModule(itemUniqueId, moduleId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    item.modules = item.modules.filter(m => m.id !== moduleId);
    renderWorkspaceContent(item);
  }
}

function addStorageModule(itemUniqueId, type) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const specUpperH = parseFloat(item.specs.upperH) || 720;
  const specLowerH = parseFloat(item.specs.lowerH) || 870;
  const specLegH = parseFloat(item.specs.sinkLegHeight) || 150;
  
  const defaultH = type === 'upper' ? specUpperH - 20 : specLowerH - specLegH;
  const defaultD = type === 'upper' ? 295 : 550;
  const name = type === 'upper' ? 'ìƒë¶€ì¥' : 'í•˜ë¶€ì¥';
  
  item.modules.push({ 
    id: Date.now(), type: 'storage', name, pos: type, 
    w: 600, h: defaultH, d: defaultD, 
    isDrawer: false, isEL: false, isFixed: false
  });
  renderWorkspaceContent(item);
}

function addTallModule(itemUniqueId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const specMoldingH = parseFloat(item.specs.moldingH) || 60;
  const spaceH = parseFloat(item.h) || 2300;
  const defaultH = spaceH - specMoldingH - 60;
  
  item.modules.push({ 
    id: Date.now(), type: 'tall', name: 'í‚¤í°ì¥(TL)', pos: 'lower', 
    w: 600, h: defaultH, d: 550, 
    isDrawer: false, isEL: false, isFixed: false,
    doorCount: 1, elCount: 0
  });
  renderWorkspaceContent(item);
}

function addAccessory(itemUniqueId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) { item.specs.accessories.push({ id: Date.now(), type: 'LTMesh' }); renderWorkspaceContent(item); }
}

function updateAccessory(itemUniqueId, accId, type) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    const acc = item.specs.accessories.find(a => a.id === accId);
    if (acc) acc.type = type;
  }
}

function removeAccessory(itemUniqueId, accId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) { item.specs.accessories = item.specs.accessories.filter(a => a.id !== accId); renderWorkspaceContent(item); }
}


// ============================================================
// â˜… ëƒ‰ì¥ê³ ì¥ ì „ìš© ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë Œë”ë§ (v30 ê·œì¹™ ê¸°ë°˜)
// ============================================================
function renderFridgeWorkspace(item) {
  const ws = document.getElementById('designWorkspace');
  const W = parseFloat(item.w) || 0;
  const H = parseFloat(item.h) || 0;
  const D = parseFloat(item.d) || 700;
  
  if (!item.modules) item.modules = [];
  
  // ê·œì¹™ ìƒìˆ˜
  const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
  const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
  const MODULE_D = parseFloat(item.specs.fridgeModuleD) || FRIDGE_RULES.MODULE_D;
  const TOP_GAP = FRIDGE_RULES.TOP_GAP;
  
  // ë§ˆê° ê³„ì‚°
  const fL = item.specs.finishLeftType !== 'none' ? (item.specs.finishLeftType === 'ep' ? 20 : parseFloat(item.specs.finishLeftWidth) || 60) : 0;
  const fR = item.specs.finishRightType !== 'none' ? (item.specs.finishRightType === 'ep' ? 20 : parseFloat(item.specs.finishRightWidth) || 60) : 0;
  const effectiveW = W - fL - fR;
  
  // ëª¨ë“ˆë“¤ì„ order ìˆœìœ¼ë¡œ ì •ë ¬
  const allModules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
  const fridgeMod = allModules.find(m => m.type === 'fridge');
  
  // â˜… ëƒ‰ì¥ê³  ê¸°ì¤€ ìƒë¶€ì¥ ë†’ì´ ìë™ ê³„ì‚° (ëƒ‰ì¥ê³ ëŠ” ë°”ë‹¥ì—ì„œ ì‹œì‘, ì¢ŒëŒ€ ë¬´ê´€)
  const fridgeH = fridgeMod ? fridgeMod.h : 0;
  const calcUpperH = fridgeMod ? Math.max(0, Math.min(FRIDGE_RULES.MAX_UPPER_H, H - fridgeH - TOP_GAP - MOLDING_H)) : 0;
  
  // ìƒë¶€ì¥ ë†’ì´ (ê³„ì‚°ê°’ ì‚¬ìš©, ìˆ˜ë™ ì…ë ¥ì€ recalcFridgeHeightsì—ì„œ ì²˜ë¦¬)
  const upperDoorH = item.specs.fridgeUpperH !== undefined ? parseFloat(item.specs.fridgeUpperH) : calcUpperH;
  
  // ì¤‘ê°„ì¥/í•˜ë¶€ì¥ ë†’ì´ ê³„ì‚° (ëª¨ë“ˆ ì˜ì—­ = H - ìƒëª°ë”© - ìƒë¶€ì¥ - ì¢ŒëŒ€)
  const moduleBodyH = H - MOLDING_H - upperDoorH - PEDESTAL_H;
  const middleH = item.specs.fridgeMiddleH !== undefined ? parseFloat(item.specs.fridgeMiddleH) : Math.round(moduleBodyH * 0.55);
  const lowerH = item.specs.fridgeLowerH !== undefined ? parseFloat(item.specs.fridgeLowerH) : Math.round(moduleBodyH - middleH);
  
  // ì‚¬ìš© ë„ˆë¹„ ê³„ì‚°
  let totalUsedW = 0;
  allModules.forEach(m => {
    if (m.type === 'fridge') {
      const sideGap = m.sideGap || 50;
      const betweenGap = m.betweenGap || 0;
      const units = m.units || [{w: m.w}];
      totalUsedW += sideGap * 2;
      units.forEach((u, idx) => { totalUsedW += u.w; if (idx < units.length - 1) totalUsedW += betweenGap; });
    } else {
      totalUsedW += parseFloat(m.w) || 0;
    }
  });
  const remaining = effectiveW - totalUsedW;
  const isOverflow = remaining < 0;
  
  // SVG ì„¤ì •
  const svgWidth = 720;
  const svgHeight = 560;
  const scale = Math.min((svgWidth - 100) / W, (svgHeight - 160) / H);
  const drawW = W * scale;
  const drawH = H * scale;
  const offsetX = (svgWidth - drawW) / 2;
  const offsetY = 50;
  
  let moduleSvg = '';
  
  // ìƒëª°ë”©
  moduleSvg += `<rect x="${offsetX}" y="${offsetY}" width="${drawW}" height="${MOLDING_H * scale}" fill="#d4a574" stroke="#a67c52" stroke-width="1"/>
    <text x="${offsetX + drawW / 2}" y="${offsetY + MOLDING_H * scale / 2 + 4}" text-anchor="middle" font-size="9" fill="#fff">ìƒëª°ë”© ${MOLDING_H}</text>`;
  
  // ì¢Œì¸¡ ë§ˆê°
  if (fL > 0) {
    moduleSvg += `<rect x="${offsetX}" y="${offsetY + MOLDING_H * scale}" width="${fL * scale}" height="${drawH - MOLDING_H * scale}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + fL * scale / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#666">${fL}</text>`;
  }
  // ìš°ì¸¡ ë§ˆê°
  if (fR > 0) {
    moduleSvg += `<rect x="${offsetX + drawW - fR * scale}" y="${offsetY + MOLDING_H * scale}" width="${fR * scale}" height="${drawH - MOLDING_H * scale}" fill="#e0e0e0" stroke="#999" stroke-width="1"/>
      <text x="${offsetX + drawW - fR * scale / 2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#666">${fR}</text>`;
  }
  
  // ìƒë¶€ì¥ ê²°í•©
  const contentStartY = offsetY + MOLDING_H * scale;
  const upperH_scaled = upperDoorH * scale;
  let upperX = offsetX + fL * scale;
  
  // ìƒë¶€ì¥ ì •ë³´ ìˆ˜ì§‘
  let upperCabinets = [];
  allModules.forEach(mod => {
    if (mod.type === 'fridge') {
      const sideGap = mod.sideGap || 50;
      const betweenGap = mod.betweenGap || 0;
      const units = mod.units || [{name: mod.name, w: mod.w}];
      units.forEach((unit, unitIdx) => {
        let upperW = unit.w;
        if (unitIdx === 0) upperW += sideGap;
        if (unitIdx < units.length - 1) upperW += betweenGap / 2;
        if (unitIdx === units.length - 1) upperW += sideGap;
        if (unitIdx > 0) upperW += betweenGap / 2;
        upperCabinets.push({ type: 'fridge', name: unit.name, w: upperW });
      });
    } else {
      upperCabinets.push({ type: mod.type, name: mod.type === 'tall' ? 'í‚¤í°ì¥' : 'í™ˆì¹´í˜', w: mod.w });
    }
  });
  
  // ìƒë¶€ì¥ ì—°ì† ê·¸ë¦¬ê¸°
  upperCabinets.forEach(cab => {
    const cabW = cab.w * scale;
    moduleSvg += `<rect x="${upperX}" y="${contentStartY}" width="${cabW}" height="${upperH_scaled}" fill="#dbeafe" stroke="#3b82f6" stroke-width="2" rx="2"/>
      <text x="${upperX + cabW/2}" y="${contentStartY + upperH_scaled/2 - 2}" text-anchor="middle" font-size="8" fill="#1d4ed8">ìƒë¶€ì¥</text>
      <text x="${upperX + cabW/2}" y="${contentStartY + upperH_scaled/2 + 10}" text-anchor="middle" font-size="7" fill="#666">${Math.round(cab.w)}mm</text>`;
    upperX += cabW;
  });
  
  // ë³¸ì²´ ì˜ì—­ ê·¸ë¦¬ê¸°
  let currentX = offsetX + fL * scale;
  const bodyStartY = contentStartY + upperH_scaled;
  const middleH_scaled = middleH * scale;
  const lowerH_scaled = lowerH * scale;
  const pedestalH_scaled = PEDESTAL_H * scale;
  
  allModules.forEach(mod => {
    if (mod.type === 'fridge') {
      const sideGap = mod.sideGap || 50;
      const betweenGap = mod.betweenGap || 0;
      const units = mod.units || [{name: mod.name, w: mod.w}];
      const fridgeDrawH = mod.h * scale;
      // â˜… ëƒ‰ì¥ê³ ëŠ” ë°”ë‹¥ì—ì„œ ì‹œì‘ (ì¢ŒëŒ€ ì˜ì—­ê¹Œì§€ ì°¨ì§€)
      const fridgeContentH = drawH - MOLDING_H * scale - upperH_scaled;
      const gapW = sideGap * scale;
      
      // ì¢Œì¸¡ ì¸¡ë©´ê³µê°„
      moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${gapW}" height="${fridgeContentH}" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3"/>
        <text x="${currentX + gapW/2}" y="${bodyStartY + 12}" text-anchor="middle" font-size="7" fill="#b45309">${sideGap}</text>`;
      currentX += gapW;
      
      // ê° ëƒ‰ì¥ê³  ìœ ë‹› (ë°”ë‹¥ê¹Œì§€)
      units.forEach((unit, unitIdx) => {
        const unitW = unit.w * scale;
        moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${unitW}" height="${fridgeDrawH}" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="2" rx="3"/>
          <text x="${currentX + unitW/2}" y="${bodyStartY + fridgeDrawH/2 - 6}" text-anchor="middle" font-size="10" fill="#0369a1" font-weight="bold">ğŸ§Š ${unit.name}</text>
          <text x="${currentX + unitW/2}" y="${bodyStartY + fridgeDrawH/2 + 10}" text-anchor="middle" font-size="8" fill="#666">${unit.w}Ã—${mod.h}</text>`;
        moduleSvg += `<text x="${currentX + unitW/2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#0ea5e9">${unit.w}</text>`;
        currentX += unitW;
        
        if (unitIdx < units.length - 1 && betweenGap > 0) {
          const bGapW = betweenGap * scale;
          moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${bGapW}" height="${fridgeContentH}" fill="#fed7aa" stroke="#ea580c" stroke-width="1" stroke-dasharray="2"/>
            <text x="${currentX + bGapW/2}" y="${bodyStartY + fridgeContentH/2}" text-anchor="middle" font-size="7" fill="#c2410c" transform="rotate(-90, ${currentX + bGapW/2}, ${bodyStartY + fridgeContentH/2})">${betweenGap}</text>`;
          currentX += bGapW;
        }
      });
      
      // ìš°ì¸¡ ì¸¡ë©´ê³µê°„
      moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${gapW}" height="${fridgeContentH}" fill="#fef3c7" stroke="#f59e0b" stroke-width="1" stroke-dasharray="3"/>
        <text x="${currentX + gapW/2}" y="${bodyStartY + 12}" text-anchor="middle" font-size="7" fill="#b45309">${sideGap}</text>`;
      currentX += gapW;
      
    } else {
      // í‚¤í°ì¥/í™ˆì¹´í˜ì¥
      const modW = mod.w * scale;
      const isEL = mod.isEL;
      
      if (mod.type === 'tall') {
        // í‚¤í°ì¥: ì¤‘ê°„ì¥ + í•˜ë¶€ì¥ + ì¢ŒëŒ€
        const midColor = isEL ? '#dcfce7' : '#dcfce7';
        const midLabel = isEL ? 'âš¡ ELì¥' : 'ğŸ—„ï¸ ì¤‘ê°„ì¥';
        moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${modW}" height="${middleH_scaled}" fill="${midColor}" stroke="#10b981" stroke-width="2" rx="2"/>
          <text x="${currentX + modW/2}" y="${bodyStartY + middleH_scaled/2 - 8}" text-anchor="middle" font-size="10" fill="#065f46" font-weight="bold">${midLabel}</text>
          <text x="${currentX + modW/2}" y="${bodyStartY + middleH_scaled/2 + 6}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${middleH}</text>
          <text x="${currentX + modW/2}" y="${bodyStartY + middleH_scaled - 8}" text-anchor="middle" font-size="7" fill="#888">${EL_DOOR_TYPES.find(t=>t.id===mod.doorType)?.name || 'ì—¬ë‹«ì´'}</text>`;
        
        // í•˜ë¶€ì¥
        const lowerColor = mod.lowerType === 'robot' ? '#fef3c7' : mod.lowerType === 'rice' ? '#fee2e2' : '#f3f4f6';
        const lowerStroke = mod.lowerType === 'robot' ? '#f59e0b' : mod.lowerType === 'rice' ? '#ef4444' : '#6b7280';
        const lowerIcon = LOWER_MODULE_TYPES.find(t=>t.id===mod.lowerType)?.icon || 'ğŸ—„ï¸';
        moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled}" width="${modW}" height="${lowerH_scaled}" fill="${lowerColor}" stroke="${lowerStroke}" stroke-width="2" rx="2"/>
          <text x="${currentX + modW/2}" y="${bodyStartY + middleH_scaled + lowerH_scaled/2}" text-anchor="middle" font-size="9" fill="${lowerStroke}">${lowerIcon} í•˜ë¶€ì¥</text>`;
        
        moduleSvg += `<rect x="${currentX}" y="${bodyStartY + middleH_scaled + lowerH_scaled}" width="${modW}" height="${pedestalH_scaled}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
        moduleSvg += `<text x="${currentX + modW/2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="#10b981">${mod.w}${mod.isFixed ? 'ğŸ”’' : ''}</text>`;
        
      } else if (mod.type === 'homecafe') {
        // í™ˆì¹´í˜ì¥: ì¤‘ë‹¨ + ì¢ŒëŒ€ (í•˜ë¶€ì¥ ì—†ìŒ)
        const cafeBodyH = middleH_scaled + lowerH_scaled;
        const midColor = mod.isEL ? '#dcfce7' : '#f3e8ff';
        const midStroke = mod.isEL ? '#10b981' : '#8b5cf6';
        const midLabel = mod.isEL ? 'âš¡ ELì¥' : 'â˜• í™ˆì¹´í˜';
        
        moduleSvg += `<rect x="${currentX}" y="${bodyStartY}" width="${modW}" height="${cafeBodyH}" fill="${midColor}" stroke="${midStroke}" stroke-width="2" rx="2"/>
          <text x="${currentX + modW/2}" y="${bodyStartY + cafeBodyH/2 - 4}" text-anchor="middle" font-size="10" fill="${mod.isEL ? '#065f46' : '#6b21a8'}" font-weight="bold">${midLabel}</text>
          <text x="${currentX + modW/2}" y="${bodyStartY + cafeBodyH/2 + 12}" text-anchor="middle" font-size="8" fill="#666">${mod.w}Ã—${middleH + lowerH}</text>`;
        
        moduleSvg += `<rect x="${currentX}" y="${bodyStartY + cafeBodyH}" width="${modW}" height="${pedestalH_scaled}" fill="#d1d5db" stroke="#9ca3af" stroke-width="1"/>`;
        moduleSvg += `<text x="${currentX + modW/2}" y="${offsetY + drawH + 15}" text-anchor="middle" font-size="9" fill="${mod.isEL ? '#10b981' : '#8b5cf6'}">${mod.w}${mod.isFixed ? 'ğŸ”’' : ''}</text>`;
      }
      currentX += modW;
    }
  });
  
  // ì´ ë„ˆë¹„
  moduleSvg += `<line x1="${offsetX}" y1="${offsetY + drawH + 35}" x2="${offsetX + drawW}" y2="${offsetY + drawH + 35}" stroke="#333" stroke-width="1" marker-start="url(#arrowL)" marker-end="url(#arrowR)"/>
    <text x="${offsetX + drawW/2}" y="${offsetY + drawH + 50}" text-anchor="middle" font-size="12" fill="#333" font-weight="bold">${W}mm</text>`;
  
  // ëƒ‰ì¥ê³  ëª¨ë¸ ëª©ë¡
  const brand = item.specs.fridgeBrand || 'LG';
  const brandData = FRIDGE_DATA[brand];
  
  let fridgeButtonsHtml = '';
  Object.keys(brandData.categories).forEach(catName => {
    fridgeButtonsHtml += `<div class="fridge-cat-group"><div class="fridge-cat-title">${catName}</div><div class="fridge-btn-row">`;
    brandData.categories[catName].forEach(model => {
      const isSelected = fridgeMod && fridgeMod.modelId === model.id;
      fridgeButtonsHtml += `<button class="fridge-model-btn ${isSelected ? 'selected' : ''}" onclick="selectFridgeModel(${item.uniqueId}, '${model.id}')">${model.name}<br><span style="font-size:9px;color:#999;">${model.w}Ã—${model.h}</span></button>`;
    });
    fridgeButtonsHtml += `</div></div>`;
  });
  
  // ëª¨ë“ˆ ì¹´ë“œ HTML
  const moduleCardsHtml = allModules.map((mod, idx) => {
    const isFirst = idx === 0;
    const isLast = idx === allModules.length - 1;
    
    if (mod.type === 'fridge') {
      const sideGap = mod.sideGap || 50;
      const betweenGap = mod.betweenGap || 0;
      const units = mod.units || [{w: mod.w}];
      let upperInfo = units.map((u, i) => {
        let uw = u.w;
        if (i === 0) uw += sideGap;
        if (i < units.length - 1) uw += betweenGap / 2;
        if (i === units.length - 1) uw += sideGap;
        if (i > 0) uw += betweenGap / 2;
        return Math.round(uw);
      }).join('+');
      
      return `<div class="module-card" style="border-left:3px solid #0ea5e9;">
        <div class="module-order-btns">
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, -1)" ${isFirst ? 'disabled' : ''}>â–²</button>
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, 1)" ${isLast ? 'disabled' : ''}>â–¼</button>
        </div>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:12px;">ğŸ§Š ${mod.name}</div>
          <div style="font-size:10px;color:#666;">${mod.w} Ã— ${mod.h}mm | ìœ ë‹›: ${units.length}ê°œ</div>
          <div style="font-size:9px;color:#888;">ì¸¡ë©´: ${sideGap}mm | ì‚¬ì´: ${betweenGap}mm</div>
          <div style="font-size:9px;color:#3b82f6;">ìƒë¶€ì¥: ${upperInfo}mm</div>
        </div>
        <button class="btn-delete" onclick="removeFridgeModule(${item.uniqueId}, ${mod.id})">Ã—</button>
      </div>`;
    } else {
      const typeInfo = mod.type === 'tall' ? { name: 'í‚¤í°ì¥', icon: 'ğŸ—„ï¸', color: '#10b981' } : { name: 'í™ˆì¹´í˜ì¥', icon: 'â˜•', color: '#8b5cf6' };
      const fixedClass = mod.isFixed ? 'active' : '';
      const elClass = mod.isEL ? 'active' : '';
      
      return `<div class="module-card" style="border-left:3px solid ${typeInfo.color};">
        <div class="module-order-btns">
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, -1)" ${isFirst ? 'disabled' : ''}>â–²</button>
          <button class="order-btn" onclick="moveFridgeModule(${item.uniqueId}, ${mod.id}, 1)" ${isLast ? 'disabled' : ''}>â–¼</button>
        </div>
        <div style="flex:1;">
          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-weight:700;font-size:12px;">${typeInfo.icon} ${typeInfo.name}</span>
            <button class="toggle-btn ${fixedClass}" onclick="toggleFridgeModuleFixed(${item.uniqueId}, ${mod.id})">ê³ ì •</button>
            <button class="toggle-btn el ${elClass}" onclick="toggleFridgeModuleEL(${item.uniqueId}, ${mod.id})">ELì¥</button>
          </div>
          <div class="module-inline-inputs">
            <label>W</label><input type="number" value="${mod.w}" style="width:55px;" onchange="updateFridgeModuleW(${item.uniqueId}, ${mod.id}, this.value)">
            <label>ë„ì–´</label><select onchange="updateFridgeSideModule(${item.uniqueId}, ${mod.id}, 'doorType', this.value)">${EL_DOOR_TYPES.map(t => `<option value="${t.id}" ${mod.doorType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}</select>
            ${mod.type === 'tall' ? `<label>í•˜ë¶€</label><select onchange="updateFridgeSideModule(${item.uniqueId}, ${mod.id}, 'lowerType', this.value)">${LOWER_MODULE_TYPES.map(t => `<option value="${t.id}" ${mod.lowerType === t.id ? 'selected' : ''}>${t.icon}</option>`).join('')}</select>` : ''}
          </div>
        </div>
        <button class="btn-delete" onclick="removeFridgeModule(${item.uniqueId}, ${mod.id})">Ã—</button>
      </div>`;
    }
  }).join('');
  
  const leftDisabled = item.specs.finishLeftType === 'ep' ? 'disabled' : '';
  const rightDisabled = item.specs.finishRightType === 'ep' ? 'disabled' : '';
  const leftWidthVal = item.specs.finishLeftType === 'ep' ? 20 : (item.specs.finishLeftWidth || 60);
  const rightWidthVal = item.specs.finishRightType === 'ep' ? 20 : (item.specs.finishRightWidth || 60);
  
  ws.innerHTML = `
    <style>
      .fridge-brand-tabs{display:flex;gap:8px;margin-bottom:12px}.fridge-brand-tab{padding:8px 20px;border:2px solid #ddd;border-radius:8px;background:#f9f9f9;cursor:pointer;font-weight:600;font-size:13px}.fridge-brand-tab.active{border-color:#0ea5e9;background:#e0f2fe;color:#0369a1}.fridge-cat-group{margin-bottom:10px}.fridge-cat-title{font-size:11px;font-weight:700;color:#666;margin-bottom:5px}.fridge-btn-row{display:flex;flex-wrap:wrap;gap:5px}.fridge-model-btn{padding:5px 8px;border:1px solid #ddd;border-radius:5px;background:white;font-size:10px;cursor:pointer;min-width:80px}.fridge-model-btn:hover{border-color:#0ea5e9;background:#f0f9ff}.fridge-model-btn.selected{border-color:#0ea5e9;background:#0ea5e9;color:white}.fridge-model-btn.selected span{color:#e0f2fe!important}.module-add-btns{display:flex;gap:8px;margin-bottom:12px}.module-add-btn{flex:1;padding:10px;border:2px dashed #ccc;border-radius:8px;background:white;font-size:12px;cursor:pointer;font-weight:600}.module-add-btn:hover{border-style:solid}.module-add-btn.tall{color:#10b981;border-color:#10b981}.module-add-btn.tall:hover{background:#dcfce7}.module-add-btn.homecafe{color:#8b5cf6;border-color:#8b5cf6}.module-add-btn.homecafe:hover{background:#f3e8ff}.auto-calc-btn{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;width:100%;margin-bottom:15px}.auto-calc-btn:hover{opacity:0.9}.auto-calc-btn:disabled{background:#ccc;cursor:not-allowed}.overflow-warning{background:#fee2e2;color:#b91c1c;padding:8px 12px;border-radius:6px;font-size:11px;margin-bottom:10px}.module-inline-inputs{display:flex;align-items:center;gap:4px;font-size:10px;margin-top:4px}.module-inline-inputs input,.module-inline-inputs select{padding:2px 4px;font-size:10px;border:1px solid #ddd;border-radius:4px}.module-order-btns{display:flex;flex-direction:column;gap:2px;margin-right:8px}.order-btn{width:24px;height:20px;border:1px solid #ddd;border-radius:4px;background:#f9f9f9;cursor:pointer;font-size:10px;padding:0}.order-btn:hover:not(:disabled){background:#e0e0e0}.order-btn:disabled{opacity:0.3;cursor:not-allowed}.module-card{display:flex;align-items:center;padding:10px;background:#f9fafb;border-radius:8px;margin-bottom:8px}.height-inputs{display:flex;gap:8px;margin-top:8px;padding:8px;background:#f0f9ff;border-radius:6px;font-size:10px}.height-inputs label{color:#0369a1;font-weight:600}.height-inputs input{width:50px;padding:2px 4px;border:1px solid #0ea5e9;border-radius:4px;font-size:10px}.toggle-btn{padding:2px 6px;border:1px solid #ccc;border-radius:4px;background:#f9f9f9;font-size:9px;cursor:pointer}.toggle-btn:hover{background:#e5e5e5}.toggle-btn.active{background:#ef4444;color:white;border-color:#ef4444}.toggle-btn.el{border-color:#10b981;color:#10b981}.toggle-btn.el.active{background:#10b981;color:white}
    </style>
    <div class="ws-header">
      <div class="ws-title">ğŸ§Š ${item.labelName || item.name} <span class="ws-info-badge">${W} Ã— ${H} Ã— ${D}</span></div>
      <button class="btn-back" onclick="goBackToStep1()">â† ëª©ë¡</button>
    </div>
    <div class="ws-layout">
      <div class="spec-panel">
        <div class="spec-group-title">ë¸Œëœë“œ ì„ íƒ</div>
        <div class="fridge-brand-tabs">
          <div class="fridge-brand-tab ${brand === 'LG' ? 'active' : ''}" onclick="changeFridgeBrand(${item.uniqueId}, 'LG')">LG</div>
          <div class="fridge-brand-tab ${brand === 'Samsung' ? 'active' : ''}" onclick="changeFridgeBrand(${item.uniqueId}, 'Samsung')">ì‚¼ì„±</div>
        </div>
        <div class="spec-group-title">ëƒ‰ì¥ê³  ëª¨ë¸ ì„ íƒ</div>
        <div style="max-height:180px;overflow-y:auto;padding-right:6px;margin-bottom:12px;">${fridgeButtonsHtml}</div>
        <button class="auto-calc-btn" onclick="autoCalculateFridge(${item.uniqueId})" ${allModules.length === 0 ? 'disabled' : ''}>âš¡ ìë™ ê³„ì‚° (ê· ë“± ë¶„ë°°)</button>
        <div class="spec-group-title">ì„¤ì •</div>
        <div class="spec-row">
          <div class="spec-field"><label>ìƒëª°ë”©</label><input type="number" value="${MOLDING_H}" onchange="updateFridgeSpecWithRecalc(${item.uniqueId}, 'fridgeMoldingH', this.value)"></div>
          <div class="spec-field"><label>ì¢ŒëŒ€</label><input type="number" value="${PEDESTAL_H}" onchange="updateFridgeSpecWithRecalc(${item.uniqueId}, 'fridgePedestal', this.value)"></div>
          <div class="spec-field"><label>ê¹Šì´</label><input type="number" value="${MODULE_D}" onchange="updateFridgeSpec(${item.uniqueId}, 'fridgeModuleD', this.value)"></div>
        </div>
        <div class="spec-group-title">ë§ˆê° ì„¤ì •</div>
        <div class="spec-row">
          <div class="spec-field"><label>ì¢Œì¸¡</label><select onchange="updateFridgeFinish(${item.uniqueId}, 'Left', this.value)">${FINISH_TYPES.map(t => `<option value="${t.id}" ${item.specs.finishLeftType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}<option value="none" ${item.specs.finishLeftType === 'none' ? 'selected' : ''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´</label><input type="number" value="${leftWidthVal}" onchange="updateFridgeSpec(${item.uniqueId}, 'finishLeftWidth', this.value)" ${leftDisabled}></div>
        </div>
        <div class="spec-row">
          <div class="spec-field"><label>ìš°ì¸¡</label><select onchange="updateFridgeFinish(${item.uniqueId}, 'Right', this.value)">${FINISH_TYPES.map(t => `<option value="${t.id}" ${item.specs.finishRightType === t.id ? 'selected' : ''}>${t.name}</option>`).join('')}<option value="none" ${item.specs.finishRightType === 'none' ? 'selected' : ''}>ì—†ìŒ</option></select></div>
          <div class="spec-field"><label>ê¸¸ì´</label><input type="number" value="${rightWidthVal}" onchange="updateFridgeSpec(${item.uniqueId}, 'finishRightWidth', this.value)" ${rightDisabled}></div>
        </div>
        <div style="font-size:9px;color:#888;margin-top:4px;">â€» EP: 20mm ê³ ì •</div>
      </div>
      <div class="module-panel">
        <div style="text-align:center;margin-bottom:12px;">
          <svg width="${svgWidth}" height="${svgHeight + 20}" style="background:#fafafa;border-radius:8px;border:1px solid #eee;">
            <defs><marker id="arrowL" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto"><path d="M6,0 L0,3 L6,6" fill="none" stroke="#333"/></marker><marker id="arrowR" markerWidth="6" markerHeight="6" refX="6" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6" fill="none" stroke="#333"/></marker></defs>
            <text x="${svgWidth/2}" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">Front View (ë„ì–´ ê¸°ì¤€)</text>
            ${moduleSvg}
          </svg>
        </div>
        ${isOverflow ? `<div class="overflow-warning">âš ï¸ ìœ íš¨ê³µê°„(${effectiveW}mm)ì„ ${Math.abs(remaining)}mm ì´ˆê³¼!</div>` : ''}
        <div class="module-section">
          <div class="module-section-header" style="background:linear-gradient(135deg,#e0f2fe,#f0f9ff);color:#0369a1;border-left:4px solid #0ea5e9;">
            <div class="section-title-row"><span>ğŸ“¦ ëª¨ë“ˆ êµ¬ì„±</span><span style="font-size:11px;font-weight:normal;color:#666;">ìœ íš¨: ${effectiveW}mm</span></div>
            <div class="section-remaining" style="color:${isOverflow?'#ef4444':'#10b981'}">ì”ì—¬: ${remaining}mm</div>
          </div>
          <div class="height-inputs">
            <label>ìƒë¶€ì¥H</label><input type="number" value="${Math.round(upperDoorH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeUpperH', this.value)">
            <label>ì¤‘ê°„ì¥H</label><input type="number" value="${Math.round(middleH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeMiddleH', this.value)">
            <label>í•˜ë¶€ì¥H</label><input type="number" value="${Math.round(lowerH)}" onchange="updateFridgeHeightWithRecalc(${item.uniqueId}, 'fridgeLowerH', this.value)">
          </div>
          <div class="module-add-btns" style="margin-top:10px;">
            <button class="module-add-btn tall" onclick="addFridgeSideModule(${item.uniqueId}, 'tall')">ğŸ—„ï¸ + í‚¤í°ì¥</button>
            <button class="module-add-btn homecafe" onclick="addFridgeSideModule(${item.uniqueId}, 'homecafe')">â˜• + í™ˆì¹´í˜ì¥</button>
          </div>
          ${moduleCardsHtml || '<div style="padding:15px;text-align:center;color:#999;font-size:11px;">ëƒ‰ì¥ê³ ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ëª¨ë“ˆì„ ì¶”ê°€í•˜ì„¸ìš”</div>'}
        </div>
      </div>
    </div>
  `;
}

function changeFridgeBrand(itemUniqueId, brand) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    item.specs.fridgeBrand = brand;
    item.modules = item.modules.filter(m => m.type !== 'fridge');
    renderWorkspaceContent(item);
  }
}

function selectFridgeModel(itemUniqueId, modelId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const brand = item.specs.fridgeBrand || 'LG';
  let model = null;
  Object.values(FRIDGE_DATA[brand].categories).forEach(cat => {
    const found = cat.find(m => m.id === modelId);
    if (found) model = found;
  });
  if (!model) return;
  
  item.modules = item.modules.filter(m => m.type !== 'fridge');
  const existingModules = item.modules;
  const midOrder = existingModules.length > 0 ? Math.floor(existingModules.length / 2) + 1 : 1;
  existingModules.forEach((m, idx) => { m.order = idx < Math.floor(existingModules.length / 2) ? idx + 1 : idx + 2; });
  
  item.modules.push({
    id: Date.now(), modelId: model.id, type: 'fridge', name: model.name,
    w: model.w, h: model.h, d: model.d, line: model.line,
    sideGap: model.sideGap, betweenGap: model.betweenGap, units: model.units, order: midOrder
  });
  
  // ë†’ì´ ìë™ ì¬ê³„ì‚°
  recalcFridgeHeights(item);
  renderWorkspaceContent(item);
}

// â˜… ë†’ì´ ìë™ ì¬ê³„ì‚° í•¨ìˆ˜
function recalcFridgeHeights(item) {
  const H = parseFloat(item.h) || 0;
  const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
  const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
  const fridgeMod = item.modules.find(m => m.type === 'fridge');
  
  if (fridgeMod) {
    // ìƒë¶€ì¥ ë†’ì´ = ì „ì²´ - ëƒ‰ì¥ê³ ë†’ì´ - ìƒë‹¨ê°„ê²© - ìƒëª°ë”©
    const calcUpperH = Math.max(0, Math.min(FRIDGE_RULES.MAX_UPPER_H, H - fridgeMod.h - FRIDGE_RULES.TOP_GAP - MOLDING_H));
    item.specs.fridgeUpperH = calcUpperH;
    
    // ëª¨ë“ˆ ë³¸ì²´ ì˜ì—­ = ì „ì²´ - ìƒëª°ë”© - ìƒë¶€ì¥ - ì¢ŒëŒ€
    const moduleBodyH = H - MOLDING_H - calcUpperH - PEDESTAL_H;
    item.specs.fridgeMiddleH = Math.round(moduleBodyH * 0.55);
    item.specs.fridgeLowerH = Math.round(moduleBodyH - item.specs.fridgeMiddleH);
  }
}

function removeFridgeModule(itemUniqueId, modId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    item.modules = item.modules.filter(m => m.id !== modId);
    item.modules.sort((a,b) => (a.order||0) - (b.order||0)).forEach((m, idx) => m.order = idx + 1);
    renderWorkspaceContent(item);
  }
}

function addFridgeSideModule(itemUniqueId, type) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const H = parseFloat(item.h) || 2290;
  const MODULE_D = parseFloat(item.specs.fridgeModuleD) || FRIDGE_RULES.MODULE_D;
  const defaultW = type === 'tall' ? FRIDGE_RULES.EL_W : FRIDGE_RULES.HOMECAFE_W;
  const maxOrder = item.modules.length > 0 ? Math.max(...item.modules.map(m => m.order || 0)) : 0;
  item.modules.push({
    id: Date.now(), type: type, name: type === 'tall' ? 'í‚¤í°ì¥' : 'í™ˆì¹´í˜ì¥',
    order: maxOrder + 1, w: defaultW, h: H, d: MODULE_D, doorType: 'swing', lowerType: 'drawer', isFixed: false, isEL: false
  });
  renderWorkspaceContent(item);
}

function moveFridgeModule(itemUniqueId, modId, direction) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const modules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
  const idx = modules.findIndex(m => m.id === modId);
  if (idx === -1) return;
  if (direction === -1 && idx === 0) return;
  if (direction === 1 && idx === modules.length - 1) return;
  const swapIdx = idx + direction;
  const tempOrder = modules[idx].order;
  modules[idx].order = modules[swapIdx].order;
  modules[swapIdx].order = tempOrder;
  renderWorkspaceContent(item);
}

function updateFridgeModuleW(itemUniqueId, modId, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.w = parseFloat(value) || 0;
    mod.isFixed = true;
    renderWorkspaceContent(item);
  }
}

function toggleFridgeModuleFixed(itemUniqueId, modId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.isFixed = !mod.isFixed;
    renderWorkspaceContent(item);
  }
}

function toggleFridgeModuleEL(itemUniqueId, modId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) {
    mod.isEL = !mod.isEL;
    renderWorkspaceContent(item);
  }
}

function updateFridgeSideModule(itemUniqueId, modId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  const mod = item.modules.find(m => m.id === modId);
  if (mod) { mod[field] = value; renderWorkspaceContent(item); }
}

function updateFridgeSpec(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) { item.specs[field] = parseFloat(value) || value; renderWorkspaceContent(item); }
}

// ìƒëª°ë”©, ì¢ŒëŒ€ ë³€ê²½ ì‹œ ë†’ì´ ì¬ê³„ì‚°
function updateFridgeSpecWithRecalc(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (item) {
    item.specs[field] = parseFloat(value) || value;
    recalcFridgeHeights(item);
    renderWorkspaceContent(item);
  }
}

// ë†’ì´ ê°’ ë³€ê²½ ì‹œ ì—°ë™ ê³„ì‚°
function updateFridgeHeightWithRecalc(itemUniqueId, field, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  
  const H = parseFloat(item.h) || 0;
  const MOLDING_H = parseFloat(item.specs.fridgeMoldingH) || FRIDGE_RULES.MOLDING_H;
  const PEDESTAL_H = parseFloat(item.specs.fridgePedestal) || FRIDGE_RULES.PEDESTAL_H;
  const newVal = parseFloat(value) || 0;
  
  if (field === 'fridgeUpperH') {
    item.specs.fridgeUpperH = newVal;
    const moduleBodyH = H - MOLDING_H - newVal - PEDESTAL_H;
    item.specs.fridgeMiddleH = Math.round(moduleBodyH * 0.55);
    item.specs.fridgeLowerH = Math.round(moduleBodyH - item.specs.fridgeMiddleH);
  } else if (field === 'fridgeMiddleH') {
    item.specs.fridgeMiddleH = newVal;
    const upperH = parseFloat(item.specs.fridgeUpperH) || 0;
    const moduleBodyH = H - MOLDING_H - upperH - PEDESTAL_H;
    item.specs.fridgeLowerH = Math.round(moduleBodyH - newVal);
  } else if (field === 'fridgeLowerH') {
    item.specs.fridgeLowerH = newVal;
    const upperH = parseFloat(item.specs.fridgeUpperH) || 0;
    const moduleBodyH = H - MOLDING_H - upperH - PEDESTAL_H;
    item.specs.fridgeMiddleH = Math.round(moduleBodyH - newVal);
  }
  
  renderWorkspaceContent(item);
}

function updateFridgeFinish(itemUniqueId, side, value) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item) return;
  item.specs[`finish${side}Type`] = value;
  if (value === 'ep') item.specs[`finish${side}Width`] = 20;
  else if (value !== 'none') item.specs[`finish${side}Width`] = item.specs[`finish${side}Width`] || 60;
  renderWorkspaceContent(item);
}

function autoCalculateFridge(itemUniqueId) {
  const item = selectedItems.find(i => i.uniqueId === itemUniqueId);
  if (!item || item.modules.length === 0) { alert('ëª¨ë“ˆì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.'); return; }
  
  const W = parseFloat(item.w) || 0;
  const fL = item.specs.finishLeftType !== 'none' ? (item.specs.finishLeftType === 'ep' ? 20 : parseFloat(item.specs.finishLeftWidth) || 60) : 0;
  const fR = item.specs.finishRightType !== 'none' ? (item.specs.finishRightType === 'ep' ? 20 : parseFloat(item.specs.finishRightWidth) || 60) : 0;
  const effectiveW = W - fL - fR;
  
  const modules = item.modules.sort((a, b) => (a.order || 0) - (b.order || 0));
  let fixedW = 0, adjustableCount = 0;
  
  modules.forEach(mod => {
    if (mod.type === 'fridge') {
      const sideGap = mod.sideGap || 50;
      const betweenGap = mod.betweenGap || 0;
      const units = mod.units || [{w: mod.w}];
      fixedW += sideGap * 2;
      units.forEach((u, idx) => { fixedW += u.w; if (idx < units.length - 1) fixedW += betweenGap; });
    } else if (mod.isFixed) {
      fixedW += parseFloat(mod.w) || 0;
    } else {
      adjustableCount++;
    }
  });
  
  if (adjustableCount === 0) { alert('ì¡°ì ˆ ê°€ëŠ¥í•œ ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const remainingW = effectiveW - fixedW;
  if (remainingW <= 0) { alert('ìœ íš¨ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; }
  const perModuleW = Math.floor(remainingW / adjustableCount);
  if (perModuleW < 300) { alert(`ê° ëª¨ë“ˆì— ${perModuleW}mmë§Œ í• ë‹¹ ê°€ëŠ¥í•©ë‹ˆë‹¤.`); return; }
  
  modules.forEach(mod => { if (mod.type !== 'fridge' && !mod.isFixed) mod.w = perModuleW; });
  renderWorkspaceContent(item);
}

// ì´ˆê¸°í™”
initCategoryGrid();
</script>
</body>
</html>
